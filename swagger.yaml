openapi: 3.0.3
info:
  title: SmartTransit SMS Authentication API
  description: |
    SMS-based authentication backend for SmartTransit mobile applications.

    ## Features
    - SMS OTP authentication for passengers
    - Staff registration and verification
    - JWT token-based authorization
    - Profile management
    - Rate limiting and security
    - Automated trip generation from timetables/schedules

    ## Authentication Flow
    1. Request OTP via `/auth/send-otp`
    2. Verify OTP via `/auth/verify-otp` or `/auth/verify-otp-staff`
    3. Receive JWT access & refresh tokens
    4. Use access token for protected endpoints
    5. Refresh token when access token expires

    ## Staff Employment Model
    Staff members (drivers/conductors) have a separated profile and employment structure:
    - **Staff Profile (`bus_staff`)**: Personal information, license details, verification status
    - **Employment Records (`bus_staff_employment`)**: Employment history with bus owners

    **Employment Lifecycle:**
    1. Staff registers profile (no bus owner link initially)
    2. Bus owner verifies staff via phone number
    3. Bus owner links staff (creates employment record)
    4. Employment can be terminated (record preserved for history)
    5. Staff can be linked to new bus owner (new employment record)

    **Benefits:**
    - Complete employment history tracking
    - Staff can move between companies
    - Performance metrics per employment period
    - Proper audit trail

    ## Trip Generation System
    - **On-Demand Generation**: When a schedule/timetable is created, trips are generated for the specified date range
    - **Date Range**: Configurable via `system_settings.trip_generation_days_ahead` (default: 7 days)
    - **Validation**: Trips are only created if:
      - Schedule is active (`is_active=true`)
      - Date falls within `valid_from` and `valid_until` range
      - Date matches recurrence rules (daily/weekly/interval)
      - Departure time is in valid format (HH:MM or HH:MM:SS)
    - **Logging**: Comprehensive logs track schedule processing, date validation, and trip creation
    - **Datetime Format**: All `departure_datetime` values combine the trip date with the schedule's departure time in UTC
    - **Error Handling**: Invalid departure times or zero datetime values are logged and skipped

    ## Bus Management
    - **Seat Layout**: Buses reference a seat layout template via `seat_layout_id`
    - **Total Seats**: The `total_seats` count is obtained from the `bus_seat_layout_templates` table, not stored in the buses table
    - **Data Integrity**: This prevents data duplication and ensures seat count always matches the actual layout configuration

    ## Booking & Seat Availability
    - **Dynamic Calculation**: Available seats and booked seats are NOT stored in `scheduled_trips` table
    - **Real-time Data**: These values are calculated dynamically from the `bookings` table when needed
    - **Formula**: `available_seats = total_seats - COUNT(confirmed bookings)`
    - **Benefits**: Always accurate, no stale data, single source of truth

    ## System Settings
    - **Dynamic Configuration**: Key system parameters are stored in `system_settings` table
    - **booking_advance_hours_default**: Default hours before trip departure that booking opens (default: 72)
    - **assignment_deadline_hours**: Hours before departure to assign bus/staff (default: 2)
    - **trip_generation_days_ahead**: Number of days ahead to generate trips (default: 7)
    - **Admin Configurable**: Settings can be updated via API without code changes

  version: 1.0.0
  contact:
    name: SmartTransit Development Team
    email: dev@smarttransit.lk
  license:
    name: Proprietary

servers:
  - url: https://your-choreo-id.choreo.dev
    description: Production server (Choreo)
  - url: http://localhost:8080
    description: Development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: SMS OTP authentication endpoints
  - name: Admin Authentication
    description: Admin dashboard authentication endpoints (email/password based)
  - name: User
    description: User profile management
  - name: Staff
    description: Staff registration and management
  - name: Bus Owner
    description: Bus owner profile and onboarding management
  - name: Lounge Owner
    description: Lounge owner registration and management
  - name: Permits
    description: Route permit management
  - name: Buses
    description: Bus registration and management
  - name: Trip Schedules
    description: Trip schedule template management
  - name: Scheduled Trips
    description: Generated trip instances and bookings
  - name: Trip Seats
    description: Trip seat management (create from layout, block/unblock, pricing)
  - name: Manual Bookings
    description: Phone, agent, and walk-in booking management for bus owners
  - name: App Bookings
    description: Passenger app booking endpoints (create, manage, and view bookings)
  - name: Staff Bookings
    description: Conductor/Driver booking operations (verify, check-in, board)
  - name: Booking Orchestration
    description: |
      Intent-based booking flow with TTL seat/lounge holding.
      Flow: Create Intent → Initiate Payment → Confirm Booking
  - name: Search
    description: Trip search and discovery endpoints (Phase 1 MVP)
  - name: Lounge Marketplace
    description: Lounge discovery and marketplace for passengers
  - name: Lounge Bookings
    description: Lounge booking management for passengers
  - name: Lounge Products
    description: Lounge product (food/beverages) management
  - name: Lounge Orders
    description: Lounge order management for food/beverages

paths:
  # ============================================================================
  # Health Check Endpoints
  # ============================================================================
  /health:
    get:
      summary: Health check endpoint
      description: Returns service health status and database connectivity
      operationId: getHealth
      tags:
        - Health
      security: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  database:
                    type: string
                    example: healthy
                  version:
                    type: string
                    example: "1.0.0"
                  timestamp:
                    type: integer
                    format: int64
                    example: 1729340000
        "503":
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: unhealthy
                  database:
                    type: string
                    example: unhealthy
                  error:
                    type: string
                    example: database connection failed

  # ============================================================================
  # Debug Endpoints
  # ============================================================================
  /api/v1/debug/headers:
    get:
      summary: Debug request headers and IP detection
      description: |
        Shows all incoming request headers and IP detection results.

        **Use Case:** Troubleshooting IP forwarding issues with reverse proxies.

        **Returns:**
        - All HTTP headers received
        - IP detection from various headers (X-Real-IP, X-Forwarded-For)
        - User-Agent information
      operationId: debugHeaders
      tags:
        - Health
      security: []
      responses:
        "200":
          description: Debug information
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Debug information for IP detection
                  headers:
                    type: object
                    additionalProperties:
                      type: string
                    example:
                      X-Forwarded-For: "203.94.123.45, 10.100.1.1"
                      User-Agent: "SmartTransit-Staff/1.0.0+1 (Android 13; Samsung SM-G998B)"
                  ip_detection:
                    type: object
                    properties:
                      gin_clientip:
                        type: string
                        example: "203.94.123.45"
                      remote_addr:
                        type: string
                        example: "10.100.1.1:54321"
                      x_real_ip:
                        type: string
                        example: ""
                      x_forwarded_for:
                        type: string
                        example: "203.94.123.45, 10.100.1.1"
                      x_forwarded_host:
                        type: string
                        example: "api.smarttransit.lk"
                      x_forwarded_proto:
                        type: string
                        example: "https"
                  user_agent:
                    type: string
                    example: "SmartTransit-Staff/1.0.0+1 (Android 13; Samsung SM-G998B)"
                  timestamp:
                    type: integer
                    format: int64
                    example: 1729340000

  # ============================================================================
  # Authentication Endpoints
  # ============================================================================
  /api/v1/auth/send-otp:
    post:
      summary: Send OTP to phone number
      description: |
        Sends a 6-digit OTP via SMS to the provided phone number.

        **Rate Limiting:** Maximum 3 requests per 10 minutes per phone number.

        **Development Mode:** If SMS_MODE=dev, OTP is returned in response.

        **Production Mode:** OTP is sent via Dialog SMS Gateway.
      operationId: sendOtp
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  description: Sri Lankan phone number in E.164 format
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
      responses:
        "200":
          description: OTP sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: OTP sent successfully
                  otp:
                    type: string
                    description: Only present in development mode
                    example: "123456"
                  expires_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T08:05:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/verify-otp:
    post:
      summary: Verify OTP and login (Passenger)
      description: |
        Verifies the OTP for passenger users and returns JWT tokens.

        **Maximum Attempts:** 3 invalid attempts allowed.

        **OTP Expiry:** 5 minutes from generation.

        **Auto-Registration:** If phone number doesn't exist:
        1. Creates new user in `users` table with role=['passenger']
        2. Creates new passenger record in `passengers` table with `profile_completed=false`

        **Multi-Role Architecture:**
        - User authentication data is stored in `users` table
        - Passenger profile data is stored in `passengers` table
        - This allows the same phone to have multiple roles (e.g., passenger + driver)

        **Response includes `profile_completed`:**
        - `false`: User needs to call `/api/v1/user/complete-basic-profile` with first_name and last_name
        - `true`: User can proceed to full app functionality
      operationId: verifyOtp
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - otp
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                otp:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
      responses:
        "200":
          description: OTP verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/verify-otp-staff:
    post:
      summary: Verify OTP and login (Staff)
      description: |
        Verifies the OTP for staff users (drivers/conductors) and returns JWT tokens.

        **Staff Only:** User must be registered as staff (driver or conductor).

        **Employment Status Check:** Staff must have employment_status = 'active'.

        **Profile Completion:** Staff must have completed their profile.
      operationId: verifyOtpStaff
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - otp
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                otp:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
      responses:
        "200":
          description: OTP verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StaffAuthResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "403":
          description: Staff not authorized (inactive or incomplete profile)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Staff member is not active or profile incomplete
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/verify-otp-lounge-owner:
    post:
      summary: Verify OTP and login (Lounge Owner)
      description: |
        Verifies the OTP for lounge owner users and returns JWT tokens.

        **Lounge Owner Specific:** Creates user with 'lounge_owner' role if new, or adds role if existing user.

        **Multi-role Support:** Existing users (passengers) can become lounge owners.
      operationId: verifyOtpLoungeOwner
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone_number
                - otp
              properties:
                phone_number:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                  description: Phone number in E.164 format
                otp:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
                  description: 6-digit OTP code
      responses:
        "200":
          description: OTP verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "OTP verified successfully"
                  access_token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  refresh_token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  expires_in_seconds:
                    type: integer
                    example: 3600
                    description: Access token expiry in seconds
                  is_new_user:
                    type: boolean
                    example: true
                    description: Whether this is a newly created user
                  profile_complete:
                    type: boolean
                    example: false
                    description: Whether user has completed their profile
                  roles:
                    type: array
                    items:
                      type: string
                    example: ["lounge_owner"]
                    description: User's roles including lounge_owner
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "404":
          description: No OTP found for phone number
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "no_otp_found"
                  message:
                    type: string
                    example: "No OTP found for this phone number. Please request an OTP first."
                  code:
                    type: string
                    example: "NO_OTP"
        "429":
          description: Too many OTP validation attempts
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "max_attempts_exceeded"
                  message:
                    type: string
                    example: "Maximum OTP validation attempts exceeded. Please request a new OTP."
                  code:
                    type: string
                    example: "MAX_ATTEMPTS"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/otp-status/{phone}:
    get:
      summary: Get OTP status for phone number
      description: Check if OTP exists and is valid for a phone number
      operationId: getOtpStatus
      tags:
        - Authentication
      security: []
      parameters:
        - name: phone
          in: path
          required: true
          description: Phone number in E.164 format
          schema:
            type: string
            pattern: '^\+94[0-9]{9}$'
            example: "+94771234567"
      responses:
        "200":
          description: OTP status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  exists:
                    type: boolean
                    example: true
                  valid:
                    type: boolean
                    example: true
                  expires_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T08:05:00Z"
                  attempts_remaining:
                    type: integer
                    example: 2
        "404":
          description: No OTP found for phone number
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: No OTP found

  /api/v1/auth/refresh-token:
    post:
      summary: Refresh access token
      description: |
        Use refresh token to obtain a new access token.

        **Token Rotation:** Old refresh token is invalidated, new one is issued.
      operationId: refreshToken
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refresh_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  expires_in:
                    type: integer
                    description: Access token expiry in seconds
                    example: 3600
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/refresh:
    post:
      summary: Refresh access token (Alias)
      description: Alias endpoint for mobile compatibility
      operationId: refreshTokenAlias
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  expires_in:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/auth/logout:
    post:
      summary: Logout user
      description: Invalidates the current refresh token
      operationId: logout
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logout successful
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ============================================================================
  # User Profile Endpoints
  # ============================================================================
  /api/v1/user/profile:
    get:
      summary: Get user profile (Passenger)
      description: |
        Retrieve the authenticated passenger's profile information.

        **Multi-Role Architecture:**
        - For users with 'passenger' role, returns data from the `passengers` table
        - The `users` table only stores authentication info (phone, roles[], status)
        - Each role has its own profile table with role-specific data

        **Response includes:**
        - User authentication data from `users` table
        - Passenger profile data from `passengers` table (first_name, last_name, email, profile_completed, etc.)

        **Note:** Bus owners, staff, and lounge owners have their own profile endpoints.
      operationId: getUserProfile
      tags:
        - User
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PassengerProfile"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update user profile
      description: Update the authenticated user's profile information
      operationId: updateUserProfile
      tags:
        - User
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: John Doe
                email:
                  type: string
                  format: email
                  example: john.doe@example.com
                nic:
                  type: string
                  example: "199512345678"
                address:
                  type: string
                  example: "123 Main St, Colombo"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Profile updated successfully
                  user:
                    $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/user/complete-basic-profile:
    post:
      summary: Complete basic passenger profile
      description: |
        Complete the basic profile for a passenger user by providing first name and last name.

        **Multi-Role Architecture:**
        - This endpoint stores data in the `passengers` table (not `users` table)
        - Each role has its own profile table: `bus_owners`, `bus_staff`, `lounge_owners`, `passengers`
        - The `users` table only handles authentication (phone, roles[], status)

        **Flow:**
        1. User registers via OTP → creates record in `users` and `passengers` tables
        2. User calls this endpoint with first_name and last_name
        3. `passengers.profile_completed` is set to `true`
        4. App can now proceed to full functionality

        **Required for:** Passengers who have `profile_completed: false` after registration
      operationId: completeBasicProfile
      tags:
        - User
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - first_name
                - last_name
              properties:
                first_name:
                  type: string
                  minLength: 1
                  maxLength: 100
                  example: "John"
                  description: User's first name
                last_name:
                  type: string
                  minLength: 1
                  maxLength: 100
                  example: "Doe"
                  description: User's last name
      responses:
        "200":
          description: Profile completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Basic profile completed successfully"
                  profile_completed:
                    type: boolean
                    example: true
                  passenger:
                    $ref: "#/components/schemas/Passenger"
        "400":
          description: Invalid request - missing or invalid first_name/last_name
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "first_name and last_name are required"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: User is not a passenger
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "This endpoint is only for passengers"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Admin Authentication Endpoints
  # ============================================================================
  /api/v1/admin/auth/login:
    post:
      summary: Admin login
      description: Authenticate admin user with email and password
      operationId: adminLogin
      tags:
        - Admin Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: admin@smarttransit.com
                password:
                  type: string
                  format: password
                  example: Admin@123
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refresh_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  expires_in:
                    type: integer
                    format: int64
                    example: 3600
                  admin_user:
                    $ref: "#/components/schemas/AdminUser"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Invalid credentials or account inactive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/v1/admin/auth/refresh:
    post:
      summary: Refresh admin access token
      description: Generate a new access token using a refresh token
      operationId: adminRefreshToken
      tags:
        - Admin Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  expires_in:
                    type: integer
                    format: int64
                  admin_user:
                    $ref: "#/components/schemas/AdminUser"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/admin/auth/logout:
    post:
      summary: Admin logout
      description: Revoke the refresh token
      operationId: adminLogout
      tags:
        - Admin Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        "200":
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        "400":
          $ref: "#/components/responses/BadRequest"

  /api/v1/admin/auth/profile:
    get:
      summary: Get admin profile
      description: Get the authenticated admin user's profile
      operationId: getAdminProfile
      tags:
        - Admin Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Admin profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminUser"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/admin/auth/change-password:
    post:
      summary: Change admin password
      description: Change the authenticated admin user's password
      operationId: changeAdminPassword
      tags:
        - Admin Authentication
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - old_password
                - new_password
              properties:
                old_password:
                  type: string
                  format: password
                new_password:
                  type: string
                  format: password
                  minLength: 8
      responses:
        "200":
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password changed successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/admin/auth/create:
    post:
      summary: Create new admin user
      description: Create a new admin user (requires admin authentication)
      operationId: createAdminUser
      tags:
        - Admin Authentication
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - full_name
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                  minLength: 8
                full_name:
                  type: string
      responses:
        "201":
          description: Admin user created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminUser"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/admin/auth/list:
    get:
      summary: List all admin users
      description: Get a list of all admin users (requires admin authentication)
      operationId: listAdminUsers
      tags:
        - Admin Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Admin users retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AdminUser"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ============================================================================
  # Bus Seat Layout Endpoints
  # ============================================================================
  /api/v1/admin/seat-layouts:
    post:
      summary: Create bus seat layout template
      description: Create a new bus seat layout template with seat configuration
      operationId: createSeatLayoutTemplate
      tags:
        - Bus Seat Layout
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBusSeatLayoutTemplateRequest"
      responses:
        "201":
          description: Template created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusSeatLayoutTemplateResponse"
        "400":
          description: Invalid request body
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          description: Internal server error
    get:
      summary: List all seat layout templates
      description: Get all bus seat layout templates with optional filtering
      operationId: listSeatLayoutTemplates
      tags:
        - Bus Seat Layout
      security:
        - BearerAuth: []
      parameters:
        - name: active_only
          in: query
          description: Filter to show only active templates
          required: false
          schema:
            type: boolean
            example: true
      responses:
        "200":
          description: Templates retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  templates:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusSeatLayoutTemplate"
                  count:
                    type: integer
                    example: 5
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          description: Internal server error

  /api/v1/admin/seat-layouts/{id}:
    get:
      summary: Get seat layout template by ID
      description: Retrieve a specific seat layout template with all seat details
      operationId: getSeatLayoutTemplate
      tags:
        - Bus Seat Layout
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          description: Template UUID
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Template retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusSeatLayoutTemplateResponse"
        "400":
          description: Invalid template ID
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Template not found
    put:
      summary: Update seat layout template
      description: Update template's basic information (name, description, status)
      operationId: updateSeatLayoutTemplate
      tags:
        - Bus Seat Layout
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          description: Template UUID
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateBusSeatLayoutTemplateRequest"
      responses:
        "200":
          description: Template updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Template updated successfully"
        "400":
          description: Invalid request
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Template not found
        "500":
          description: Internal server error
    delete:
      summary: Delete seat layout template
      description: Delete a seat layout template (cascades to all seats)
      operationId: deleteSeatLayoutTemplate
      tags:
        - Bus Seat Layout
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          description: Template UUID
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Template deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Template deleted successfully"
        "400":
          description: Invalid template ID
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Template not found
        "500":
          description: Internal server error

  # ============================================================================
  # Staff Endpoints
  # ============================================================================
  /api/v1/staff/check-registration:
    post:
      summary: Check staff registration status
      description: Check if a phone number is registered as staff and get registration details
      operationId: checkStaffRegistration
      tags:
        - Staff
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
      responses:
        "200":
          description: Registration status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_registered:
                    type: boolean
                    example: true
                  staff:
                    $ref: "#/components/schemas/BusStaff"
        "404":
          description: Phone number not registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_registered:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Phone number not registered as staff

  /api/v1/staff/register:
    post:
      summary: Register new staff member
      description: |
        Register a new driver or conductor profile.

        **New Registration Flow:**
        - Staff registers their profile (driver or conductor)
        - Profile is created without any bus owner link
        - Staff waits for a bus owner to link them to their organization
        - Employment details (hire date, status, performance) are managed separately

        **Requirements:**
        - Valid phone number (not already registered as staff)
        - Staff type (driver or conductor)
        - NTC license number and expiry date (required for both drivers and conductors)
      operationId: registerStaff
      tags:
        - Staff
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - first_name
                - last_name
                - staff_type
                - license_number
                - license_expiry_date
                - emergency_contact
                - emergency_contact_name
              properties:
                first_name:
                  type: string
                  description: Staff member's first name
                  example: "Kamal"
                last_name:
                  type: string
                  description: Staff member's last name
                  example: "Perera"
                staff_type:
                  type: string
                  enum: [driver, conductor]
                  description: Type of staff - driver or conductor
                  example: "driver"
                license_number:
                  type: string
                  description: NTC license number (required for both drivers and conductors)
                  example: "NTC1234567"
                license_expiry_date:
                  type: string
                  format: date
                  description: NTC license expiry date (required for both drivers and conductors)
                  example: "2026-12-31"
                experience_years:
                  type: integer
                  description: Years of experience
                  example: 5
                emergency_contact:
                  type: string
                  description: Emergency contact phone number
                  example: "+94777654321"
                emergency_contact_name:
                  type: string
                  description: Emergency contact person name
                  example: "Nimal Perera"
      responses:
        "201":
          description: Staff registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Staff registered successfully
                  staff:
                    $ref: "#/components/schemas/BusStaff"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/bus-owners/search:
    get:
      summary: Search bus owners
      description: Search for bus owners by name or NIC
      operationId: searchBusOwners
      tags:
        - Staff
      security: []
      parameters:
        - name: query
          in: query
          required: true
          description: Search query (name or NIC)
          schema:
            type: string
            example: "Perera"
        - name: limit
          in: query
          required: false
          description: Maximum number of results
          schema:
            type: integer
            default: 10
            example: 10
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  bus_owners:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusOwner"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/profile:
    get:
      summary: Get staff profile
      description: Retrieve the authenticated staff member's profile
      operationId: getStaffProfile
      tags:
        - Staff
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Staff profile retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StaffProfile"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update staff profile
      description: Update the authenticated staff member's profile
      operationId: updateStaffProfile
      tags:
        - Staff
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "John Driver"
                nic:
                  type: string
                  example: "199512345678"
                license_number:
                  type: string
                  example: "B1234567"
                address:
                  type: string
                  example: "123 Main St, Colombo"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Profile updated successfully
                  staff:
                    $ref: "#/components/schemas/BusStaff"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Bus Owner Endpoints
  # ============================================================================
  /api/v1/bus-owner/profile:
    get:
      summary: Get bus owner profile
      description: Retrieve the authenticated bus owner's profile
      operationId: getBusOwnerProfile
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusOwnerProfile"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/profile-status:
    get:
      summary: Check bus owner profile completion status
      description: Check if the bus owner has completed onboarding
      operationId: checkBusOwnerProfileStatus
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Status retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
                  phone:
                    type: string
                    example: "+94712345678"
                  profile_completed:
                    type: boolean
                    example: false
                  permit_count:
                    type: integer
                    example: 2
                  has_company_info:
                    type: boolean
                    example: true
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/complete-onboarding:
    post:
      summary: Complete bus owner onboarding
      description: Submit company information and route permits to complete onboarding
      operationId: completeBusOwnerOnboarding
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - company_name
                - identity_or_incorporation_no
                - permits
              properties:
                company_name:
                  type: string
                  example: "ABC Transport Services"
                identity_or_incorporation_no:
                  type: string
                  example: "PV-2023-1234"
                business_email:
                  type: string
                  format: email
                  example: "info@abctransport.lk"
                permits:
                  type: array
                  items:
                    type: object
                    required:
                      - permit_number
                      - bus_registration_number
                      - route_number
                      - from_city
                      - to_city
                      - approved_fare
                      - validity_from
                      - validity_to
                    properties:
                      permit_number:
                        type: string
                        example: "PERMIT-2025-001"
                      bus_registration_number:
                        type: string
                        example: "WP CAB-1234"
                      route_number:
                        type: string
                        example: "138"
                      from_city:
                        type: string
                        example: "Colombo"
                      to_city:
                        type: string
                        example: "Kandy"
                      via:
                        type: string
                        example: "Kadawatha, Kegalle"
                      approved_fare:
                        type: number
                        example: 250.00
                      validity_from:
                        type: string
                        format: date
                        example: "2025-01-01"
                      validity_to:
                        type: string
                        format: date
                        example: "2025-12-31"
      responses:
        "200":
          description: Onboarding completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Onboarding completed successfully
                  profile_completed:
                    type: boolean
                    example: true
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/staff:
    get:
      summary: Get all staff members (drivers and conductors)
      description: |
        Retrieves all drivers and conductors currently employed by the authenticated bus owner.
        Returns staff profiles combined with their current employment information.

        **Data Structure:**
        - Staff profile information (name, license, etc.)
        - Current employment record (hire date, status, performance)
        - User contact info (phone number)
      operationId: getStaffMembers
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Staff list retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  staff:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                          description: Staff profile ID
                          example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                        user_id:
                          type: string
                          format: uuid
                          example: "3edeb9af-51c3-4c24-a5d0-76c9dee2d4ea"
                        first_name:
                          type: string
                          example: "Kamal"
                        last_name:
                          type: string
                          example: "Perera"
                        phone:
                          type: string
                          description: Phone number from user profile
                          example: "+94712345678"
                        staff_type:
                          type: string
                          enum: [driver, conductor]
                          example: "driver"
                        license_number:
                          type: string
                          example: "NTC1234567"
                        license_expiry_date:
                          type: string
                          format: date
                          example: "2026-12-31"
                        experience_years:
                          type: integer
                          example: 5
                        is_verified:
                          type: boolean
                          description: Whether staff has been verified/approved
                          example: true
                        verification_status:
                          type: string
                          enum: [pending, approved, rejected]
                          description: Staff verification status
                          example: "approved"
                        employment_id:
                          type: string
                          format: uuid
                          description: Current employment record ID
                          example: "e692d392-cb88-50e3-9f79-6f8488528cf9"
                        employment_status:
                          type: string
                          enum: [active, inactive, suspended, terminated]
                          example: "active"
                        hire_date:
                          type: string
                          format: date
                          example: "2024-01-15"
                        performance_rating:
                          type: number
                          format: double
                          example: 4.5
                        total_trips_completed:
                          type: integer
                          example: 150
                  total:
                    type: integer
                    example: 2
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Bus owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Bus owner profile not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Add driver or conductor to organization
      description: |
        Allows bus owner to add a driver or conductor directly to their organization.
        NTC license number and expiry date are mandatory for both drivers and conductors.
        If the phone number doesn't exist, a new user account will be created.
        Staff members are pre-approved (employment_status = 'active') and can immediately login via driver/conductor app.
      operationId: addStaffMember
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone_number
                - first_name
                - last_name
                - staff_type
                - ntc_license_number
                - license_expiry_date
              properties:
                phone_number:
                  type: string
                  description: Staff member's phone number (will be used for login)
                  example: "+94712345678"
                first_name:
                  type: string
                  description: Staff member's first name
                  example: "Kamal"
                last_name:
                  type: string
                  description: Staff member's last name
                  example: "Perera"
                staff_type:
                  type: string
                  enum: [driver, conductor]
                  description: Type of staff member
                  example: "driver"
                ntc_license_number:
                  type: string
                  description: NTC (National Transport Commission) license number - MANDATORY
                  example: "NTC1234567"
                license_expiry_date:
                  type: string
                  format: date
                  description: NTC license expiry date (YYYY-MM-DD) - MANDATORY, must be in future
                  example: "2026-12-31"
                experience_years:
                  type: integer
                  description: Years of driving/conducting experience (optional)
                  example: 5
                emergency_contact:
                  type: string
                  description: Emergency contact phone number (optional)
                  example: "+94777654321"
                emergency_contact_name:
                  type: string
                  description: Emergency contact person name (optional)
                  example: "Nimal Perera"
      responses:
        "201":
          description: Staff member added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "driver added successfully"
                  user_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
                  staff_id:
                    type: string
                    format: uuid
                    example: "987e6543-e21b-98d3-a654-426614174999"
                  staff_type:
                    type: string
                    example: "driver"
                  instructions:
                    type: string
                    example: "Staff member can now login using phone number +94712345678"
        "400":
          description: Bad request - validation failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "NTC license has already expired"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Bus owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Bus owner profile not found. Please complete onboarding first."
        "409":
          description: Conflict - staff already registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "This phone number is already registered as driver"
                  staff_type:
                    type: string
                    example: "driver"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/staff/verify:
    post:
      summary: Verify staff member eligibility by phone number
      description: |
        Verifies if a staff member can be linked to the bus owner's organization.

        **Checks performed:**
        - If the phone number exists in the system
        - If the user is registered as staff (driver/conductor)
        - If the staff profile is completed
        - If the staff is verified by admin (background check approved)
        - If the staff has an active employment with another bus owner

        **New Employment Model:**
        Staff can have employment history with multiple bus owners over time.
        This endpoint checks if staff currently has an active employment elsewhere.

        Use this endpoint before linking a staff member to your organization.
      operationId: verifyStaffMember
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone_number
              properties:
                phone_number:
                  type: string
                  description: Staff member's phone number
                  example: "+94712345678"
      responses:
        "200":
          description: Verification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  found:
                    type: boolean
                    description: Whether the phone number exists in the system
                    example: true
                  eligible:
                    type: boolean
                    description: Whether the staff member can be added
                    example: true
                  staff_id:
                    type: string
                    format: uuid
                    description: Staff member's ID (if found and is staff)
                    example: "123e4567-e89b-12d3-a456-426614174000"
                  staff_type:
                    type: string
                    enum: [driver, conductor]
                    description: Type of staff member
                    example: "driver"
                  first_name:
                    type: string
                    description: Staff member's first name
                    example: "Kamal"
                  last_name:
                    type: string
                    description: Staff member's last name
                    example: "Perera"
                  profile_completed:
                    type: boolean
                    description: Whether staff has completed their profile
                    example: true
                  is_verified:
                    type: boolean
                    description: Whether staff is verified by admin
                    example: true
                  already_linked:
                    type: boolean
                    description: Whether staff is already linked to a bus owner
                    example: false
                  message:
                    type: string
                    description: Human-readable status message
                    example: "Staff member is eligible to be added to your organization"
                  reason:
                    type: string
                    enum:
                      [
                        not_staff,
                        profile_incomplete,
                        not_verified,
                        already_linked_other,
                        already_yours,
                      ]
                    description: Reason code if not eligible
                    example: null
        "400":
          description: Bad request - invalid phone number
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Phone number is required"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/staff/link:
    post:
      summary: Link verified staff member to bus owner organization
      description: |
        Links a verified staff member to the authenticated bus owner's organization.
        Creates a new employment record for the staff member.

        **Prerequisites:**
        - Staff must exist and be a driver/conductor
        - Staff profile must be completed
        - Staff must be verified by admin
        - Staff must not have an active employment with another bus owner

        **Effects:**
        - Creates a new employment record in `bus_staff_employment` table
        - Sets `is_current` to true
        - Sets `employment_status` to 'active'
        - Sets `hire_date` to current date
      operationId: linkStaffMember
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - staff_id
              properties:
                staff_id:
                  type: string
                  format: uuid
                  description: Staff member's ID (from verify response)
                  example: "123e4567-e89b-12d3-a456-426614174000"
      responses:
        "200":
          description: Staff member linked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Staff member linked successfully"
                  staff_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
                  employment_id:
                    type: string
                    format: uuid
                    description: The new employment record ID
                    example: "e692d392-cb88-50e3-9f79-6f8488528cf9"
                  staff_type:
                    type: string
                    example: "driver"
                  first_name:
                    type: string
                    example: "Kamal"
                  last_name:
                    type: string
                    example: "Perera"
                  hire_date:
                    type: string
                    format: date
                    example: "2024-12-05"
        "400":
          description: Bad request - staff not eligible
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Staff profile is not completed"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Staff or bus owner not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Staff member not found"
        "409":
          description: Staff already linked to another bus owner
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Staff is already linked to another bus owner"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/staff/unlink:
    post:
      summary: Unlink staff member from bus owner organization
      description: |
        Ends the employment relationship between a staff member and the bus owner.
        The employment record is preserved for history, but marked as terminated.

        **Effects:**
        - Sets `is_current` to false on the employment record
        - Sets `termination_date` to current date
        - Sets `employment_status` to 'terminated'
        - Staff can be linked to another bus owner after this

        **Note:** This does not delete the staff profile or user account.
      operationId: unlinkStaffMember
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - staff_id
              properties:
                staff_id:
                  type: string
                  format: uuid
                  description: Staff member's ID to unlink
                  example: "123e4567-e89b-12d3-a456-426614174000"
                termination_reason:
                  type: string
                  description: Optional reason for termination
                  example: "Contract ended"
      responses:
        "200":
          description: Staff member unlinked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Staff member unlinked successfully"
                  staff_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
                  termination_date:
                    type: string
                    format: date
                    example: "2024-12-05"
        "400":
          description: Bad request - staff not linked to this bus owner
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Staff is not currently employed by you"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Staff or bus owner not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Staff member not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Bus Owner Routes (Custom Route Configurations)
  # ============================================================================
  /api/v1/bus-owner-routes:
    post:
      summary: Create custom route configuration
      description: |
        Create a custom route configuration with selected stops for UP or DOWN direction.
        First and last stops must be included.
      operationId: createBusOwnerRoute
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - master_route_id
                - custom_route_name
                - direction
                - selected_stop_ids
              properties:
                master_route_id:
                  type: string
                  format: uuid
                  example: "a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d"
                custom_route_name:
                  type: string
                  example: "Colombo Badulla Route for BlueBus"
                direction:
                  type: string
                  enum: [UP, DOWN]
                  example: "UP"
                selected_stop_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 2
                  example: ["stop-id-1", "stop-id-2", "stop-id-3"]
      responses:
        "201":
          description: Route created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusOwnerRoute"
        "400":
          description: Bad request - validation failed
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Get all custom routes
      description: Retrieve all custom route configurations for the authenticated bus owner
      operationId: getBusOwnerRoutes
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Routes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  routes:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusOwnerRoute"
                  count:
                    type: integer
                    example: 3
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner-routes/{id}:
    get:
      summary: Get custom route by ID
      description: Retrieve a specific custom route configuration
      operationId: getBusOwnerRouteById
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Route retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusOwnerRoute"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Route not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update custom route
      description: Update an existing custom route configuration
      operationId: updateBusOwnerRoute
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                custom_route_name:
                  type: string
                  example: "Updated Route Name"
                selected_stop_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 2
      responses:
        "200":
          description: Route updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusOwnerRoute"
        "400":
          description: Bad request - validation failed
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Route not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete custom route
      description: Delete a custom route configuration
      operationId: deleteBusOwnerRoute
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Route deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Route deleted successfully"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Route not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner-routes/by-master-route/{master_route_id}:
    get:
      summary: Get custom routes by master route
      description: Retrieve all custom routes for a specific master route
      operationId: getBusOwnerRoutesByMasterRoute
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      parameters:
        - name: master_route_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Routes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  routes:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusOwnerRoute"
                  count:
                    type: integer
                    example: 2
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Timetable Endpoints (New Timetable-Based Scheduling System)
  # ============================================================================
  /api/v1/timetables:
    post:
      summary: Create a new timetable (repeating trip schedule)
      description: |
        Creates a timetable for automatic trip generation. Upon creation, the system immediately generates
        trips for the next 7 days (configurable via system_settings.trip_generation_days_ahead).

        **How it works:**
        - Timetable stores the template: route, times, recurrence pattern, valid_from/until dates
        - The system automatically generates individual scheduled_trips based on the template
        - Values like is_bookable, max_bookable_seats, booking_advance_hours are applied to each generated trip
        - Generated trips use the valid_from/until dates to determine which dates to create trips for

        **Trip Generation:**
        - Trips are generated immediately upon timetable creation for the configured date range
        - Additional trips can be generated manually via admin endpoints if needed

        After creation, use the publish endpoints to make trips available for passenger booking.
      operationId: createTimetable
      tags:
        - Timetables
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - custom_route_id
                - departure_time
                - base_fare
                - max_bookable_seats
                - recurrence_type
                - valid_from
              properties:
                custom_route_id:
                  type: string
                  format: uuid
                  description: Reference to bus owner's custom route configuration
                permit_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: Optional route permit ID (can be NULL if not assigned yet)
                schedule_name:
                  type: string
                  example: "Morning Express Colombo-Badulla"
                  description: Optional descriptive name for the timetable
                valid_from:
                  type: string
                  format: date
                  example: "2025-11-08"
                  description: Start date for trip generation (YYYY-MM-DD format, required)
                valid_until:
                  type: string
                  format: date
                  nullable: true
                  example: "2025-12-31"
                  description: End date for trip generation (YYYY-MM-DD format, optional - NULL means continuous)
                departure_time:
                  type: string
                  pattern: "^([0-1][0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$"
                  example: "09:30"
                  description: Departure time in HH:MM or HH:MM:SS format
                estimated_duration_minutes:
                  type: integer
                  minimum: 1
                  example: 420
                  description: Estimated trip duration in minutes (optional - defaults to 60 minutes if not provided)
                base_fare:
                  type: number
                  format: double
                  minimum: 0
                  example: 850.00
                  description: Must be ≤ permit approved_fare
                max_bookable_seats:
                  type: integer
                  minimum: 1
                  example: 45
                  description: Must be ≤ permit approved_seating_capacity
                is_bookable:
                  type: boolean
                  default: true
                  description: Whether trip allows online bookings
                booking_advance_hours:
                  type: integer
                  minimum: 72
                  example: 72
                  description: Hours before departure that booking opens (≥72, defaults to system setting)
                recurrence_type:
                  type: string
                  enum: [daily, weekly, interval]
                  description: How often the trip repeats
                recurrence_days:
                  type: array
                  items:
                    type: integer
                    minimum: 0
                    maximum: 6
                  example: [1, 3, 5]
                  description: Required for weekly. Days of week (0=Sunday, 6=Saturday)
                recurrence_interval:
                  type: integer
                  minimum: 2
                  example: 3
                  description: Required for interval. Repeat every N days
                notes:
                  type: string
                  maxLength: 500
                  description: Optional notes about the timetable
      responses:
        "201":
          description: Timetable created successfully with instant trip generation
          content:
            application/json:
              schema:
                type: object
                properties:
                  schedule:
                    $ref: "#/components/schemas/TripSchedule"
                  trips_generated:
                    type: integer
                    example: 7
                    description: Number of trips automatically generated for the next 7 days
                  message:
                    type: string
                    example: "Timetable created successfully. Trips generated for next 7 days."
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Access denied - not owner of route/permit
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Special Trip Endpoints (One-Time Trips)
  # ============================================================================
  /api/v1/special-trips:
    post:
      summary: Create a special one-time trip (not from timetable)
      description: |
        Creates a single trip that is not part of a repeating timetable. If the trip date is too soon
        (past the assignment deadline), bus assignment is mandatory.
      operationId: createSpecialTrip
      tags:
        - Special Trips
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - custom_route_id
                - departure_datetime
                - base_fare
                - max_bookable_seats
              properties:
                custom_route_id:
                  type: string
                  format: uuid
                  description: Reference to bus owner's custom route
                permit_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: Optional route permit ID (can be NULL if not assigned yet)
                departure_datetime:
                  type: string
                  format: date-time
                  example: "2024-12-25T10:00:00Z"
                  description: "Trip departure date and time in ISO 8601 format (YYYY-MM-DDTHH:MM:SS). Cannot be in past."
                estimated_duration_minutes:
                  type: integer
                  minimum: 1
                  example: 390
                  description: "Estimated trip duration in minutes. Arrival datetime will be calculated as departure_datetime + duration."
                base_fare:
                  type: number
                  format: double
                  minimum: 0
                  description: Must be ≤ permit approved_fare
                max_bookable_seats:
                  type: integer
                  minimum: 1
                  description: Must be ≤ permit approved_seating_capacity
                is_bookable:
                  type: boolean
                  default: false
                  description: |
                    Whether the trip is open for passenger bookings. Defaults to false because a seat_layout_id 
                    is required for bookable trips (DB constraint). Create trip with is_bookable=false, then 
                    assign seat layout, then use PUT /scheduled-trips/{id}/publish to make it bookable.
                booking_advance_hours:
                  type: integer
                  minimum: 72
                  description: Hours before trip that booking opens (≥72)
                bus_id:
                  type: string
                  format: uuid
                  description: Required if trip is soon (within assignment deadline)
                assigned_driver_id:
                  type: string
                  format: uuid
                assigned_conductor_id:
                  type: string
                  format: uuid
      responses:
        "201":
          description: Special trip created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  trip_schedule_id:
                    type: string
                    nullable: true
                    description: Always null for special trips
                  custom_route_id:
                    type: string
                    format: uuid
                  departure_datetime:
                    type: string
                    format: date-time
                    example: "2024-12-25T10:00:00Z"
                  actual_arrival_datetime:
                    type: string
                    format: date-time
                    nullable: true
                    example: "2024-12-25T16:30:00Z"
                  status:
                    type: string
                    enum:
                      [scheduled, confirmed, in_progress, completed, cancelled]
        "400":
          description: Bad request - validation failed or trip too soon without bus assignment
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  details:
                    type: object
                    properties:
                      assignment_deadline:
                        type: string
                        format: date-time
                      current_time:
                        type: string
                        format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Access denied
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # System Settings Endpoints
  # ============================================================================
  /api/v1/system-settings:
    get:
      summary: Get all system settings
      description: Retrieves all system configuration settings
      operationId: getAllSystemSettings
      tags:
        - System Settings
      security:
        - BearerAuth: []
      responses:
        "200":
          description: System settings retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    setting_key:
                      type: string
                      example: "booking_advance_hours_default"
                    setting_value:
                      type: string
                      example: "72"
                    description:
                      type: string
                      example: "Default minimum hours before trip departure that booking opens"
                    created_at:
                      type: string
                      format: date-time
                    updated_at:
                      type: string
                      format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/system-settings/{key}:
    get:
      summary: Get a specific system setting by key
      operationId: getSystemSettingByKey
      tags:
        - System Settings
      security:
        - BearerAuth: []
      parameters:
        - name: key
          in: path
          required: true
          schema:
            type: string
          example: "booking_advance_hours_default"
          description: Setting key name
      responses:
        "200":
          description: Setting retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  setting_key:
                    type: string
                  setting_value:
                    type: string
                  description:
                    type: string
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Setting not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update a system setting value
      description: |
        Updates a system setting value. Note: In production, this should be admin-only.
        Available settings:
        - booking_advance_hours_default: Default hours before trip that booking opens (≥72)
        - assignment_deadline_hours: Hours before departure to assign bus/staff (default: 2)
      operationId: updateSystemSetting
      tags:
        - System Settings
      security:
        - BearerAuth: []
      parameters:
        - name: key
          in: path
          required: true
          schema:
            type: string
          example: "booking_advance_hours_default"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - setting_value
              properties:
                setting_value:
                  type: string
                  example: "96"
                  description: New value for the setting
      responses:
        "200":
          description: Setting updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  setting_key:
                    type: string
                  setting_value:
                    type: string
                  updated_at:
                    type: string
                    format: date-time
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Setting not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Lounge Owner Endpoints
  # ============================================================================
  #
  # LOUNGE OWNER REGISTRATION FLOW (3 STEPS):
  # ==========================================
  # Step 1: Business & Manager Info   - /api/v1/lounge-owner/register/business-info
  # Step 2: Add Lounge                - /api/v1/lounge-owner/register/add-lounge
  # Step 3: Add Staff (optional)      - /api/v1/lounges/{lounge_id}/staff
  #
  # After Step 2, registration_step becomes "completed" and profile_completed = true
  # Admin then reviews and approves/rejects via web dashboard
  # verification_status: "pending" -> "approved" or "rejected"
  #
  # NOTE: NIC verification step was removed. NIC images can optionally be included
  #       in Step 1 (business-info), and verification is done manually by admins.
  # ============================================================================
  /api/v1/lounge-owner/register/business-info:
    post:
      summary: Save business and manager information
      description: |
        Step 1 of lounge owner registration - save business and manager details.
        Requires authenticated user with 'lounge_owner' role.
      operationId: saveLoungeOwnerBusinessInfo
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - business_name
                - manager_full_name
                - manager_nic_number
              properties:
                business_name:
                  type: string
                  minLength: 3
                  maxLength: 255
                  example: "Grand Hotel Colombo"
                  description: Business/Hotel name
                business_license:
                  type: string
                  maxLength: 100
                  example: "BR2024123456"
                  description: |
                    Business registration number (optional).
                    Must be unique across all lounge owners.
                    Leave empty if not applicable.
                manager_full_name:
                  type: string
                  minLength: 3
                  maxLength: 255
                  example: "John Doe"
                  description: Manager's full legal name
                manager_nic_number:
                  type: string
                  pattern: "^[0-9]{9}[VXvx]$|^[0-9]{12}$"
                  example: "200012345678"
                  description: Manager's NIC (one person can manage only one business)
                manager_email:
                  type: string
                  format: email
                  example: "manager@grandhotel.com"
                  description: Manager's email address (optional)
      responses:
        "200":
          description: Business and manager information saved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Business and manager information saved successfully"
                  registration_step:
                    type: string
                    example: "business_info"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Duplicate business license
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "duplicate_business_license"
                  message:
                    type: string
                    example: "This business license number is already registered. Please use a different license number or contact support if you believe this is an error."
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/register/upload-manager-nic:
    post:
      summary: "[DEPRECATED] Upload manager NIC front and back images"
      deprecated: true
      description: |
        **DEPRECATED**: This endpoint is no longer used in the registration flow.
        NIC verification is now handled manually by admins after registration completion.
        This endpoint returns HTTP 410 Gone if called.
      operationId: uploadManagerNIC
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "410":
          description: Endpoint deprecated
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "deprecated_endpoint"
                  message:
                    type: string
                    example: "This endpoint is deprecated. Please include NIC images in the business-info step."

  /api/v1/lounge-owner/register/add-lounge:
    post:
      summary: Add lounge with pricing information
      description: |
        Step 2 of lounge owner registration - add lounge location and pricing.
        Can be called multiple times to add multiple lounges.
        Includes pricing for 3 types: 1 hour, 2 hours, until bus arrives.
      operationId: addLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lounge_name
                - address
                - contact_phone
                - latitude
                - longitude
                - routes
              properties:
                lounge_name:
                  type: string
                  minLength: 3
                  maxLength: 255
                  example: "City Central Lounge"
                  description: Name of the lounge
                description:
                  type: string
                  example: "Comfortable lounge with modern amenities"
                  description: Brief description of the lounge
                address:
                  type: string
                  minLength: 10
                  example: "123 Main St, Colombo 7"
                  description: Full address of the lounge
                state:
                  type: string
                  example: "Western Province"
                  description: State or province
                postal_code:
                  type: string
                  example: "00700"
                  description: Postal/ZIP code
                contact_phone:
                  type: string
                  example: "+94112345678"
                  description: Contact phone number for the lounge
                latitude:
                  type: string
                  example: "6.9271"
                  description: GPS latitude coordinate (required, as string)
                longitude:
                  type: string
                  example: "79.8612"
                  description: GPS longitude coordinate (required, as string)
                capacity:
                  type: integer
                  example: 50
                  description: Maximum number of people the lounge can accommodate
                routes:
                  type: array
                  minItems: 1
                  description: Array of routes that this lounge serves. Each route includes the master route and two consecutive stops where the lounge is located between.
                  items:
                    type: object
                    required:
                      - master_route_id
                      - stop_before_id
                      - stop_after_id
                    properties:
                      master_route_id:
                        type: string
                        format: uuid
                        example: "550e8400-e29b-41d4-a716-446655440000"
                        description: Route that the lounge serves
                      stop_before_id:
                        type: string
                        format: uuid
                        example: "660e8400-e29b-41d4-a716-446655440001"
                        description: Stop before the lounge location
                      stop_after_id:
                        type: string
                        format: uuid
                        example: "770e8400-e29b-41d4-a716-446655440002"
                        description: Stop after the lounge location
                  example:
                    - master_route_id: "550e8400-e29b-41d4-a716-446655440000"
                      stop_before_id: "660e8400-e29b-41d4-a716-446655440001"
                      stop_after_id: "770e8400-e29b-41d4-a716-446655440002"
                    - master_route_id: "880e8400-e29b-41d4-a716-446655440003"
                      stop_before_id: "990e8400-e29b-41d4-a716-446655440004"
                      stop_after_id: "aa0e8400-e29b-41d4-a716-446655440005"
                price_1_hour:
                  type: string
                  example: "500.00"
                  description: Price in LKR for 1 hour access (DECIMAL as string)
                price_2_hours:
                  type: string
                  example: "900.00"
                  description: Price in LKR for 2 hours access (DECIMAL as string)
                price_3_hours:
                  type: string
                  example: "1200.00"
                  description: Price in LKR for 3 hours access (DECIMAL as string)
                price_until_bus:
                  type: string
                  example: "1500.00"
                  description: Price in LKR for access until bus arrives (DECIMAL as string)
                amenities:
                  type: array
                  items:
                    type: string
                  example: ["WiFi", "AC", "Charging", "Cafe", "Shower"]
                  description: List of amenities available
                images:
                  type: array
                  items:
                    type: string
                    format: uri
                  example:
                    [
                      "https://storage.supabase.co/lounge1.jpg",
                      "https://storage.supabase.co/lounge2.jpg",
                    ]
                  description: Array of lounge image URLs
      responses:
        "201":
          description: Lounge added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Lounge added successfully"
                  lounge_id:
                    type: string
                    format: uuid
                    example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                  registration_step:
                    type: string
                    example: "completed"
                    description: "Registration is now complete"
                  profile_completed:
                    type: boolean
                    example: true
                    description: "Profile completion status"
                  status:
                    type: string
                    example: "pending"
                    description: "Lounge approval status (pending admin review)"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/registration/progress:
    get:
      summary: Get registration progress
      description: |
        Get current registration status and what steps have been completed.
      operationId: getLoungeOwnerRegistrationProgress
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Registration progress retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  registration_step:
                    type: string
                    enum:
                      [
                        "phone_verified",
                        "business_info",
                        "lounge_added",
                        "completed",
                      ]
                    example: "business_info"
                  profile_completed:
                    type: boolean
                    example: false
                  verification_status:
                    type: string
                    enum: ["pending", "approved", "rejected"]
                    example: "pending"
                  total_lounges:
                    type: integer
                    example: 0
                    description: Dynamic count - calculated from lounges table
                  total_staff:
                    type: integer
                    example: 0
                    description: Dynamic count - calculated from lounge_staff table
                  steps:
                    type: object
                    properties:
                      phone_verified:
                        type: boolean
                        example: true
                      business_info:
                        type: boolean
                        example: true
                      lounge_added:
                        type: boolean
                        example: false
                      completed:
                        type: boolean
                        example: false
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Lounge owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Lounge owner profile not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/profile:
    get:
      summary: Get lounge owner profile
      description: |
        Retrieve complete lounge owner profile including personal information and registration status.
      operationId: getLoungeOwnerProfile
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                    example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                  user_id:
                    type: string
                    format: uuid
                    example: "3edeb9af-51c3-4c24-a5d0-76c9dee2d4ea"
                  business_name:
                    type: string
                    nullable: true
                    example: "Grand Hotel Colombo"
                    description: "Business name - nullable (sql.NullString)"
                  business_license:
                    type: string
                    nullable: true
                    example: "BR2024123456"
                    description: "Business license number - nullable (sql.NullString)"
                  manager_full_name:
                    type: string
                    nullable: true
                    example: "John Doe"
                    description: "Manager full name - nullable (sql.NullString)"
                  manager_nic_number:
                    type: string
                    nullable: true
                    example: "200012345678"
                    description: "Manager NIC number - nullable (sql.NullString)"
                  manager_email:
                    type: string
                    nullable: true
                    example: "manager@grandhotel.com"
                    description: "Manager email - nullable (sql.NullString)"
                  registration_step:
                    type: string
                    enum:
                      [
                        "phone_verified",
                        "business_info",
                        "lounge_added",
                        "completed",
                      ]
                    example: "completed"
                  profile_completed:
                    type: boolean
                    example: true
                  verification_status:
                    type: string
                    enum: ["pending", "approved", "rejected"]
                    example: "pending"
                  verification_notes:
                    type: string
                    nullable: true
                    example: "Pending document verification"
                    description: "Admin verification notes - nullable (sql.NullString)"
                  verified_at:
                    type: string
                    format: date-time
                    nullable: true
                    example: "2025-10-19T12:00:00Z"
                    description: "Verification timestamp - nullable (sql.NullTime)"
                  total_lounges:
                    type: integer
                    example: 2
                    description: Dynamic count - calculated from lounges table
                  total_staff:
                    type: integer
                    example: 5
                    description: Dynamic count - calculated from lounge_staff table
                  created_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T10:30:00Z"
                  updated_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T11:00:00Z"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Lounge owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Lounge owner profile not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Lounge Management Endpoints
  # ============================================================================
  /api/v1/lounges/my-lounges:
    get:
      summary: Get all my lounges
      description: |
        Retrieve all lounges owned by the authenticated lounge owner with pricing and amenities.
      operationId: getMyLounges
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Lounges retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  lounges:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        lounge_owner_id:
                          type: string
                          format: uuid
                        lounge_name:
                          type: string
                          example: "City Central Lounge"
                        description:
                          type: string
                          nullable: true
                        address:
                          type: string
                        state:
                          type: string
                          nullable: true
                        country:
                          type: string
                          nullable: true
                        postal_code:
                          type: string
                          nullable: true
                        contact_phone:
                          type: string
                          nullable: true
                        latitude:
                          type: string
                          nullable: true
                        longitude:
                          type: string
                          nullable: true
                        capacity:
                          type: integer
                          nullable: true
                          example: 50
                        price_1_hour:
                          type: string
                          nullable: true
                          example: "500.00"
                        price_2_hours:
                          type: string
                          nullable: true
                          example: "900.00"
                        price_3_hours:
                          type: string
                          nullable: true
                          example: "1200.00"
                        price_until_bus:
                          type: string
                          nullable: true
                          example: "1500.00"
                        amenities:
                          type: array
                          items:
                            type: string
                          nullable: true
                          example: ["wifi", "ac", "cafeteria", "charging_ports"]
                        images:
                          type: array
                          items:
                            type: string
                          nullable: true
                        status:
                          type: string
                          enum: ["pending", "active", "inactive", "suspended"]
                        is_operational:
                          type: boolean
                        average_rating:
                          type: string
                          nullable: true
                        created_at:
                          type: string
                          format: date-time
                        updated_at:
                          type: string
                          format: date-time
                  total:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{id}:
    get:
      summary: Get lounge by ID
      description: Get detailed information about a specific lounge
      operationId: getLoungeByID
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Lounge details retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Lounge"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update lounge
      description: Update lounge information including pricing
      operationId: updateLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lounge_name
                - address
                - city
                - contact_phone
              properties:
                lounge_name:
                  type: string
                address:
                  type: string
                city:
                  type: string
                contact_phone:
                  type: string
                latitude:
                  type: string
                longitude:
                  type: string
                price_1_hour:
                  type: string
                price_2_hours:
                  type: string
                price_until_bus:
                  type: string
                amenities:
                  type: array
                  items:
                    type: string
                images:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: Lounge updated successfully
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete lounge
      description: Delete a lounge (triggers will update counts)
      operationId: deleteLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Lounge deleted successfully
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/active:
    get:
      summary: Get all active lounges (Public)
      description: |
        Retrieve all active and operational lounges - no authentication required.
        
        **Query Parameters:**
        - `state`: Filter lounges by state/province (case-insensitive)
        - `limit`: Limit number of results (uses random ordering when specified)
        
        **Default Behavior:**
        - Without parameters: Returns all active lounges ordered by name
        - With `limit=5`: Returns 5 random lounges (for initial app load)
        - With `state=Western`: Returns all lounges in Western Province
      operationId: getAllActiveLounges
      tags:
        - Lounge Marketplace
      security: []
      parameters:
        - name: state
          in: query
          required: false
          description: Filter by state/province (case-insensitive)
          schema:
            type: string
            example: "Western"
        - name: limit
          in: query
          required: false
          description: Maximum number of lounges to return (uses random ordering)
          schema:
            type: integer
            minimum: 1
            example: 5
      responses:
        "200":
          description: Active lounges retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  lounges:
                    type: array
                    items:
                      $ref: "#/components/schemas/Lounge"
                  total:
                    type: integer
                    description: Total number of lounges returned
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/states:
    get:
      summary: Get all states with active lounges (Public)
      description: |
        Returns a list of distinct states/provinces that have active lounges.
        Used for populating state filter dropdowns in the passenger app.
        No authentication required.
      operationId: getDistinctStates
      tags:
        - Lounge Marketplace
      security: []
      responses:
        "200":
          description: States retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  states:
                    type: array
                    items:
                      type: string
                    example: ["Central", "Eastern", "Northern", "Southern", "Western"]
                    description: List of state names with active lounges
                  total:
                    type: integer
                    description: Number of states
                    example: 5
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/by-stop/{stopId}:
    get:
      summary: Get lounges by stop ID (Public)
      description: |
        Retrieve all active lounges that serve a specific bus stop.
        Used when passengers book a bus trip and want to find lounges at their boarding or alighting stop.
        
        **Use Case:**
        - Passenger books bus from Colombo Fort to Kandy
        - App shows lounges near Colombo Fort (pre-trip) and Kandy (post-trip)
        
        **Data Source:**
        - Joins `lounges` with `lounge_routes` table
        - Matches `stop_before_id` or `stop_after_id` to find relevant lounges
        
        **No authentication required** - public endpoint for passengers.
      operationId: getLoungesByStop
      tags:
        - Lounge Marketplace
      security: []
      parameters:
        - name: stopId
          in: path
          required: true
          description: UUID of the bus stop (from master_route_stops table)
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        "200":
          description: Lounges retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  lounges:
                    type: array
                    items:
                      $ref: "#/components/schemas/Lounge"
                  total:
                    type: integer
                    description: Number of lounges found
                    example: 3
        "400":
          description: Invalid stop ID format
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/by-route/{routeId}:
    get:
      summary: Get lounges by route ID (Public)
      description: |
        Retrieve all active lounges that serve stops along a specific bus route.
        Used to show all lounges available along the entire route.
        
        **Use Case:**
        - Show all lounge options along the Colombo-Kandy route
        - Help passengers discover lounges they can use during their journey
        
        **Data Source:**
        - Joins `lounges` with `lounge_routes` table
        - Matches `master_route_id` to find relevant lounges
        
        **No authentication required** - public endpoint for passengers.
      operationId: getLoungesByRoute
      tags:
        - Lounge Marketplace
      security: []
      parameters:
        - name: routeId
          in: path
          required: true
          description: UUID of the master route (from master_routes table)
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        "200":
          description: Lounges retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  lounges:
                    type: array
                    items:
                      $ref: "#/components/schemas/Lounge"
                  total:
                    type: integer
                    description: Number of lounges found
                    example: 5
        "400":
          description: Invalid route ID format
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/near-stop/{routeId}/{stopId}:
    get:
      summary: Get lounges near a passenger's stop (Public)
      description: |
        Retrieve lounges where the passenger's selected stop is within N stops of the lounge's location.
        
        **How it works:**
        - Lounge is registered with `stop_before_id` and `stop_after_id` (where lounge is located)
        - Query compares passenger's stop `stop_order` with lounge's stops `stop_order`
        - Returns lounges where `|passenger_stop_order - lounge_stop_order| <= distance`
        
        **Use Case:**
        - Passenger selects boarding stop "Colombo Fort" (stop_order: 1)
        - Lounge is between "Pettah" (stop_order: 2) and "Maradana" (stop_order: 3)
        - Distance = 2, so |1 - 2| = 1 ≤ 2 → Lounge is shown!
        
        **No authentication required** - public endpoint for passengers.
      operationId: getLoungesNearStop
      tags:
        - Lounge Marketplace
      security: []
      parameters:
        - name: routeId
          in: path
          required: true
          description: UUID of the master route
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
        - name: stopId
          in: path
          required: true
          description: UUID of the passenger's selected stop (boarding or alighting)
          schema:
            type: string
            format: uuid
            example: "660e8400-e29b-41d4-a716-446655440001"
        - name: distance
          in: query
          required: false
          description: Maximum stop distance (default 2)
          schema:
            type: integer
            default: 2
            minimum: 1
            maximum: 10
            example: 2
      responses:
        "200":
          description: Lounges near stop retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  lounges:
                    type: array
                    items:
                      $ref: "#/components/schemas/Lounge"
                  route_id:
                    type: string
                    format: uuid
                    description: The route ID queried
                  stop_id:
                    type: string
                    format: uuid
                    description: The passenger's stop ID queried
                  max_distance:
                    type: integer
                    description: Max stop distance used
                    example: 2
                  total:
                    type: integer
                    description: Number of lounges found
                    example: 3
        "400":
          description: Invalid route ID or stop ID format
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Lounge Staff Management Endpoints
  # ============================================================================
  /api/v1/lounges/{lounge_id}/staff:
    post:
      summary: Add staff to lounge (Not Implemented)
      description: |
        Step 3 (optional) - Add staff member to a specific lounge.
        Note: This feature is not yet implemented.
      operationId: addStaffToLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                lounge_id:
                  type: string
                  format: uuid
                phone:
                  type: string
                  example: "+94771234567"
                  description: "Staff's phone number for invitation"
      responses:
        "501":
          description: Feature not yet implemented
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "not_implemented"
                  message:
                    type: string
                    example: "Staff invitation feature not yet implemented"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Get staff for lounge
      description: Get all staff members assigned to a specific lounge
      operationId: getStaffByLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Staff list retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  staff:
                    type: array
                    items:
                      $ref: "#/components/schemas/LoungeStaff"
                  total:
                    type: integer
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Note: UpdateStaffPermission endpoint removed - permission_type field no longer exists
  # Use users.roles array for permission management instead

  /api/v1/lounges/{lounge_id}/staff/{staff_id}/status:
    put:
      summary: Update staff employment status
      description: Update staff employment status (active, inactive, suspended)
      operationId: updateStaffStatus
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: staff_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - employment_status
              properties:
                employment_status:
                  type: string
                  enum: ["active", "inactive", "terminated"]
      responses:
        "200":
          description: Status updated
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{lounge_id}/staff/{staff_id}:
    delete:
      summary: Remove staff from lounge
      description: Remove a staff member from the lounge (triggers will update counts)
      operationId: removeStaff
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: staff_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Staff removed successfully
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/my-profile:
    get:
      summary: Get staff member profile
      description: Staff members can view their assigned lounge and profile information
      operationId: getMyStaffProfile
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Staff profile retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/LoungeStaff"
                  - type: object
                    properties:
                      lounge:
                        type: object
                        properties:
                          id:
                            type: string
                            format: uuid
                          lounge_name:
                            type: string
                          address:
                            type: string
                          city:
                            type: string
                          status:
                            type: string
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Lounge Marketplace & Booking Endpoints
  # ============================================================================

  /api/v1/lounge-marketplace/categories:
    get:
      summary: Get lounge product categories
      description: |
        Retrieve all active product categories for lounge marketplace.
        Categories include: Food, Beverages, Snacks, Combo Meals, etc.
      operationId: getLoungeCategories
      tags:
        - Lounge Marketplace
      security: []
      responses:
        "200":
          description: Categories retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  categories:
                    type: array
                    items:
                      $ref: "#/components/schemas/LoungeCategory"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{lounge_id}/products:
    get:
      summary: Get lounge products
      description: |
        Retrieve all products available at a specific lounge.
        Can filter by category using query parameter.
      operationId: getLoungeProducts
      tags:
        - Lounge Products
      security: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: category_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Filter by category ID
      responses:
        "200":
          description: Products retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  products:
                    type: array
                    items:
                      $ref: "#/components/schemas/LoungeProduct"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Create lounge product
      description: |
        Add a new product to a lounge's menu.
        Requires lounge owner authentication.
      operationId: createLoungeProduct
      tags:
        - Lounge Products
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateLoungeProductRequest"
      responses:
        "201":
          description: Product created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Product created successfully"
                  product:
                    $ref: "#/components/schemas/LoungeProduct"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{lounge_id}/products/{product_id}:
    put:
      summary: Update lounge product
      description: |
        Update an existing product in a lounge's menu.
        Requires lounge owner authentication.
      operationId: updateLoungeProduct
      tags:
        - Lounge Products
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateLoungeProductRequest"
      responses:
        "200":
          description: Product updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Product updated successfully"
                  product:
                    $ref: "#/components/schemas/LoungeProduct"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete lounge product
      description: |
        Delete a product from a lounge's menu.
        Requires lounge owner authentication.
      operationId: deleteLoungeProduct
      tags:
        - Lounge Products
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Product deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Product deleted successfully"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-bookings:
    post:
      summary: Create lounge booking
      description: |
        Create a new lounge booking for a passenger.
        Can include guest list and pre-ordered items.
        
        **Pricing Types:**
        - 1 hour: Standard 1-hour access
        - 2 hours: Extended 2-hour access
        - 3 hours: Full 3-hour access  
        - until_bus: Access until bus departs
        
        **Booking Status Flow:**
        pending → confirmed → checked_in → completed
                          ↘ cancelled / no_show
      operationId: createLoungeBooking
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateLoungeBookingRequest"
      responses:
        "201":
          description: Booking created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Lounge booking created successfully"
                  booking:
                    $ref: "#/components/schemas/LoungeBooking"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Get my lounge bookings
      description: |
        Retrieve all lounge bookings for the authenticated passenger.
        Returns both upcoming and past bookings.
      operationId: getMyLoungeBookings
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [pending, confirmed, checked_in, completed, cancelled, no_show]
          description: Filter by booking status
      responses:
        "200":
          description: Bookings retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  bookings:
                    type: array
                    items:
                      $ref: "#/components/schemas/LoungeBooking"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-bookings/upcoming:
    get:
      summary: Get upcoming lounge bookings
      description: |
        Retrieve upcoming lounge bookings for the authenticated passenger.
        Only returns bookings with status pending, confirmed, or checked_in.
      operationId: getUpcomingLoungeBookings
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Upcoming bookings retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  bookings:
                    type: array
                    items:
                      $ref: "#/components/schemas/LoungeBooking"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-bookings/{id}:
    get:
      summary: Get lounge booking by ID
      description: |
        Retrieve detailed information about a specific lounge booking.
        Includes guest list and pre-ordered items.
      operationId: getLoungeBookingById
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Booking retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoungeBookingDetail"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-bookings/reference/{ref}:
    get:
      summary: Get lounge booking by reference
      description: |
        Retrieve a lounge booking by its booking reference number.
        Useful for QR code scanning and quick lookup.
      operationId: getLoungeBookingByReference
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: ref
          in: path
          required: true
          schema:
            type: string
          example: "LB-20250101-ABC123"
      responses:
        "200":
          description: Booking retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoungeBookingDetail"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-bookings/{id}/cancel:
    post:
      summary: Cancel lounge booking
      description: |
        Cancel an existing lounge booking.
        Only bookings with status 'pending' or 'confirmed' can be cancelled.
      operationId: cancelLoungeBooking
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  example: "Change of plans"
      responses:
        "200":
          description: Booking cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Booking cancelled successfully"
        "400":
          description: Cannot cancel booking in current status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{lounge_id}/bookings:
    get:
      summary: Get lounge bookings (Owner)
      description: |
        Retrieve all bookings for a specific lounge.
        Requires lounge owner authentication.
      operationId: getLoungeBookingsForOwner
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [pending, confirmed, checked_in, completed, cancelled, no_show]
        - name: date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Filter by booking date (YYYY-MM-DD)
      responses:
        "200":
          description: Bookings retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  bookings:
                    type: array
                    items:
                      $ref: "#/components/schemas/LoungeBookingDetail"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{lounge_id}/bookings/today:
    get:
      summary: Get today's lounge bookings (Owner)
      description: |
        Retrieve all bookings for today at a specific lounge.
        Useful for lounge staff dashboard.
      operationId: getTodayLoungeBookings
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Today's bookings retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  bookings:
                    type: array
                    items:
                      $ref: "#/components/schemas/LoungeBookingDetail"
                  total:
                    type: integer
                  checked_in_count:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-bookings/{id}/check-in:
    post:
      summary: Check-in guest at lounge
      description: |
        Check-in a guest at the lounge.
        Requires lounge owner or staff authentication.
        Can check-in individual guests from a group booking.
      operationId: checkInLoungeGuest
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                guest_id:
                  type: string
                  format: uuid
                  description: Optional - check-in specific guest. If not provided, checks in the primary booker.
      responses:
        "200":
          description: Check-in successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Guest checked in successfully"
                  checked_in_at:
                    type: string
                    format: date-time
        "400":
          description: Cannot check-in (wrong status, already checked-in, etc.)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-bookings/{id}/complete:
    post:
      summary: Complete lounge booking
      description: |
        Mark a lounge booking as completed.
        Requires lounge owner or staff authentication.
        Usually done when guest leaves or access time expires.
      operationId: completeLoungeBooking
      tags:
        - Lounge Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Booking completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Booking completed successfully"
                  completed_at:
                    type: string
                    format: date-time
        "400":
          description: Cannot complete booking (wrong status)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-orders:
    post:
      summary: Create lounge order
      description: |
        Create a new food/beverage order at a lounge.
        Can be linked to an existing lounge booking or standalone.
      operationId: createLoungeOrder
      tags:
        - Lounge Orders
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateLoungeOrderRequest"
      responses:
        "201":
          description: Order created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Order created successfully"
                  order:
                    $ref: "#/components/schemas/LoungeOrder"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-orders/{id}/status:
    put:
      summary: Update lounge order status
      description: |
        Update the status of a lounge order.
        Requires lounge owner or staff authentication.
        
        **Order Status Flow:**
        pending → preparing → ready → delivered
                           ↘ cancelled
      operationId: updateLoungeOrderStatus
      tags:
        - Lounge Orders
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [pending, preparing, ready, delivered, cancelled]
      responses:
        "200":
          description: Order status updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Order status updated successfully"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Master Routes Endpoints
  # ============================================================================
  /api/v1/master-routes:
    get:
      summary: Get all master routes
      description: Retrieve all active master routes for dropdown selection in permit forms
      operationId: getAllMasterRoutes
      tags:
        - Master Routes
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Master routes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  master_routes:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                          description: Unique identifier for the route
                        route_number:
                          type: string
                          description: Route number (e.g., "99-1")
                          example: "99-1"
                        route_name:
                          type: string
                          description: Name of the route
                          example: "Badulla - Colombo Express"
                        origin_city:
                          type: string
                          description: Starting city
                          example: "Badulla"
                        destination_city:
                          type: string
                          description: Ending city
                          example: "Colombo"
                        total_distance_km:
                          type: number
                          format: float
                          description: Total distance in kilometers
                          example: 230.5
                        estimated_duration_minutes:
                          type: integer
                          description: Estimated journey time in minutes
                          example: 360
                        display_label:
                          type: string
                          description: Formatted label for display in dropdown
                          example: "99-1 - Badulla → Colombo (230.5 km)"
                  count:
                    type: integer
                    description: Total number of routes returned
                    example: 1
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/master-routes/{id}:
    get:
      summary: Get master route by ID
      description: Retrieve detailed information about a specific master route
      operationId: getMasterRouteById
      tags:
        - Master Routes
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Master route ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Master route retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  route_number:
                    type: string
                    example: "99-1"
                  route_name:
                    type: string
                    example: "Badulla - Colombo Express"
                  origin_city:
                    type: string
                    example: "Badulla"
                  destination_city:
                    type: string
                    example: "Colombo"
                  total_distance_km:
                    type: number
                    format: float
                    example: 230.5
                  estimated_duration_minutes:
                    type: integer
                    example: 360
                  encoded_polyline:
                    type: string
                    description: Encoded polyline for map visualization
                  is_active:
                    type: boolean
                    example: true
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Permit Endpoints
  # ============================================================================
  /api/v1/permits:
    get:
      summary: Get all permits
      description: Retrieve all route permits for authenticated bus owner
      operationId: getAllPermits
      tags:
        - Permits
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Permits retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  permits:
                    type: array
                    items:
                      $ref: "#/components/schemas/RoutePermit"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Create new permit
      description: Create a new route permit
      operationId: createPermit
      tags:
        - Permits
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePermitRequest"
      responses:
        "201":
          description: Permit created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Permit created successfully
                  permit:
                    $ref: "#/components/schemas/RoutePermit"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/permits/valid:
    get:
      summary: Get valid permits
      description: Retrieve only valid (non-expired) route permits
      operationId: getValidPermits
      tags:
        - Permits
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Valid permits retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  permits:
                    type: array
                    items:
                      $ref: "#/components/schemas/RoutePermit"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/permits/{id}:
    get:
      summary: Get permit by ID
      description: Retrieve a specific route permit by ID
      operationId: getPermitById
      tags:
        - Permits
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Permit retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoutePermit"
        "404":
          description: Permit not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update permit
      description: Update an existing route permit
      operationId: updatePermit
      tags:
        - Permits
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePermitRequest"
      responses:
        "200":
          description: Permit updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Permit updated successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Permit not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete permit
      description: Delete a route permit
      operationId: deletePermit
      tags:
        - Permits
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Permit deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Permit deleted successfully
        "404":
          description: Permit not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/permits/{permitId}/route-details:
    get:
      summary: Get route details with polyline and stops
      description: Retrieve master route polyline and predefined stops for map visualization in schedule creation wizard
      operationId: getPermitRouteDetails
      tags:
        - Route Permits
      security:
        - BearerAuth: []
      parameters:
        - name: permitId
          in: path
          required: true
          description: Permit UUID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Route details retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  permit:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      permit_number:
                        type: string
                        example: "PER-2024-001"
                      route_name:
                        type: string
                        example: "Colombo - Kandy Express"
                  route:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      route_number:
                        type: string
                        example: "01"
                      route_name:
                        type: string
                        example: "Negombo - Kandy Intercity"
                      origin_city:
                        type: string
                        example: "Negombo"
                      destination_city:
                        type: string
                        example: "Kandy"
                      total_distance_km:
                        type: number
                        example: 107.3
                      estimated_duration_minutes:
                        type: integer
                        example: 180
                      encoded_polyline:
                        type: string
                        example: "ic~`Awr{xM}AkAaBsAcBqA..."
                        description: Google Maps encoded polyline string for route visualization
                  stops:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        master_route_id:
                          type: string
                          format: uuid
                        stop_name:
                          type: string
                          example: "Negombo Bus Stand"
                        stop_order:
                          type: integer
                          example: 1
                        latitude:
                          type: number
                          example: 7.2089
                        longitude:
                          type: number
                          example: 79.8358
                        arrival_time_offset_minutes:
                          type: integer
                          example: 0
                          description: Minutes from origin (0 for starting point)
                        is_major_stop:
                          type: boolean
                          example: true
                        created_at:
                          type: string
                          format: date-time
        "404":
          description: Permit not found or no master route associated
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "No master route associated with this permit"
                  message:
                    type: string
                    example: "This permit does not have route polyline data"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Access denied (not permit owner)
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Bus Endpoints
  # ============================================================================
  /api/v1/buses:
    get:
      summary: Get all buses
      description: Retrieve all buses owned by the authenticated bus owner
      operationId: getAllBuses
      tags:
        - Buses
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of buses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bus"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Create new bus
      description: Register a new bus under a route permit
      operationId: createBus
      tags:
        - Buses
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBusRequest"
      responses:
        "201":
          description: Bus created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "400":
          description: Invalid request or validation error
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Permit not found
        "409":
          description: Bus already registered under this permit
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/buses/{id}:
    get:
      summary: Get bus by ID
      description: Retrieve a specific bus by ID
      operationId: getBusById
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Bus details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Permission denied (bus belongs to another owner)
        "404":
          description: Bus not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update bus
      description: Update bus information
      operationId: updateBus
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateBusRequest"
      responses:
        "200":
          description: Bus updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "400":
          description: Invalid request
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Permission denied
        "404":
          description: Bus not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete bus
      description: Delete a bus
      operationId: deleteBus
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Bus deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Bus deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Bus not found or permission denied
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/buses/status/{status}:
    get:
      summary: Get buses by status
      description: Retrieve buses filtered by operational status
      operationId: getBusesByStatus
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: path
          required: true
          schema:
            type: string
            enum: [active, maintenance, inactive]
      responses:
        "200":
          description: List of buses with specified status
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bus"
        "400":
          description: Invalid status parameter
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Trip Schedule Endpoints
  # ============================================================================
  /api/v1/trip-schedules:
    post:
      summary: Create trip schedule
      description: |
        Create a new trip schedule template (timetable). 

        **Trip Generation:**
        - Trips are automatically generated for the next 7 days (configurable via system_settings.trip_generation_days_ahead)
        - Generation starts from `valid_from` if in the future, otherwise from current date
        - Only generates trips within the `valid_until` date if specified
        - Trips are created with proper `departure_datetime` (date + time combined)
        - Skips dates that don't match recurrence rules (daily/weekly/interval)

        **Validation:**
        - Departure time must be in HH:MM or HH:MM:SS format
        - Recurrence rules are validated (e.g., weekly requires recurrence_days)
        - Schedule must be active (is_active=true) for trip generation

        **Response includes:**
        - Created schedule object
        - Number of trips generated
        - Success message
      operationId: createTripSchedule
      tags:
        - Trip Schedules
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - permit_id
                - recurrence_type
                - departure_time
                - direction
                - trips_per_day
                - base_fare
                - valid_from
              properties:
                permit_id:
                  type: string
                  format: uuid
                bus_id:
                  type: string
                  format: uuid
                  description: "Default bus for this schedule"
                schedule_name:
                  type: string
                  example: "Morning Express"
                recurrence_type:
                  type: string
                  enum: [daily, weekly, specific_dates]
                recurrence_days:
                  type: array
                  items:
                    type: integer
                    minimum: 0
                    maximum: 6
                  description: "Days of week: 0=Sunday, 6=Saturday (for weekly)"
                specific_dates:
                  type: array
                  items:
                    type: string
                    format: date
                  description: "List of specific dates (for specific_dates type)"
                departure_time:
                  type: string
                  example: "08:00:00"
                estimated_duration_minutes:
                  type: integer
                  minimum: 1
                  example: 420
                  description: "Estimated trip duration in minutes (optional - will be calculated from route if not provided)"
                is_overnight_trip:
                  type: boolean
                  default: false
                  description: "Indicates if the bus arrives the next day (e.g., departs 10 PM, arrives 5 AM). Used to calculate duration accurately."
                direction:
                  type: string
                  enum: [UP, DOWN, ROUND_TRIP]
                  example: "UP"
                  description: "Trip direction: UP (origin to destination), DOWN (destination to origin), or ROUND_TRIP (both)"
                trips_per_day:
                  type: integer
                  minimum: 1
                  maximum: 10
                  example: 2
                  description: "Number of trips per day (1-10)"
                base_fare:
                  type: number
                  format: double
                is_bookable:
                  type: boolean
                  default: true
                max_bookable_seats:
                  type: integer
                  example: 45
                  description: "Maximum seats available for booking"
                advance_booking_hours:
                  type: integer
                  default: 24
                  description: "How many hours in advance booking is allowed"
                default_driver_id:
                  type: string
                  format: uuid
                  description: "Default driver for trips"
                default_conductor_id:
                  type: string
                  format: uuid
                  description: "Default conductor for trips"
                selected_stop_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: "Selected master route stops for this schedule"
                valid_from:
                  type: string
                  format: date
                valid_until:
                  type: string
                  format: date
                notes:
                  type: string
      responses:
        "201":
          description: Schedule created and trips generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  schedule:
                    $ref: "#/components/schemas/TripSchedule"
                  trips_generated:
                    type: integer
                    example: 14
                  message:
                    type: string
                    example: "Schedule created successfully"
        "400":
          description: Invalid input
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Get all trip schedules
      description: Retrieve all trip schedules for the authenticated bus owner
      operationId: getAllTripSchedules
      tags:
        - Trip Schedules
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of trip schedules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TripSchedule"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/trip-schedules/{id}:
    get:
      summary: Get trip schedule by ID
      description: Retrieve a specific trip schedule
      operationId: getTripScheduleById
      tags:
        - Trip Schedules
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Trip schedule details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TripSchedule"
        "404":
          description: Schedule not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update trip schedule
      description: Update an existing trip schedule and regenerate trips
      operationId: updateTripSchedule
      tags:
        - Trip Schedules
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                recurrence_type:
                  type: string
                  enum: [daily, weekly, specific_dates]
                recurrence_days:
                  type: array
                  items:
                    type: integer
                departure_time:
                  type: string
                base_fare:
                  type: number
                is_bookable:
                  type: boolean
                valid_until:
                  type: string
                  format: date
      responses:
        "200":
          description: Schedule updated successfully
        "404":
          description: Schedule not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Scheduled Trip Endpoints
  # ============================================================================
  /api/v1/scheduled-trips:
    get:
      summary: Get scheduled trips by date range
      description: |
        Retrieve scheduled trips within a specified date range for the authenticated bus owner.

        **Updated Logic (includes special trips):**
        1. Gets bus_owner_id from authenticated user
        2. Queries trip_schedules table: WHERE bus_owner_id = X
        3. Extracts schedule IDs
        4. Queries scheduled_trips WHERE trip_schedule_id IN (...) AND DATE(departure_datetime) BETWEEN start AND end
        5. **ALSO queries special trips**: WHERE trip_schedule_id IS NULL AND bus_owner_route_id belongs to owner AND date in range
        6. Combines both result sets

        This ensures ALL trips are returned:
        - Trips generated from timetables/schedules
        - Special one-time trips (created via /api/v1/special-trips)

        All trips include route information (origin city, destination city, route number, direction)
        joined from bus_owner_routes and master_routes tables.
      operationId: getScheduledTrips
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date
          example: "2025-11-01"
        - name: end_date
          in: query
          required: true
          schema:
            type: string
            format: date
          example: "2025-11-15"
      responses:
        "200":
          description: List of scheduled trips (includes both schedule-based and special trips)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ScheduledTrip"
        "400":
          description: Invalid date range
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}:
    get:
      summary: Get scheduled trip by ID
      description: Retrieve details of a specific scheduled trip
      operationId: getScheduledTripById
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Scheduled trip details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScheduledTrip"
        "404":
          description: Trip not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    patch:
      summary: Update scheduled trip
      description: |
        Update scheduled trip details including:
        - Staff assignment (driver, conductor)
        - Trip status
        - Route override (with validation)

        **Route Override Rules:**
        When updating `bus_owner_route_id`, the new route must:
        - Use the same master_route_id as the schedule's route
        - Have the same direction (UP/DOWN) as the schedule's route
        - Be valid for the assigned permit (if permit is assigned)

        Route overrides allow trips to use different stop selections while maintaining the same master route and direction.
      operationId: updateScheduledTrip
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                bus_owner_route_id:
                  type: string
                  format: uuid
                  description: |
                    Optional route override. Must match schedule's master route and direction.
                    Validated against business rules before accepting.
                assigned_driver_id:
                  type: string
                  format: uuid
                  description: Assign or update the driver for this trip
                assigned_conductor_id:
                  type: string
                  format: uuid
                  description: Assign or update the conductor for this trip
                status:
                  type: string
                  enum:
                    [scheduled, confirmed, in_progress, completed, cancelled]
                  description: Update the trip status
      responses:
        "200":
          description: Trip updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScheduledTrip"
        "400":
          description: Validation failed (e.g., route override rejected due to mismatched master route or direction)
        "404":
          description: Trip not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/publish:
    put:
      summary: Publish a scheduled trip for booking
      description: |
        Make a scheduled trip available for passenger booking by setting is_bookable=true. 
        Only the trip owner can publish their trips.

        **Requirements**:
        - Trip MUST have seat_layout_id assigned before publishing
        - Attempting to publish without seat_layout_id will fail with error
        - Once published, ever_published flag is set to true permanently

        **Validation**:
        The system validates that seat_layout_id IS NOT NULL before allowing publish.
        Use the `/scheduled-trips/{id}/assign-seat-layout` endpoint to assign a seat 
        layout before publishing.
      operationId: publishScheduledTrip
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the trip to publish
      responses:
        "200":
          description: Trip published successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Trip published successfully"
                  trip_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
        "400":
          description: |
            Validation failed:
            - Invalid trip ID format
            - Seat layout not assigned (seat_layout_id is NULL)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "cannot publish trip: seat layout must be assigned before publishing"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Only bus owners can publish trips
        "404":
          description: Trip not found or access denied
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/unpublish:
    put:
      summary: Remove a scheduled trip from booking
      description: Remove a scheduled trip from passenger booking by setting is_bookable=false. Only the trip owner can unpublish their trips.
      operationId: unpublishScheduledTrip
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the trip to unpublish
      responses:
        "200":
          description: Trip unpublished successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Trip unpublished successfully"
                  trip_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
        "400":
          description: Invalid trip ID
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Only bus owners can unpublish trips
        "404":
          description: Trip not found or access denied
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/assign:
    patch:
      summary: Assign staff and permit to a scheduled trip
      description: |
        Assign driver, conductor, and/or route permit to a scheduled trip.

        Ownership Verification:
        - Trip must have either trip_schedule_id OR bus_owner_route_id to verify ownership
        - Only the bus owner who created the trip can assign staff/permits
        - Detailed logs are generated for debugging ownership verification failures

        This endpoint validates:
        - Staff belongs to the bus owner's organization
        - Staff has correct type (driver/conductor) and is actively employed
        - Staff licenses are not expired on trip date
        - Permit status must be "verified" (not "pending" or "rejected")
        - Permit is valid on trip date (not expired)
        - Permit covers the trip's route

        Error Logging:
        - Logs trip ownership details (trip_schedule_id, bus_owner_route_id)
        - Logs schedule and route ownership verification steps
        - Helps diagnose ownership verification failures
      operationId: assignStaffAndPermit
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the trip to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                driver_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: UUID of the driver to assign
                  example: "123e4567-e89b-12d3-a456-426614174000"
                conductor_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: UUID of the conductor to assign
                  example: "123e4567-e89b-12d3-a456-426614174001"
                permit_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: UUID of the route permit to assign
                  example: "123e4567-e89b-12d3-a456-426614174002"
              example:
                driver_id: "123e4567-e89b-12d3-a456-426614174000"
                conductor_id: "123e4567-e89b-12d3-a456-426614174001"
                permit_id: "123e4567-e89b-12d3-a456-426614174002"
      responses:
        "200":
          description: Staff and permit assigned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Staff and permit assigned successfully"
                  trip:
                    $ref: "#/components/schemas/ScheduledTrip"
        "400":
          description: |
            Invalid request body, or validation failed:
            - At least one field (driver_id, conductor_id, permit_id) must be provided
            - Trip has no schedule or route link (cannot determine ownership)
            - Staff not found or wrong type
            - Staff not actively employed
            - License expired on trip date
            - Permit status is not "verified" (must be verified, not pending/rejected)
            - Permit is expired on trip date
            - Permit doesn't cover the route
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Driver's license will be expired on trip date"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: |
            Access denied:
            - Only bus owners can assign staff and permits
            - Staff or permit does not belong to your organization
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Driver does not belong to your organization"
        "404":
          description: Trip not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/assign-seat-layout:
    patch:
      summary: Assign seat layout template to a scheduled trip
      description: |
        Assign a seat layout template to a specific scheduled trip. 

        **Business Context**:
        In Sri Lanka, buses change frequently on the same route, so seat layouts 
        are assigned per trip rather than per bus. Each trip needs its own seat 
        layout assignment before it can be published for booking.

        **Requirements**:
        - Only the bus owner who owns the trip can assign seat layouts
        - Seat layout must be assigned before trip can be published (is_bookable=true)
        - Attempting to publish without seat_layout_id will fail with validation error

        **Database Constraint**:
        A check constraint enforces that if is_bookable=true, then seat_layout_id 
        must NOT be NULL.
      operationId: assignSeatLayout
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the trip to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - seat_layout_id
              properties:
                seat_layout_id:
                  type: string
                  format: uuid
                  description: UUID of the seat layout template to assign
                  example: "550e8400-e29b-41d4-a716-446655440001"
              example:
                seat_layout_id: "550e8400-e29b-41d4-a716-446655440001"
      responses:
        "200":
          description: Seat layout assigned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Seat layout assigned successfully"
                  trip:
                    $ref: "#/components/schemas/ScheduledTrip"
        "400":
          description: |
            Invalid request body:
            - seat_layout_id is required
            - Trip has no schedule link (cannot determine ownership)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid request body"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: |
            Access denied:
            - Only bus owners can assign seat layouts
            - Trip does not belong to your organization
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Unauthorized to modify this trip"
        "404":
          description: Trip not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/bulk-publish:
    post:
      summary: Bulk publish scheduled trips for booking
      description: |
        Publish multiple scheduled trips at once by setting is_bookable=true. 
        Only the trip owner can publish their trips.

        **Requirements**:
        - ALL trips MUST have seat_layout_id assigned before bulk publishing
        - If ANY trip is missing seat_layout_id, the entire operation fails
        - No partial publishing - either all trips succeed or none

        **Validation**:
        The system validates that ALL trips have seat_layout_id assigned. If any trip 
        is missing a seat layout, the operation fails with an error indicating how many 
        trips need seat layouts assigned.
      operationId: bulkPublishScheduledTrips
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - trip_ids
              properties:
                trip_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: Array of trip IDs to publish
                  example:
                    [
                      "123e4567-e89b-12d3-a456-426614174000",
                      "123e4567-e89b-12d3-a456-426614174001",
                    ]
      responses:
        "200":
          description: Trips published successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Trips published successfully"
                  published_count:
                    type: integer
                    description: Number of trips actually published
                    example: 5
                  requested_count:
                    type: integer
                    description: Number of trip IDs requested
                    example: 5
        "400":
          description: |
            Validation failed:
            - Invalid request body or no trip IDs provided
            - One or more trips missing seat_layout_id assignment
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "cannot publish 3 trip(s) without seat layout assigned"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Only bus owners can publish trips
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/bulk-unpublish:
    post:
      summary: Bulk remove scheduled trips from booking
      description: Remove multiple scheduled trips from booking by setting is_bookable=false. Only the trip owner can unpublish their trips.
      operationId: bulkUnpublishScheduledTrips
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - trip_ids
              properties:
                trip_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: Array of trip IDs to unpublish
                  example:
                    [
                      "123e4567-e89b-12d3-a456-426614174000",
                      "123e4567-e89b-12d3-a456-426614174001",
                    ]
      responses:
        "200":
          description: Trips unpublished successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Trips unpublished successfully"
                  unpublished_count:
                    type: integer
                    description: Number of trips actually unpublished
                    example: 3
                  requested_count:
                    type: integer
                    description: Number of trip IDs requested
                    example: 3
        "400":
          description: Invalid request body or no trip IDs provided
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Only bus owners can unpublish trips
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bookable-trips:
    get:
      summary: Get bookable trips (Public)
      description: Public endpoint to get available trips for booking by passengers
      operationId: getBookableTrips
      tags:
        - Scheduled Trips
      security: []
      parameters:
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: origin
          in: query
          schema:
            type: string
        - name: destination
          in: query
          schema:
            type: string
      responses:
        "200":
          description: List of bookable trips
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ScheduledTrip"
        "400":
          description: Invalid parameters
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # TRIP SEATS ENDPOINTS (Seat Management for Scheduled Trips)
  # ============================================================================
  /api/v1/scheduled-trips/{id}/seats:
    get:
      summary: Get all seats for a scheduled trip
      description: |
        Returns all seats for a scheduled trip with booking information.

        **Response includes:**
        - All seats with their current status (available, booked, blocked, reserved)
        - Booking info for booked seats (passenger name, phone, reference)
        - Summary of seat availability counts

        **Business Context:**
        Bus owners use this to view the seat map and see which seats are available,
        booked via the app, or manually booked via phone/agent/walk-in.
      operationId: getTripSeats
      tags:
        - Trip Seats
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the scheduled trip
      responses:
        "200":
          description: Seats retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  seats:
                    type: array
                    items:
                      $ref: "#/components/schemas/TripSeatWithBookingInfo"
                  summary:
                    $ref: "#/components/schemas/TripSeatSummary"
        "400":
          description: Trip ID is required
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/seats/summary:
    get:
      summary: Get seat availability summary for a trip
      description: |
        Returns a summary of seat availability counts without full seat details.
        Useful for quick availability checks in list views.
      operationId: getTripSeatSummary
      tags:
        - Trip Seats
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the scheduled trip
      responses:
        "200":
          description: Summary retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TripSeatSummary"
        "400":
          description: Trip ID is required
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/seats/create:
    post:
      summary: Create trip seats from a seat layout template
      description: |
        Creates trip_seats records from a seat layout template.

        **Business Context:**
        When a bus owner assigns a seat layout to a trip, this endpoint creates
        individual seat records that can be booked. Each seat gets:
        - Seat number, row, position from the template
        - Base fare from the request (can be adjusted later)
        - Status: 'available'

        **Note:** If seats already exist for this trip, they will be deleted
        and recreated from the new layout.
      operationId: createTripSeats
      tags:
        - Trip Seats
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the scheduled trip
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTripSeatsRequest"
      responses:
        "201":
          description: Seats created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Trip seats created successfully"
                  seats_count:
                    type: integer
                    example: 49
        "400":
          description: Invalid request
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/seats/block:
    post:
      summary: Block one or more seats
      description: |
        Block seats to prevent them from being booked.

        **Use Cases:**
        - Reserve seats for VIPs before publishing
        - Block damaged/broken seats
        - Hold seats temporarily for phone reservations

        **Note:** Only available seats can be blocked.
      operationId: blockSeats
      tags:
        - Trip Seats
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the scheduled trip
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BlockSeatsRequest"
      responses:
        "200":
          description: Seats blocked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Seats blocked successfully"
                  blocked_count:
                    type: integer
                    example: 2
        "400":
          description: Invalid seat IDs or seats not available
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/seats/unblock:
    post:
      summary: Unblock one or more seats
      description: |
        Release blocked seats to make them available for booking again.

        **Note:** Only blocked seats can be unblocked.
      operationId: unblockSeats
      tags:
        - Trip Seats
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the scheduled trip
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UnblockSeatsRequest"
      responses:
        "200":
          description: Seats unblocked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Seats unblocked successfully"
                  unblocked_count:
                    type: integer
                    example: 2
        "400":
          description: Invalid seat IDs or seats not blocked
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/seats/price:
    put:
      summary: Update prices for specific seats
      description: |
        Update the price for one or more seats.

        **Use Cases:**
        - Premium pricing for window seats
        - Discounted pricing for less desirable seats
        - Dynamic pricing based on demand
      operationId: updateSeatPrices
      tags:
        - Trip Seats
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the scheduled trip
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateSeatPriceRequest"
      responses:
        "200":
          description: Prices updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Seat prices updated successfully"
                  updated_count:
                    type: integer
                    example: 4
        "400":
          description: Invalid seat IDs
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # ROUTE STOPS ENDPOINT (For Manual Booking Dropdowns)
  # ============================================================================
  /api/v1/scheduled-trips/{id}/route-stops:
    get:
      summary: Get route stops for a scheduled trip
      description: |
        Returns all stops for the route associated with a scheduled trip.
        Used to populate boarding/alighting stop dropdowns when creating manual bookings.
      operationId: getTripRouteStops
      tags:
        - Manual Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the scheduled trip
      responses:
        "200":
          description: Route stops retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/RouteStopDetail"
        "400":
          description: Trip ID is required or invalid
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Trip or route not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # MANUAL BOOKINGS ENDPOINTS (Phone/Agent/Walk-in Bookings)
  # ============================================================================
  /api/v1/scheduled-trips/{id}/manual-bookings:
    get:
      summary: List all manual bookings for a trip
      description: |
        Returns all manual (phone/agent/walk-in) bookings for a scheduled trip.
        Includes seat details for each booking.
      operationId: getManualBookings
      tags:
        - Manual Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the scheduled trip
      responses:
        "200":
          description: Bookings retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ManualBookingWithSeats"
        "400":
          description: Trip ID is required
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Create a manual booking (phone/agent/walk-in)
      description: |
        Create a booking for a passenger who is not using the app.

        **Booking Types:**
        - `phone`: Phone reservation (passenger called to book)
        - `agent`: Agent booking (travel agent made the booking)
        - `walk_in`: Walk-in booking (passenger arrived in person)

        **Booking Reference Format:**
        - Phone: `PH-YYYYMMDD-XXX` (e.g., PH-20251206-001)
        - Agent: `AG-YYYYMMDD-XXX` (e.g., AG-20251206-001)
        - Walk-in: `WI-YYYYMMDD-XXX` (e.g., WI-20251206-001)

        **Payment Status:**
        - `pending`: Payment not yet received
        - `partial`: Partial payment received
        - `paid`: Fully paid
        - `collect_on_bus`: Payment to be collected by conductor
        - `free`: Complimentary booking
      operationId: createManualBooking
      tags:
        - Manual Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the scheduled trip
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateManualBookingRequest"
      responses:
        "201":
          description: Booking created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ManualBookingWithSeats"
        "400":
          description: |
            Invalid request:
            - Seats not found
            - Seats not available
            - Seats don't belong to this trip
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/manual-bookings/{id}:
    get:
      summary: Get a manual booking by ID
      description: Returns a single manual booking with seat details.
      operationId: getManualBooking
      tags:
        - Manual Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the manual booking
      responses:
        "200":
          description: Booking retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ManualBookingWithSeats"
        "404":
          description: Booking not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Cancel a manual booking
      description: |
        Cancel a manual booking and release the seats.

        **Note:** Seats are automatically made available again.
      operationId: cancelManualBooking
      tags:
        - Manual Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the manual booking
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Reason for cancellation
                  example: "Passenger no-show"
      responses:
        "200":
          description: Booking cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Booking cancelled successfully"
        "404":
          description: Booking not found or already cancelled
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/manual-bookings/reference/{ref}:
    get:
      summary: Get a manual booking by reference number
      description: |
        Look up a booking by its reference number (e.g., PH-20251206-001).
        Useful for quick lookup when passenger provides their booking reference.
      operationId: getManualBookingByReference
      tags:
        - Manual Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: ref
          in: path
          required: true
          schema:
            type: string
          description: Booking reference (e.g., PH-20251206-001)
          example: "PH-20251206-001"
      responses:
        "200":
          description: Booking retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ManualBookingWithSeats"
        "404":
          description: Booking not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/manual-bookings/{id}/payment:
    put:
      summary: Update payment information for a booking
      description: |
        Update the payment status and details for a manual booking.

        **Payment Methods:**
        - `cash`: Cash payment
        - `card`: Card payment
        - `bank_transfer`: Bank transfer
        - `online`: Online payment
      operationId: updateManualBookingPayment
      tags:
        - Manual Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the manual booking
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateManualBookingPaymentRequest"
      responses:
        "200":
          description: Payment updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Payment updated successfully"
        "400":
          description: Invalid request
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/manual-bookings/{id}/status:
    put:
      summary: Update booking status
      description: |
        Update the status of a manual booking (e.g., check-in, board).

        **Status Flow:**
        `confirmed` → `checked_in` → `boarded` → `completed`

        Or: `confirmed` → `no_show` (if passenger doesn't show up)
      operationId: updateManualBookingStatus
      tags:
        - Manual Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the manual booking
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [confirmed, checked_in, boarded, completed, no_show]
                  example: "checked_in"
      responses:
        "200":
          description: Status updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Status updated successfully"
        "400":
          description: Invalid status
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/manual-bookings/search:
    get:
      summary: Search manual bookings by passenger phone
      description: |
        Search for manual bookings by passenger phone number.
        Returns all bookings (active and past) for the given phone.
      operationId: searchManualBookingsByPhone
      tags:
        - Manual Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: phone
          in: query
          required: true
          schema:
            type: string
          description: Passenger phone number
          example: "0771234567"
      responses:
        "200":
          description: Bookings retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ManualSeatBooking"
        "400":
          description: Phone number is required
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # APP BOOKINGS ENDPOINTS (Passenger App Bookings)
  # ============================================================================
  /api/v1/bookings:
    post:
      summary: Create a new bus booking
      description: |
        Create a new bus booking with seat selection from the passenger app.

        **Flow:**
        1. Passenger selects trip and available seats
        2. App submits booking with passenger details for each seat
        3. System validates seat availability
        4. System creates booking record with QR code
        5. Returns booking with QR code for boarding
      operationId: createAppBooking
      tags:
        - App Bookings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAppBookingRequest"
      responses:
        "201":
          description: Booking created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BookingResponse"
        "400":
          description: Invalid request (missing fields, invalid trip, etc.)
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Seats not available (already booked)
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Get my bookings
      description: Get all bookings for the authenticated passenger, paginated.
      operationId: getMyBookings
      tags:
        - App Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: Maximum number of bookings to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Number of bookings to skip
      responses:
        "200":
          description: Bookings retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  bookings:
                    type: array
                    items:
                      $ref: "#/components/schemas/BookingListItem"
                  limit:
                    type: integer
                  offset:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bookings/upcoming:
    get:
      summary: Get upcoming bookings
      description: Get upcoming (not departed) bookings for the authenticated passenger.
      operationId: getUpcomingBookings
      tags:
        - App Bookings
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Upcoming bookings retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  bookings:
                    type: array
                    items:
                      $ref: "#/components/schemas/BookingListItem"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bookings/{id}:
    get:
      summary: Get booking by ID
      description: Get booking details by ID. Only the booking owner can access.
      operationId: getBookingById
      tags:
        - App Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Booking ID
      responses:
        "200":
          description: Booking retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MasterBooking"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Not authorized to view this booking
        "404":
          description: Booking not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bookings/reference/{reference}:
    get:
      summary: Get booking by reference
      description: Get booking details by booking reference (e.g., BL-20250106-A1B2C3).
      operationId: getBookingByReference
      tags:
        - App Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: reference
          in: path
          required: true
          schema:
            type: string
          description: Booking reference
          example: "BL-20250106-A1B2C3"
      responses:
        "200":
          description: Booking retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MasterBooking"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Not authorized to view this booking
        "404":
          description: Booking not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bookings/{id}/confirm-payment:
    post:
      summary: Confirm payment for booking
      description: |
        Confirm payment for a booking after payment gateway callback.
        Updates booking status to confirmed.
      operationId: confirmPayment
      tags:
        - App Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Booking ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfirmPaymentRequest"
      responses:
        "200":
          description: Payment confirmed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Payment confirmed successfully"
                  booking_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: "confirmed"
        "400":
          description: Payment already confirmed
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Not authorized
        "404":
          description: Booking not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bookings/{id}/cancel:
    post:
      summary: Cancel booking
      description: |
        Cancel a booking and release booked seats.
        Seats will become available again for booking.
      operationId: cancelBooking
      tags:
        - App Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Booking ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Optional cancellation reason
      responses:
        "200":
          description: Booking cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Booking cancelled successfully"
                  booking_id:
                    type: string
                    format: uuid
                  refund_needed:
                    type: boolean
                  refund_amount:
                    type: number
        "400":
          description: Booking cannot be cancelled (already completed, etc.)
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Not authorized
        "404":
          description: Booking not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bookings/{id}/qr:
    get:
      summary: Get booking QR code
      description: Get QR code data for boarding verification.
      operationId: getBookingQR
      tags:
        - App Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Booking ID
      responses:
        "200":
          description: QR code data retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  qr_code:
                    type: string
                    description: QR code data to display
                  booking_reference:
                    type: string
                  passenger_name:
                    type: string
                  route_name:
                    type: string
                  departure_datetime:
                    type: string
                    format: date-time
                  seats:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Not authorized
        "404":
          description: Booking or QR code not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # STAFF BOOKINGS ENDPOINTS (Conductor/Driver Operations)
  # ============================================================================
  /api/v1/staff/bookings/verify:
    post:
      summary: Verify booking by QR code
      description: |
        Conductor/Driver scans passenger QR code to verify booking.
        Returns booking details including passenger info and seat assignments.
      operationId: verifyBookingByQR
      tags:
        - Staff Bookings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - qr_code
              properties:
                qr_code:
                  type: string
                  description: QR code data scanned from passenger's phone
      responses:
        "200":
          description: Booking verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerifyBookingResponse"
        "400":
          description: Invalid QR code
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Booking not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/bookings/check-in:
    post:
      summary: Check-in passenger
      description: |
        Conductor marks passenger as checked-in (ticket verified).
        Can check-in entire bus booking or specific seat.
      operationId: checkInPassenger
      tags:
        - Staff Bookings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bus_booking_id
              properties:
                bus_booking_id:
                  type: string
                  format: uuid
                  description: Bus booking ID to check-in
                seat_id:
                  type: string
                  format: uuid
                  description: Optional specific seat to check-in
      responses:
        "200":
          description: Checked-in successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Booking checked in successfully"
                  bus_booking_id:
                    type: string
                    format: uuid
        "400":
          description: Invalid request
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/bookings/board:
    post:
      summary: Board passenger
      description: Conductor marks specific seat as boarded (passenger is on the bus).
      operationId: boardPassenger
      tags:
        - Staff Bookings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - seat_id
              properties:
                seat_id:
                  type: string
                  format: uuid
                  description: Seat booking ID to mark as boarded
      responses:
        "200":
          description: Passenger boarded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Passenger boarded successfully"
                  seat_id:
                    type: string
                    format: uuid
        "400":
          description: Invalid request
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/bookings/no-show:
    post:
      summary: Mark no-show
      description: Conductor marks passenger as no-show (didn't show up).
      operationId: markNoShow
      tags:
        - Staff Bookings
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - seat_id
              properties:
                seat_id:
                  type: string
                  format: uuid
                  description: Seat booking ID to mark as no-show
      responses:
        "200":
          description: Marked as no-show successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Passenger marked as no-show"
                  seat_id:
                    type: string
                    format: uuid
        "400":
          description: Invalid request
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/trips/{trip_id}/bookings:
    get:
      summary: Get trip bookings
      description: |
        Get all bookings for a scheduled trip.
        Returns booking list with stats (total booked, checked-in, boarded, no-show).
      operationId: getTripBookings
      tags:
        - Staff Bookings
      security:
        - BearerAuth: []
      parameters:
        - name: trip_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Scheduled trip ID
      responses:
        "200":
          description: Trip bookings retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  bookings:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusBooking"
                  total_booked:
                    type: integer
                    description: Total seats booked
                  checked_in:
                    type: integer
                    description: Seats checked-in
                  boarded:
                    type: integer
                    description: Passengers boarded
                  no_show:
                    type: integer
                    description: No-shows
                  booking_count:
                    type: integer
                    description: Number of booking records
        "400":
          description: Trip ID is required
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # BOOKING ORCHESTRATION ENDPOINTS (Intent → Payment → Confirm)
  # ============================================================================
  /api/v1/booking/intent:
    post:
      summary: Create booking intent
      description: |
        Creates a booking intent with TTL-based seat/lounge holding.
        
        **Flow:**
        1. Validates seat/lounge availability
        2. Creates temporary holds (10 min TTL)
        3. Returns intent ID for payment initiation
        
        **Intent Types:**
        - `bus_only`: Only bus seats
        - `lounge_only`: Only lounge booking (pre or post trip)
        - `bus_with_lounge`: Bus + lounge(s)
        
        **Important:**
        - Seats are held for 10 minutes
        - Payment must be initiated before expiry
        - Use idempotency_key to prevent duplicates
      operationId: createBookingIntent
      tags:
        - Booking Orchestration
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBookingIntentRequest"
      responses:
        "201":
          description: Intent created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BookingIntentResponse"
        "400":
          description: Validation error or seats unavailable
        "409":
          description: Partial availability - some items unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartialAvailabilityError"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/booking/intents:
    get:
      summary: Get my booking intents
      description: Returns all booking intents for the authenticated user
      operationId: getMyBookingIntents
      tags:
        - Booking Orchestration
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: Number of results to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Offset for pagination
      responses:
        "200":
          description: Intents retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  intents:
                    type: array
                    items:
                      $ref: "#/components/schemas/BookingIntent"
                  limit:
                    type: integer
                  offset:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/booking/intent/{intent_id}:
    get:
      summary: Get intent status
      description: Returns current status and details of a booking intent
      operationId: getBookingIntentStatus
      tags:
        - Booking Orchestration
      security:
        - BearerAuth: []
      parameters:
        - name: intent_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Booking intent ID
      responses:
        "200":
          description: Intent status retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetIntentStatusResponse"
        "404":
          description: Intent not found
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/booking/intent/{intent_id}/initiate-payment:
    post:
      summary: Initiate payment for intent
      description: |
        Generates payment reference and returns payment gateway details.
        Must be called before intent expires (10 min TTL).
      operationId: initiateBookingPayment
      tags:
        - Booking Orchestration
      security:
        - BearerAuth: []
      parameters:
        - name: intent_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Booking intent ID
      responses:
        "200":
          description: Payment initiated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InitiatePaymentResponse"
        "400":
          description: Intent expired or invalid state
        "404":
          description: Intent not found
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/booking/intent/{intent_id}/cancel:
    post:
      summary: Cancel booking intent
      description: Cancels intent and releases all held seats/lounges
      operationId: cancelBookingIntent
      tags:
        - Booking Orchestration
      security:
        - BearerAuth: []
      parameters:
        - name: intent_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Booking intent ID
      responses:
        "200":
          description: Intent cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Booking intent cancelled successfully"
                  intent_id:
                    type: string
                    format: uuid
        "400":
          description: Cannot cancel confirmed intent
        "404":
          description: Intent not found
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/booking/confirm:
    post:
      summary: Confirm booking after payment
      description: |
        Creates actual bookings from the intent after successful payment.
        
        **Process:**
        1. Verifies payment reference
        2. Creates bus booking (if applicable)
        3. Creates lounge booking(s) (if applicable)
        4. Converts held seats to booked
        5. Returns booking references
      operationId: confirmBooking
      tags:
        - Booking Orchestration
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfirmBookingRequest"
      responses:
        "200":
          description: Booking confirmed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfirmBookingResponse"
        "400":
          description: Intent expired or invalid state
        "402":
          description: Payment not verified
        "404":
          description: Intent not found
        "409":
          description: Seats no longer available
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/payments/webhook:
    post:
      summary: PAYable payment gateway webhook (with audit trail)
      description: |
        Called by PAYable IPG to notify of payment status.
        
        PAYable sends the uid and statusIndicator as query parameters.
        The backend then calls PAYable's CheckStatus API to verify the payment result.
        
        **Industry-Standard Features:**
        - Full audit trail logged to `payment_audits` table
        - Idempotency (duplicate webhooks are detected and ignored)
        - Amount verification (expected vs received)
        - Correlation ID for request tracing
        
        **Flow:**
        1. PAYable calls this endpoint with uid and statusIndicator query params
        2. Backend logs webhook receipt to audit table
        3. Backend calls PAYable CheckStatus API to get payment result
        4. Amount verification: expected amount must match received amount
        5. If payment successful AND amounts match, booking is auto-confirmed
        6. All events logged to payment_audits for compliance/debugging
        
        **Security:**
        - No JWT authentication (public endpoint)
        - Payment verification done via PAYable CheckStatus API
        - Amount mismatch blocks booking confirmation
        
        **Audit Events Logged:**
        - `webhook_received` - Initial webhook receipt
        - `status_check_request` - Request to PAYable CheckStatus API
        - `status_check_response` - Response from PAYable (raw body stored)
        - `payment_success` / `payment_failed` - Payment outcome
        - `booking_confirmed` / `booking_confirmation_failed` - Booking result
      operationId: paymentWebhook
      tags:
        - Booking Orchestration
      security: []
      parameters:
        - name: uid
          in: query
          required: true
          schema:
            type: string
          description: PAYable unique payment identifier
          example: "B51811BC-3327-4C7A-8BA5-D7AA6DE46C00"
        - name: statusIndicator
          in: query
          required: true
          schema:
            type: string
          description: PAYable status indicator token for CheckStatus API
          example: "iDDZpzyKgs"
        - name: X-Correlation-ID
          in: header
          required: false
          schema:
            type: string
          description: Optional correlation ID for distributed tracing (auto-generated if not provided)
      responses:
        "200":
          description: Webhook processed (check response body for outcome)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "webhook processed successfully"
                  status:
                    type: string
                    enum: [acknowledged, confirmed, payment_failed]
                    example: "confirmed"
                  correlation_id:
                    type: string
                    description: Unique ID for tracing this request through audit logs
                    example: "550e8400-e29b-41d4-a716-446655440000"
                  booking_reference:
                    type: string
                    description: Master booking reference (only if status=confirmed)
                    example: "BK-20251218-ABC123"
                  duplicate:
                    type: boolean
                    description: True if this webhook was already processed
                    example: false
                  requires_review:
                    type: boolean
                    description: True if amount mismatch detected (needs manual review)
                    example: false
                  requires_refund:
                    type: boolean
                    description: True if payment succeeded but booking failed
                    example: false
        "400":
          description: Missing uid or statusIndicator query parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "missing uid or statusIndicator"
                  correlation_id:
                    type: string

  /api/v1/payments/return:
    get:
      summary: PAYable payment return URL
      description: |
        Redirect URL after PAYable payment completion.
        This endpoint handles the user redirect from PAYable after payment.
        
        **Note:** Payment confirmation is handled via webhook, not this endpoint.
        This is primarily for user experience (showing success/failure page).
      operationId: paymentReturn
      tags:
        - Booking Orchestration
      security: []
      parameters:
        - name: invoiceId
          in: query
          required: false
          schema:
            type: string
          description: Original invoice ID
        - name: uid
          in: query
          required: false
          schema:
            type: string
          description: PAYable payment UID
        - name: resultIndicator
          in: query
          required: false
          schema:
            type: integer
          description: Payment result code
      responses:
        "200":
          description: Return page rendered or redirect issued
          content:
            text/html:
              schema:
                type: string
                description: HTML page showing payment result
        "302":
          description: Redirect to Flutter app or web dashboard

  # ============================================================================
  # SEARCH ENDPOINTS (Phase 1 MVP - Trip Discovery)
  # ============================================================================
  /api/v1/search:
    post:
      summary: Search for available trips
      description: |
        Search for bus trips between two locations.

        **Phase 1 Features:**
        - Exact stop name matching (case-insensitive)
        - Direct trips only (no transfers)
        - Date/time filtering
        - Available seat calculation
        - Bus features display
      operationId: searchTrips
      tags:
        - Search
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - from
                - to
              properties:
                from:
                  type: string
                  description: Origin stop name
                  example: "Colombo Fort"
                to:
                  type: string
                  description: Destination stop name
                  example: "Kandy"
                datetime:
                  type: string
                  format: date-time
                  description: Departure datetime filter (optional, defaults to now)
                  example: "2025-11-20T08:00:00Z"
                limit:
                  type: integer
                  description: Maximum number of results (default 20, max 100)
                  example: 20
      responses:
        "200":
          description: Search completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResponse"
        "400":
          description: Invalid request
        "500":
          description: Internal server error

  /api/v1/search/popular:
    get:
      summary: Get popular routes
      description: Returns frequently searched routes for quick selection
      operationId: getPopularRoutes
      tags:
        - Search
      security: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of routes to return
          required: false
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Popular routes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  routes:
                    type: array
                    items:
                      $ref: "#/components/schemas/PopularRoute"

  /api/v1/search/autocomplete:
    get:
      summary: Get stop autocomplete suggestions
      description: Returns bus stop suggestions as user types
      operationId: getStopAutocomplete
      tags:
        - Search
      security: []
      parameters:
        - name: q
          in: query
          description: Search term (minimum 2 characters)
          required: true
          schema:
            type: string
            minLength: 2
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Autocomplete suggestions retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  suggestions:
                    type: array
                    items:
                      $ref: "#/components/schemas/StopAutocomplete"

  /api/v1/search/health:
    get:
      summary: Search service health check
      operationId: searchHealthCheck
      tags:
        - Search
      security: []
      responses:
        "200":
          description: Search service is healthy

  /api/v1/admin/search/analytics:
    get:
      summary: Get search analytics (Admin only)
      operationId: getSearchAnalytics
      tags:
        - Search
        - Admin Authentication
      security:
        - BearerAuth: []
      parameters:
        - name: days
          in: query
          description: Number of days to analyze
          required: false
          schema:
            type: integer
            default: 7
      responses:
        "200":
          description: Analytics retrieved successfully
        "401":
          description: Unauthorized

# ============================================================================
# Components (Schemas, Responses, SecuritySchemes)
# ============================================================================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token obtained from `/auth/verify-otp` or `/auth/verify-otp-staff`.

        Include in Authorization header as: `Bearer <token>`

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        phone:
          type: string
          example: "+94771234567"
        name:
          type: string
          example: "John Doe"
        email:
          type: string
          format: email
          example: "john.doe@example.com"
        nic:
          type: string
          example: "199512345678"
        address:
          type: string
          example: "123 Main St, Colombo"
        role:
          type: string
          enum: [passenger, driver, conductor]
          example: passenger
        is_verified:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"

    Passenger:
      type: object
      description: |
        Passenger profile data stored in the `passengers` table.
        This is separate from the `users` table which only handles authentication.
        Supports multi-role architecture where the same phone can have multiple roles.
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        user_id:
          type: string
          format: uuid
          description: Foreign key to users table
          example: "660e8400-e29b-41d4-a716-446655440001"
        first_name:
          type: string
          nullable: true
          maxLength: 100
          example: "John"
        last_name:
          type: string
          nullable: true
          maxLength: 100
          example: "Doe"
        email:
          type: string
          format: email
          nullable: true
          example: "john.doe@example.com"
        date_of_birth:
          type: string
          format: date
          nullable: true
          example: "1995-05-15"
        nic:
          type: string
          nullable: true
          maxLength: 50
          example: "199512345678"
        address:
          type: string
          nullable: true
          example: "123 Main St, Colombo"
        city:
          type: string
          nullable: true
          maxLength: 100
          example: "Colombo"
        postal_code:
          type: string
          nullable: true
          maxLength: 20
          example: "10200"
        profile_photo_url:
          type: string
          nullable: true
          example: "https://storage.example.com/photos/user123.jpg"
        profile_completed:
          type: boolean
          description: Whether basic profile (first_name, last_name) has been completed
          example: true
        emergency_contact_name:
          type: string
          nullable: true
          maxLength: 200
          example: "Jane Doe"
        emergency_contact_phone:
          type: string
          nullable: true
          maxLength: 20
          example: "+94771234568"
        preferred_seat_type:
          type: string
          nullable: true
          maxLength: 50
          example: "window"
        special_requirements:
          type: string
          nullable: true
          example: "Wheelchair accessible"
        total_trips:
          type: integer
          default: 0
          example: 15
        loyalty_points:
          type: integer
          default: 0
          example: 150
        verification_status:
          type: string
          enum: [pending, verified, rejected]
          default: pending
          example: "verified"
        verified_at:
          type: string
          format: date-time
          nullable: true
          example: "2025-10-25T10:00:00Z"
        created_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"

    PassengerProfile:
      type: object
      description: Combined user and passenger profile response
      properties:
        id:
          type: string
          format: uuid
          description: User ID from users table
          example: "550e8400-e29b-41d4-a716-446655440000"
        phone:
          type: string
          example: "+94771234567"
        roles:
          type: array
          items:
            type: string
          example: ["passenger"]
        phone_verified:
          type: boolean
          example: true
        status:
          type: string
          enum: [active, inactive, suspended]
          example: "active"
        first_name:
          type: string
          nullable: true
          description: From passengers table
          example: "John"
        last_name:
          type: string
          nullable: true
          description: From passengers table
          example: "Doe"
        email:
          type: string
          format: email
          nullable: true
          description: From passengers table
          example: "john.doe@example.com"
        profile_completed:
          type: boolean
          description: From passengers table - true when first_name and last_name are set
          example: true
        profile_photo_url:
          type: string
          nullable: true
          example: "https://storage.example.com/photos/user123.jpg"
        total_trips:
          type: integer
          example: 15
        loyalty_points:
          type: integer
          example: 150
        created_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"

    AdminUser:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          example: "admin@smarttransit.com"
        full_name:
          type: string
          example: "System Administrator"
        is_active:
          type: boolean
          example: true
        last_login_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        created_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        created_by:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"

    AdminRefreshToken:
      type: object
      description: Refresh token for admin dashboard authentication (stored in admin_refresh_tokens table)
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        admin_user_id:
          type: string
          format: uuid
          description: Foreign key to admin_users table
          example: "550e8400-e29b-41d4-a716-446655440000"
        token_hash:
          type: string
          description: SHA-256 hash of the refresh token
          example: "a3f5c8e9b2d4f1a6c8e7b9d2f4a1c6e8b5d7f9a2c4e6b8d1f3a5c7e9b2d4f6a8"
        device_id:
          type: string
          nullable: true
          example: "device-12345"
        device_type:
          type: string
          nullable: true
          example: "web"
        ip_address:
          type: string
          nullable: true
          example: "192.168.1.100"
        user_agent:
          type: string
          nullable: true
          example: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
        created_at:
          type: string
          format: date-time
          example: "2025-11-12T00:00:00Z"
        expires_at:
          type: string
          format: date-time
          example: "2025-11-19T00:00:00Z"
        last_used_at:
          type: string
          format: date-time
          nullable: true
          example: "2025-11-12T12:30:00Z"
        revoked:
          type: boolean
          example: false
        revoked_at:
          type: string
          format: date-time
          nullable: true
          example: null

    BusStaff:
      type: object
      description: |
        Staff member profile (driver or conductor).
        Contains profile information only - employment details are in BusStaffEmployment.
      properties:
        id:
          type: string
          format: uuid
          example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
        user_id:
          type: string
          format: uuid
          example: "3edeb9af-51c3-4c24-a5d0-76c9dee2d4ea"
        first_name:
          type: string
          example: "Kamal"
        last_name:
          type: string
          example: "Perera"
        staff_type:
          type: string
          enum: [driver, conductor]
          example: "driver"
        license_number:
          type: string
          example: "NTC1234567"
        license_expiry_date:
          type: string
          format: date
          example: "2026-12-31"
        experience_years:
          type: integer
          example: 5
        emergency_contact:
          type: string
          example: "+94777654321"
        emergency_contact_name:
          type: string
          example: "Nimal Perera"
        profile_completed:
          type: boolean
          example: true
        is_verified:
          type: boolean
          description: Whether staff has been verified/approved by admin
          example: false
        verification_status:
          type: string
          enum: [pending, approved, rejected]
          description: Staff verification status
          example: "pending"
        verification_notes:
          type: string
          nullable: true
          example: "Documents verified"
        verified_at:
          type: string
          format: date-time
          nullable: true
          example: "2024-01-15T10:30:00Z"
        verified_by:
          type: string
          format: uuid
          nullable: true
          description: Admin user ID who verified this staff
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    BusStaffEmployment:
      type: object
      description: |
        Employment record for a staff member.
        Tracks employment history when staff moves between bus owners.
      properties:
        id:
          type: string
          format: uuid
          example: "e692d392-cb88-50e3-9f79-6f8488528cf9"
        staff_id:
          type: string
          format: uuid
          example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
        bus_owner_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        employment_status:
          type: string
          enum: [active, inactive, suspended, terminated]
          example: "active"
        hire_date:
          type: string
          format: date
          example: "2024-01-15"
        termination_date:
          type: string
          format: date
          nullable: true
          example: null
        termination_reason:
          type: string
          nullable: true
          example: null
        salary_amount:
          type: number
          format: decimal
          nullable: true
          example: 75000.00
        performance_rating:
          type: number
          format: double
          nullable: true
          example: 4.5
        total_trips_completed:
          type: integer
          example: 150
        is_current:
          type: boolean
          description: Whether this is the current active employment
          example: true
        notes:
          type: string
          nullable: true
          example: "Excellent performance"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    StaffWithEmployment:
      type: object
      description: Staff profile combined with current employment information
      properties:
        staff:
          $ref: "#/components/schemas/BusStaff"
        employment:
          $ref: "#/components/schemas/BusStaffEmployment"
        phone:
          type: string
          description: Phone number from user profile
          example: "+94712345678"

    BusOwner:
      type: object
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 2
        company_name:
          type: string
          example: "Express Transport Ltd"
        nic:
          type: string
          example: "197512345678"
        created_at:
          type: string
          format: date-time

    Lounge:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        lounge_owner_id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440001"
        lounge_name:
          type: string
          example: "City Transit Lounge"
        description:
          type: string
          nullable: true
          example: "Modern lounge with comfortable seating"
        address:
          type: string
          example: "123 Main Street, Colombo"
        state:
          type: string
          nullable: true
          example: "Western Province"
        country:
          type: string
          nullable: true
          example: "Sri Lanka"
        postal_code:
          type: string
          nullable: true
          example: "00700"
        contact_phone:
          type: string
          nullable: true
          example: "+94771234567"
        latitude:
          type: string
          nullable: true
          example: "6.9271"
        longitude:
          type: string
          nullable: true
          example: "79.8612"
        capacity:
          type: integer
          nullable: true
          example: 50
          description: "Maximum number of people the lounge can accommodate"
        routes:
          type: array
          nullable: true
          description: "Array of routes that this lounge serves. Each entry includes the route ID and two consecutive stops."
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
                description: "Lounge route relationship ID"
              lounge_id:
                type: string
                format: uuid
                description: "Reference to the lounge"
              master_route_id:
                type: string
                format: uuid
                description: "Route that this lounge serves"
              stop_before_id:
                type: string
                format: uuid
                description: "Stop before the lounge location"
              stop_after_id:
                type: string
                format: uuid
                description: "Stop after the lounge location"
              created_at:
                type: string
                format: date-time
              updated_at:
                type: string
                format: date-time
          example:
            - id: "aa0e8400-e29b-41d4-a716-446655440010"
              lounge_id: "550e8400-e29b-41d4-a716-446655440000"
              master_route_id: "bb0e8400-e29b-41d4-a716-446655440011"
              stop_before_id: "cc0e8400-e29b-41d4-a716-446655440012"
              stop_after_id: "dd0e8400-e29b-41d4-a716-446655440013"
              created_at: "2025-01-15T10:30:00Z"
              updated_at: "2025-01-15T10:30:00Z"
        price_1_hour:
          type: string
          nullable: true
          description: "Price for 1 hour in LKR (DECIMAL stored as string)"
          example: "500.00"
        price_2_hours:
          type: string
          nullable: true
          description: "Price for 2 hours in LKR (DECIMAL stored as string)"
          example: "900.00"
        price_3_hours:
          type: string
          nullable: true
          description: "Price for 3 hours in LKR (DECIMAL stored as string)"
          example: "1200.00"
        price_until_bus:
          type: string
          nullable: true
          description: "Price until bus departure in LKR (DECIMAL stored as string)"
          example: "1500.00"
        amenities:
          type: array
          items:
            type: string
          nullable: true
          example:
            [
              "wifi",
              "ac",
              "cafeteria",
              "charging_ports",
              "entertainment",
              "parking",
              "restrooms",
              "waiting_area",
            ]
          description: "Standard amenity codes"
        images:
          type: array
          items:
            type: string
          nullable: true
          example:
            [
              "https://example.com/lounge1.jpg",
              "https://example.com/lounge2.jpg",
            ]
        status:
          type: string
          enum: [pending, active, inactive, suspended]
          example: "active"
        is_operational:
          type: boolean
          example: true
        average_rating:
          type: string
          nullable: true
          example: "4.5"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LoungeStaff:
      type: object
      description: Lounge staff member information (11 columns - cleaned schema)
      properties:
        id:
          type: string
          format: uuid
          example: "770e8400-e29b-41d4-a716-446655440002"
        lounge_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        user_id:
          type: string
          format: uuid
          nullable: true
          example: "880e8400-e29b-41d4-a716-446655440003"
          description: "References users.id after staff registers"
        full_name:
          type: string
          example: "John Doe"
        nic_number:
          type: string
          example: "199512345678"
        email:
          type: string
          format: email
          nullable: true
          example: "john.doe@example.com"
        profile_completed:
          type: boolean
          example: false
          description: "True when staff completes their profile after registration"
        employment_status:
          type: string
          enum: [active, suspended, terminated]
          example: "active"
          description: "Staff employment status"
        hired_date:
          type: string
          format: date-time
          nullable: true
          description: "Date staff was hired"
        terminated_date:
          type: string
          format: date-time
          nullable: true
          description: "Date staff was terminated (if applicable)"
        notes:
          type: string
          nullable: true
          description: "Additional notes about the staff member"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    StaffProfile:
      type: object
      description: |
        Complete staff profile including user info, staff details, and current employment.
      properties:
        user:
          $ref: "#/components/schemas/User"
        staff:
          $ref: "#/components/schemas/BusStaff"
        employment:
          $ref: "#/components/schemas/BusStaffEmployment"
          nullable: true
          description: Current employment record (null if not linked to any bus owner)
        bus_owner:
          $ref: "#/components/schemas/BusOwner"
          nullable: true
          description: Current employer's bus owner profile (null if not employed)

    AuthResponse:
      type: object
      description: |
        Response from passenger OTP verification.
        Includes `profile_completed` flag to indicate if profile setup is needed.
      properties:
        message:
          type: string
          example: Login successful
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expires_in:
          type: integer
          description: Access token expiry in seconds
          example: 3600
        profile_completed:
          type: boolean
          description: |
            Whether the passenger has completed basic profile (first_name, last_name).
            - `false`: App should redirect to profile completion screen
            - `true`: App can proceed to main functionality
          example: false
        user:
          $ref: "#/components/schemas/User"

    StaffAuthResponse:
      type: object
      properties:
        message:
          type: string
          example: Login successful
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expires_in:
          type: integer
          example: 3600
        user:
          $ref: "#/components/schemas/User"
        staff:
          $ref: "#/components/schemas/BusStaff"
        bus_owner:
          $ref: "#/components/schemas/BusOwner"

    Error:
      type: object
      properties:
        error:
          type: string
          example: Invalid request
        details:
          type: string
          example: Phone number is required

    BusOwnerProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        user_id:
          type: string
          format: uuid
        company_name:
          type: string
          example: "ABC Transport Services"
        identity_or_incorporation_no:
          type: string
          example: "PV-2023-1234"
        business_email:
          type: string
          format: email
          example: "info@abctransport.lk"
        profile_completed:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    BusOwnerRoute:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d"
        bus_owner_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        master_route_id:
          type: string
          format: uuid
          example: "b2c3d4e5-f6a7-4b5c-9d0e-1f2a3b4c5d6e"
        custom_route_name:
          type: string
          example: "Colombo Badulla Route for BlueBus"
        direction:
          type: string
          enum: [UP, DOWN]
          example: "UP"
        selected_stop_ids:
          type: array
          items:
            type: string
            format: uuid
          example: ["stop-id-1", "stop-id-2", "stop-id-3"]
        created_at:
          type: string
          format: date-time
          example: "2025-11-05T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-05T10:00:00Z"

    RoutePermit:
      type: object
      properties:
        id:
          type: string
          format: uuid
        bus_owner_id:
          type: string
          format: uuid
        permit_number:
          type: string
          example: "PERMIT-2025-001"
        bus_registration_number:
          type: string
          example: "WP CAB-1234"
        route_number:
          type: string
          example: "138"
        route_name:
          type: string
          example: "Colombo - Kandy Express"
        full_origin_city:
          type: string
          example: "Colombo"
        full_destination_city:
          type: string
          example: "Kandy"
        via:
          type: array
          items:
            type: string
          example: ["Kadawatha", "Kegalle"]
        approved_fare:
          type: number
          format: double
          example: 250.00
        approved_seating_capacity:
          type: integer
          nullable: true
          example: 52
          description: Approved number of seats for this permit (optional)
        issue_date:
          type: string
          format: date
          example: "2025-01-01"
        expiry_date:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [pending, verified, rejected]
          example: "verified"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreatePermitRequest:
      type: object
      required:
        - permit_number
        - bus_registration_number
        - master_route_id
        - approved_fare
        - validity_from
        - validity_to
      properties:
        permit_number:
          type: string
          description: Government-issued permit number
          example: "PERMIT-2025-001"
        bus_registration_number:
          type: string
          description: Vehicle registration number
          example: "WP CAB-1234"
        master_route_id:
          type: string
          format: uuid
          description: ID of the master route (from GET /master-routes)
          example: "550e8400-e29b-41d4-a716-446655440000"
        via:
          type: string
          description: Permit-specific intermediate stops (comma-separated, optional)
          example: "Kadawatha, Kegalle"
        approved_fare:
          type: number
          format: double
          description: Maximum approved fare for this route
          example: 250.00
        approved_seating_capacity:
          type: integer
          description: Approved number of seats for this permit
          example: 52
        validity_from:
          type: string
          format: date
          description: Permit issue/start date
          example: "2025-01-01"
        validity_to:
          type: string
          format: date
          description: Permit expiry date
          example: "2025-12-31"
        permit_type:
          type: string
          description: Type of permit (optional)
          example: "regular"
        max_trips_per_day:
          type: integer
          description: Maximum trips allowed per day (optional)
          example: 4
        allowed_bus_types:
          type: array
          items:
            type: string
          description: List of allowed bus types (optional)
          example: ["luxury", "semi-luxury"]
        restrictions:
          type: string
          description: Any restrictions on this permit (optional)
          example: "No night service"

    UpdatePermitRequest:
      type: object
      properties:
        bus_registration_number:
          type: string
          example: "WP CAB-1234"
        via:
          type: string
          example: "Kadawatha, Kegalle"
        approved_fare:
          type: number
          format: double
          example: 250.00
        approved_seating_capacity:
          type: integer
          example: 52
          description: Approved number of seats (optional)
        validity_to:
          type: string
          format: date
          example: "2025-12-31"

    Bus:
      type: object
      required:
        - id
        - bus_owner_id
        - permit_id
        - bus_number
        - license_plate
        - bus_type
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          example: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_owner_id:
          type: string
          format: uuid
          example: "b1eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        permit_id:
          type: string
          format: uuid
          example: "c2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_number:
          type: string
          example: "BUS-001"
        license_plate:
          type: string
          example: "WP CAB-1234"
        bus_type:
          type: string
          enum: [normal, luxury, semi_luxury, super_luxury]
          example: "luxury"
        manufacturing_year:
          type: integer
          example: 2020
        last_maintenance_date:
          type: string
          format: date
          example: "2025-01-15"
        insurance_expiry:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [active, maintenance, inactive]
          example: "active"
        seat_layout_id:
          type: string
          format: uuid
          example: "2c2c3e2b-4328-47b7-ac34-d8e08b46f265"
          description: "References the seat layout template. To get total_seats, join with bus_seat_layout_templates table using this ID."
        has_wifi:
          type: boolean
          example: true
        has_ac:
          type: boolean
          example: true
        has_charging_ports:
          type: boolean
          example: true
        has_entertainment:
          type: boolean
          example: false
        has_refreshments:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2025-01-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-01-01T10:00:00Z"

    CreateBusRequest:
      type: object
      required:
        - permit_id
        - bus_number
        - bus_type
      properties:
        permit_id:
          type: string
          format: uuid
          example: "c2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_number:
          type: string
          example: "BUS-001"
        bus_type:
          type: string
          enum: [normal, luxury, semi_luxury, super_luxury]
          example: "luxury"
        manufacturing_year:
          type: integer
          minimum: 1900
          example: 2020
        last_maintenance_date:
          type: string
          format: date
          example: "2025-01-15"
        insurance_expiry:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [active, maintenance, inactive]
          default: active
          example: "active"
        seat_layout_id:
          type: string
          format: uuid
          example: "2c2c3e2b-4328-47b7-ac34-d8e08b46f265"
          description: "References the seat layout template. To get total_seats, join with bus_seat_layout_templates table using this ID."
        has_wifi:
          type: boolean
          default: false
          example: true
        has_ac:
          type: boolean
          default: false
          example: true
        has_charging_ports:
          type: boolean
          default: false
          example: true
        has_entertainment:
          type: boolean
          default: false
          example: false
        has_refreshments:
          type: boolean
          default: false
          example: true

    UpdateBusRequest:
      type: object
      properties:
        bus_number:
          type: string
          example: "BUS-001"
        bus_type:
          type: string
          enum: [normal, luxury, semi_luxury, super_luxury]
          example: "luxury"
        manufacturing_year:
          type: integer
          minimum: 1900
          example: 2020
        last_maintenance_date:
          type: string
          format: date
          example: "2025-01-15"
        insurance_expiry:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [active, maintenance, inactive]
          example: "maintenance"
        seat_layout_id:
          type: string
          format: uuid
          example: "2c2c3e2b-4328-47b7-ac34-d8e08b46f265"
          description: "References the seat layout template. To get total_seats, join with bus_seat_layout_templates table using this ID."
        has_wifi:
          type: boolean
          example: true
        has_ac:
          type: boolean
          example: true
        has_charging_ports:
          type: boolean
          example: true
        has_entertainment:
          type: boolean
          example: false
        has_refreshments:
          type: boolean
          example: true

    TripSchedule:
      type: object
      required:
        - id
        - bus_owner_id
        - recurrence_type
        - departure_time
        - base_fare
        - is_active
      properties:
        id:
          type: string
          format: uuid
          example: "d3eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_owner_id:
          type: string
          format: uuid
          example: "a1eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_owner_route_id:
          type: string
          format: uuid
          example: "b2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
          description: "Reference to the custom route (bus_owner_routes table)"
        schedule_name:
          type: string
          example: "Morning Express"
        recurrence_type:
          type: string
          enum: [daily, weekly, interval]
          example: "weekly"
        recurrence_days:
          type: array
          items:
            type: integer
            minimum: 0
            maximum: 6
          example: [1, 2, 3, 4, 5]
          description: "Days of week: 0=Sunday, 6=Saturday (for weekly recurrence)"
        recurrence_interval:
          type: integer
          example: 3
          description: "For interval recurrence: repeat every N days"
        departure_time:
          type: string
          example: "08:00:00"
        estimated_duration_minutes:
          type: integer
          nullable: true
          example: 420
          description: "Calculated trip duration in minutes. For overnight trips, includes time past midnight (e.g., 10 PM to 5 AM = 420 minutes)."
        base_fare:
          type: number
          format: double
          example: 350.00
        is_active:
          type: boolean
          example: true
        valid_from:
          type: string
          format: date
          example: "2025-11-01"
        valid_until:
          type: string
          format: date
          example: "2025-12-31"
        specific_dates:
          type: string
          nullable: true
          example: "2025-11-15,2025-11-20,2025-12-25"
          description: "Comma-separated list of dates in YYYY-MM-DD format (deprecated field, can be NULL). Stored as TEXT in database."
        notes:
          type: string
          example: "Regular weekday service"
        created_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"

    ScheduledTrip:
      type: object
      required:
        - id
        - trip_schedule_id
        - departure_datetime
        - base_fare
        - status
      properties:
        id:
          type: string
          format: uuid
          example: "e4eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        trip_schedule_id:
          type: string
          format: uuid
          example: "d3eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_owner_route_id:
          type: string
          format: uuid
          nullable: true
          example: "a1eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
          description: Optional route override - if NULL, inherits from trip_schedule.bus_owner_route_id
        permit_id:
          type: string
          format: uuid
          nullable: true
          example: "c2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
          description: Optional permit ID (NULL if trip has no permit assigned)
        departure_datetime:
          type: string
          format: date-time
          example: "2025-11-05T08:00:00Z"
          description: "Combined departure date and time for the trip. Use ISO 8601 format (YYYY-MM-DDTHH:MM:SS)."
        actual_arrival_datetime:
          type: string
          format: date-time
          nullable: true
          example: "2025-11-05T10:30:00Z"
          description: "Calculated actual arrival date and time for the trip. For overnight trips, this will be the next day's date (e.g., depart 2025-11-05T22:00:00, arrive 2025-11-06T05:00:00)."
        assigned_driver_id:
          type: string
          format: uuid
          example: "f5eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        assigned_conductor_id:
          type: string
          format: uuid
          example: "g6eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        seat_layout_id:
          type: string
          format: uuid
          nullable: true
          example: "550e8400-e29b-41d4-a716-446655440001"
          description: "Seat layout template assigned to this specific trip. Required before trip can be published (is_bookable=true). In Sri Lanka, same route uses different buses frequently, so seat layout is assigned per trip not per bus."
        driver_name:
          type: string
          example: "John Doe"
        conductor_name:
          type: string
          example: "Jane Smith"
        route_number:
          type: string
          nullable: true
          example: "99"
          description: Route number from master_routes (via route_permits join)
        origin_city:
          type: string
          nullable: true
          example: "Badulla"
          description: Origin city from master_routes
        destination_city:
          type: string
          nullable: true
          example: "Colombo"
          description: Destination city from master_routes
        is_up_direction:
          type: boolean
          nullable: true
          example: true
          description: Trip direction - true for up (origin→destination), false for down (destination→origin)
        is_bookable:
          type: boolean
          example: false
          description: Whether this trip is available for passenger booking. Must be explicitly published to make bookable.
        ever_published:
          type: boolean
          example: false
          description: Tracks if this trip was ever made bookable (published). Once true, stays true even if is_bookable becomes false. Used to show trip history.
        base_fare:
          type: number
          format: double
          example: 350.00
        status:
          type: string
          enum: [scheduled, confirmed, in_progress, completed, cancelled]
          example: "scheduled"
        cancellation_reason:
          type: string
          example: "Driver unavailable"
        cancelled_at:
          type: string
          format: date-time
          example: "2025-11-05T07:00:00Z"
        created_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"

    BusSeatLayoutTemplate:
      type: object
      description: Bus seat layout template
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        template_name:
          type: string
          example: "Standard 40-seater Bus"
        total_rows:
          type: integer
          minimum: 1
          maximum: 20
          example: 10
        total_seats:
          type: integer
          example: 40
        description:
          type: string
          example: "Standard configuration for 40-seater buses"
        is_active:
          type: boolean
          example: true
        created_by:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        created_at:
          type: string
          format: date-time
          example: "2025-11-12T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-12T10:00:00Z"

    BusSeatLayoutSeat:
      type: object
      description: Individual seat in a bus layout template
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        template_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        row_number:
          type: integer
          minimum: 1
          example: 1
        row_label:
          type: string
          example: "A"
          description: "Row label (A, B, C, etc.)"
        position:
          type: integer
          minimum: 1
          maximum: 6
          example: 1
          description: "Position 1-3 for left side, 4-6 for right side"
        seat_number:
          type: string
          example: "A1W"
          description: "Generated seat number with continuous numbering across row (e.g., A1W, A2, A3, A4, A5W - first and last seats have W suffix for window)"
        is_window_seat:
          type: boolean
          example: true
        is_aisle_seat:
          type: boolean
          example: false
        created_at:
          type: string
          format: date-time
          example: "2025-11-12T10:00:00Z"

    CreateBusSeatLayoutTemplateRequest:
      type: object
      required:
        - template_name
        - total_rows
        - seat_map
      properties:
        template_name:
          type: string
          example: "Standard 40-seater Bus"
          description: "Name of the template"
        total_rows:
          type: integer
          minimum: 1
          maximum: 20
          example: 10
          description: "Number of rows in the bus"
        description:
          type: string
          example: "Standard configuration for 40-seater buses"
          description: "Optional description of the template"
        seat_map:
          type: array
          description: "2D boolean array [row][position] where true = seat exists, false = empty space"
          items:
            type: array
            items:
              type: boolean
          example:
            [
              [true, true, true, true, true, true],
              [true, true, false, false, true, true],
              [true, true, true, true, true, true],
            ]

    UpdateBusSeatLayoutTemplateRequest:
      type: object
      properties:
        template_name:
          type: string
          example: "Updated Bus Layout"
        description:
          type: string
          example: "Updated description"
        is_active:
          type: boolean
          example: false

    BusSeatLayoutTemplateResponse:
      type: object
      description: Complete bus seat layout template with seats and preview
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        template_name:
          type: string
          example: "Standard 40-seater Bus"
        total_rows:
          type: integer
          example: 10
        total_seats:
          type: integer
          example: 40
        description:
          type: string
          example: "Standard configuration for 40-seater buses"
        is_active:
          type: boolean
          example: true
        created_by:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        created_at:
          type: string
          format: date-time
          example: "2025-11-12T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-12T10:00:00Z"
        seats:
          type: array
          items:
            $ref: "#/components/schemas/BusSeatLayoutSeat"
        layout_preview:
          type: object
          properties:
            rows:
              type: array
              items:
                type: object
                properties:
                  row_number:
                    type: integer
                    example: 1
                  row_label:
                    type: string
                    example: "A"
                  left_seats:
                    type: array
                    description: "Left side seats with continuous numbering (e.g., A1W, A2, A3)"
                    items:
                      type: object
                      properties:
                        position:
                          type: integer
                          example: 1
                        seat_number:
                          type: string
                          example: "A1W"
                          description: "Continuous numbering across row - first seat has W suffix"
                        is_window_seat:
                          type: boolean
                          example: true
                        is_aisle_seat:
                          type: boolean
                          example: false
                  right_seats:
                    type: array
                    description: "Right side seats continuing from left (e.g., A4, A5, A6W)"
                    items:
                      type: object
                      properties:
                        position:
                          type: integer
                          example: 4
                        seat_number:
                          type: string
                          example: "A4"
                          description: "Continues from left side - e.g., if left has 1-3, right has 4-6"
                        is_window_seat:
                          type: boolean
                          example: false
                        is_aisle_seat:
                          type: boolean
                          example: true

    # ========== Search Service Schemas ==========

    SearchResponse:
      type: object
      description: Response from trip search API
      properties:
        status:
          type: string
          enum: [success, partial, error]
          example: "success"
          description: "success = found results, partial = stop not found, error = validation failed"
        message:
          type: string
          example: "Found 5 trip(s) from Colombo Fort to Kandy"
        search_details:
          $ref: "#/components/schemas/SearchDetails"
        results:
          type: array
          items:
            $ref: "#/components/schemas/TripResult"
        search_time_ms:
          type: integer
          format: int64
          example: 234
          description: "Search execution time in milliseconds"

    SearchDetails:
      type: object
      description: Details about how the search was performed
      properties:
        from_stop:
          $ref: "#/components/schemas/StopInfo"
        to_stop:
          $ref: "#/components/schemas/StopInfo"
        search_type:
          type: string
          enum: [exact, fuzzy, failed]
          example: "exact"
          description: "exact = direct match, fuzzy = approximate match, failed = no match"

    StopInfo:
      type: object
      description: Bus stop information with matching details
      properties:
        id:
          type: string
          format: uuid
          nullable: true
          example: "550e8400-e29b-41d4-a716-446655440000"
          description: "Stop ID (null if not found)"
        name:
          type: string
          example: "Colombo Fort"
          description: "Matched stop name"
        matched:
          type: boolean
          example: true
          description: "Whether stop was found in database"
        original_input:
          type: string
          example: "colombo"
          description: "What user typed"

    TripResult:
      type: object
      description: A single trip in search results
      properties:
        trip_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        route_name:
          type: string
          example: "Colombo - Kandy Express"
        route_number:
          type: string
          nullable: true
          example: "001"
        bus_type:
          type: string
          enum: [normal, semi-luxury, luxury, super-luxury, ac-luxury]
          example: "ac-luxury"
        departure_time:
          type: string
          format: date-time
          example: "2025-11-17T08:00:00+05:30"
          description: "Departure time in Asia/Colombo timezone with RFC3339 format"
        estimated_arrival:
          type: string
          format: date-time
          example: "2025-11-17T12:00:00+05:30"
          description: "Estimated arrival time in Asia/Colombo timezone with RFC3339 format"
        duration_minutes:
          type: integer
          example: 240
          description: "Trip duration in minutes"
        total_seats:
          type: integer
          example: 40
        fare:
          type: number
          format: float
          example: 500.00
          description: "Fare in LKR"
        boarding_point:
          type: string
          example: "Colombo Fort"
        dropping_point:
          type: string
          example: "Kandy Town"
        bus_features:
          $ref: "#/components/schemas/BusFeatures"
        is_bookable:
          type: boolean
          example: true
        route_stops:
          type: array
          description: "List of stops on this route for passenger to select boarding/alighting points"
          items:
            $ref: "#/components/schemas/RouteStop"

    RouteStop:
      type: object
      description: A stop on the route for boarding/alighting selection
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440001"
          description: "Stop ID (master_route_stops.id)"
        stop_name:
          type: string
          example: "Kadawatha"
          description: "Name of the stop"
        stop_order:
          type: integer
          example: 3
          description: "Order of this stop in the route"
        latitude:
          type: number
          format: float
          nullable: true
          example: 7.0011
          description: "GPS latitude"
        longitude:
          type: number
          format: float
          nullable: true
          example: 79.9535
          description: "GPS longitude"
        arrival_time_offset_minutes:
          type: integer
          nullable: true
          example: 30
          description: "Minutes from departure to reach this stop"
        is_major_stop:
          type: boolean
          example: true
          description: "Whether this is a major stop (city/town)"

    BusFeatures:
      type: object
      description: Bus amenities and features
      properties:
        has_wifi:
          type: boolean
          example: true
        has_ac:
          type: boolean
          example: true
        has_charging_ports:
          type: boolean
          example: true
        has_entertainment:
          type: boolean
          example: false
        has_refreshments:
          type: boolean
          example: false

    PopularRoute:
      type: object
      description: Frequently searched route for quick selection
      properties:
        from_stop_name:
          type: string
          example: "Colombo Fort"
        to_stop_name:
          type: string
          example: "Kandy"
        route_count:
          type: integer
          example: 15
          description: "Number of routes available"
        search_count:
          type: integer
          nullable: true
          example: 1234
          description: "How many times searched (from analytics)"

    StopAutocomplete:
      type: object
      description: Stop suggestion for autocomplete
      properties:
        stop_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        stop_name:
          type: string
          example: "Colombo Fort"
        route_count:
          type: integer
          example: 25
          description: "Number of routes serving this stop"

    # ==========================================================================
    # TRIP SEATS SCHEMAS
    # ==========================================================================
    TripSeat:
      type: object
      description: Individual seat in a scheduled trip
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        scheduled_trip_id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440001"
        seat_number:
          type: string
          example: "A1W"
        seat_type:
          type: string
          enum: [standard, window, aisle, premium, accessible]
          example: "window"
        row_number:
          type: integer
          example: 1
        position:
          type: integer
          example: 1
        seat_price:
          type: number
          format: double
          example: 350.00
        status:
          type: string
          enum: [available, reserved, booked, blocked]
          example: "available"
        booking_type:
          type: string
          nullable: true
          enum: [app, phone, agent, walk_in, blocked]
          example: "phone"
        bus_booking_seat_id:
          type: string
          format: uuid
          nullable: true
          description: "Reference to app booking seat (if booked via app)"
        manual_booking_id:
          type: string
          format: uuid
          nullable: true
          description: "Reference to manual booking (if booked via phone/agent/walk-in)"
        block_reason:
          type: string
          nullable: true
          example: "Reserved for VIP"
        blocked_by_user_id:
          type: string
          format: uuid
          nullable: true
        blocked_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TripSeatWithBookingInfo:
      type: object
      description: Trip seat with booking information for display
      allOf:
        - $ref: "#/components/schemas/TripSeat"
        - type: object
          properties:
            passenger_name:
              type: string
              nullable: true
              example: "John Perera"
            passenger_phone:
              type: string
              nullable: true
              example: "0771234567"
            booking_reference:
              type: string
              nullable: true
              example: "PH-20251206-001"
            payment_status:
              type: string
              nullable: true
              enum: [pending, partial, paid, collect_on_bus, free]
              example: "paid"

    TripSeatSummary:
      type: object
      description: Summary of seat availability for a trip
      properties:
        scheduled_trip_id:
          type: string
          format: uuid
        total_seats:
          type: integer
          example: 49
        available_seats:
          type: integer
          example: 35
        booked_seats:
          type: integer
          example: 10
        blocked_seats:
          type: integer
          example: 2
        reserved_seats:
          type: integer
          example: 2
        app_bookings:
          type: integer
          example: 5
          description: "Seats booked via mobile app"
        phone_bookings:
          type: integer
          example: 3
          description: "Seats booked via phone call"
        agent_bookings:
          type: integer
          example: 1
          description: "Seats booked via travel agent"
        walk_in_bookings:
          type: integer
          example: 1
          description: "Seats booked via walk-in"

    CreateTripSeatsRequest:
      type: object
      required:
        - seat_layout_id
        - base_fare
      properties:
        seat_layout_id:
          type: string
          format: uuid
          description: "ID of the seat layout template to use"
          example: "550e8400-e29b-41d4-a716-446655440000"
        base_fare:
          type: number
          format: double
          description: "Base fare for all seats"
          example: 350.00

    BlockSeatsRequest:
      type: object
      required:
        - seat_ids
      properties:
        seat_ids:
          type: array
          items:
            type: string
            format: uuid
          description: "IDs of seats to block"
          example:
            [
              "550e8400-e29b-41d4-a716-446655440000",
              "550e8400-e29b-41d4-a716-446655440001",
            ]
        reason:
          type: string
          description: "Reason for blocking seats"
          example: "Reserved for VIP"

    UnblockSeatsRequest:
      type: object
      required:
        - seat_ids
      properties:
        seat_ids:
          type: array
          items:
            type: string
            format: uuid
          description: "IDs of seats to unblock"
          example: ["550e8400-e29b-41d4-a716-446655440000"]

    UpdateSeatPriceRequest:
      type: object
      required:
        - seat_ids
        - new_price
      properties:
        seat_ids:
          type: array
          items:
            type: string
            format: uuid
          description: "IDs of seats to update"
        new_price:
          type: number
          format: double
          description: "New price for the seats"
          example: 400.00

    # ==========================================================================
    # MANUAL BOOKINGS SCHEMAS
    # ==========================================================================
    ManualSeatBooking:
      type: object
      description: Manual booking created by bus owner (phone/agent/walk-in)
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        booking_reference:
          type: string
          example: "PH-20251206-001"
          description: "Format: {TYPE}-{DATE}-{SEQ} where TYPE is PH (phone), AG (agent), or WI (walk-in)"
        scheduled_trip_id:
          type: string
          format: uuid
        created_by_user_id:
          type: string
          format: uuid
          description: "ID of the user (bus owner) who created the booking"
        booking_type:
          type: string
          enum: [phone, agent, walk_in]
          example: "phone"
        passenger_name:
          type: string
          example: "John Perera"
        passenger_phone:
          type: string
          nullable: true
          example: "0771234567"
        passenger_nic:
          type: string
          nullable: true
          example: "199512345678"
        passenger_notes:
          type: string
          nullable: true
          example: "Regular customer"
        route_name:
          type: string
          description: "Derived from scheduled_trip -> bus_owner_route (not stored)"
          example: "Colombo - Kandy"
        boarding_stop_id:
          type: string
          format: uuid
          description: "References master_route_stops.id"
        boarding_stop_name:
          type: string
          description: "Derived from boarding_stop_id JOIN (not stored)"
          example: "Colombo Fort"
        alighting_stop_id:
          type: string
          format: uuid
          description: "References master_route_stops.id"
        alighting_stop_name:
          type: string
          description: "Derived from alighting_stop_id JOIN (not stored)"
          example: "Kandy Town"
        departure_datetime:
          type: string
          format: date-time
        number_of_seats:
          type: integer
          example: 2
        total_fare:
          type: number
          format: double
          example: 700.00
        payment_status:
          type: string
          enum: [pending, partial, paid, collect_on_bus, free]
          example: "paid"
        amount_paid:
          type: number
          format: double
          example: 700.00
        payment_method:
          type: string
          nullable: true
          example: "cash"
        payment_notes:
          type: string
          nullable: true
          example: "Paid in full"
        status:
          type: string
          enum: [confirmed, checked_in, boarded, completed, cancelled, no_show]
          example: "confirmed"
        confirmed_at:
          type: string
          format: date-time
        checked_in_at:
          type: string
          format: date-time
          nullable: true
        boarded_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true
        cancelled_at:
          type: string
          format: date-time
          nullable: true
        cancellation_reason:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    RouteStopDetail:
      type: object
      description: Route stop information for dropdown selection
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440001"
        stop_name:
          type: string
          example: "Colombo Fort"
        stop_order:
          type: integer
          description: "Order of the stop in the route (1 = first stop)"
          example: 1

    ManualBookingSeat:
      type: object
      description: Seat assigned to a manual booking
      properties:
        id:
          type: string
          format: uuid
        manual_booking_id:
          type: string
          format: uuid
        trip_seat_id:
          type: string
          format: uuid
        seat_number:
          type: string
          example: "A1W"
        seat_price:
          type: number
          format: double
          example: 350.00
        passenger_name:
          type: string
          nullable: true
          example: "John Perera"
          description: "Optional per-seat passenger name"
        created_at:
          type: string
          format: date-time

    ManualBookingWithSeats:
      type: object
      description: Manual booking with seat details
      allOf:
        - $ref: "#/components/schemas/ManualSeatBooking"
        - type: object
          properties:
            seats:
              type: array
              items:
                $ref: "#/components/schemas/ManualBookingSeat"

    CreateManualBookingRequest:
      type: object
      required:
        - booking_type
        - passenger_name
        - boarding_stop_id
        - alighting_stop_id
        - seat_ids
        - payment_status
      properties:
        booking_type:
          type: string
          enum: [phone, agent, walk_in]
          example: "phone"
        passenger_name:
          type: string
          example: "John Perera"
        passenger_phone:
          type: string
          example: "0771234567"
        passenger_nic:
          type: string
          example: "199512345678"
        passenger_notes:
          type: string
          example: "Regular customer, prefers window seat"
        boarding_stop_id:
          type: string
          format: uuid
          description: "ID of the boarding stop (from route-stops endpoint)"
          example: "550e8400-e29b-41d4-a716-446655440001"
        alighting_stop_id:
          type: string
          format: uuid
          description: "ID of the alighting stop (from route-stops endpoint)"
          example: "550e8400-e29b-41d4-a716-446655440002"
        seat_ids:
          type: array
          items:
            type: string
            format: uuid
          description: "IDs of trip_seats to book"
        payment_status:
          type: string
          enum: [pending, partial, paid, collect_on_bus, free]
          example: "collect_on_bus"
        amount_paid:
          type: number
          format: double
          default: 0
          example: 0
        payment_method:
          type: string
          example: "cash"
        payment_notes:
          type: string
          example: "Will pay on bus"

    UpdateManualBookingPaymentRequest:
      type: object
      required:
        - payment_status
        - amount_paid
      properties:
        payment_status:
          type: string
          enum: [pending, partial, paid, collect_on_bus, free]
          example: "paid"
        amount_paid:
          type: number
          format: double
          example: 700.00
        payment_method:
          type: string
          example: "cash"
        payment_notes:
          type: string
          example: "Paid in full at counter"

    # ==========================================================================
    # LOUNGE BOOKING SCHEMAS
    # ==========================================================================
    LoungeCategory:
      type: object
      description: Product category for lounge marketplace
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "Beverages"
        description:
          type: string
          nullable: true
          example: "Hot and cold drinks"
        icon_name:
          type: string
          nullable: true
          example: "restaurant"
          description: "Icon font name (e.g., Material Icons name)"
        icon_url:
          type: string
          nullable: true
          description: "Custom icon image URL"
        parent_category_id:
          type: string
          format: uuid
          nullable: true
          description: "Parent category ID for subcategories"
        display_order:
          type: integer
          example: 1
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LoungeProduct:
      type: object
      description: Product available at a lounge
      properties:
        id:
          type: string
          format: uuid
        lounge_id:
          type: string
          format: uuid
        category_id:
          type: string
          format: uuid
          nullable: true
        category_name:
          type: string
          nullable: true
          example: "Beverages"
        name:
          type: string
          example: "Ceylon Tea"
        description:
          type: string
          nullable: true
          example: "Premium Ceylon black tea"
        product_type:
          type: string
          enum: [product, service, combo]
          example: "product"
          description: "Type of item: product (food/beverage), service (wifi/storage), combo (bundle)"
        price:
          type: string
          example: "150.00"
        discounted_price:
          type: string
          nullable: true
          example: "120.00"
          description: "Sale price when applicable"
        image_url:
          type: string
          nullable: true
        thumbnail_url:
          type: string
          nullable: true
          description: "Smaller image for list views"
        stock_status:
          type: string
          enum: [in_stock, low_stock, out_of_stock, made_to_order]
          example: "in_stock"
        stock_quantity:
          type: integer
          nullable: true
          example: 50
          description: "Current stock level"
        is_available:
          type: boolean
          example: true
        is_pre_orderable:
          type: boolean
          example: false
          description: "Whether the product can be pre-ordered before arrival"
        available_from:
          type: string
          nullable: true
          example: "06:00:00"
          description: "Time-based availability start (HH:MM:SS)"
        available_until:
          type: string
          nullable: true
          example: "10:30:00"
          description: "Time-based availability end (HH:MM:SS)"
        available_days:
          type: array
          items:
            type: string
          example: ["mon", "tue", "wed", "thu", "fri", "sat", "sun"]
          description: "Days of the week when available"
        service_duration_minutes:
          type: integer
          nullable: true
          example: 60
          description: "Duration in minutes for services (WiFi, storage, etc.)"
        is_vegetarian:
          type: boolean
          example: false
          description: "Dietary information - vegetarian"
        is_vegan:
          type: boolean
          example: false
          description: "Dietary information - vegan"
        is_halal:
          type: boolean
          example: false
          description: "Dietary information - halal"
        allergens:
          type: array
          items:
            type: string
          example: ["nuts", "dairy"]
          description: "List of allergens in the product"
        calories:
          type: integer
          nullable: true
          example: 150
          description: "Calorie count per serving"
        display_order:
          type: integer
          example: 1
          description: "Sort order for displaying products"
        is_featured:
          type: boolean
          example: false
          description: "Featured products shown prominently"
        tags:
          type: array
          items:
            type: string
          example: ["popular", "traditional"]
          description: "Product tags for filtering/display"
        average_rating:
          type: string
          nullable: true
          example: "4.50"
          description: "Average customer rating (0-5)"
        total_reviews:
          type: integer
          example: 25
          description: "Total number of reviews"
        is_active:
          type: boolean
          example: true
          description: "Whether product is active (not soft-deleted)"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateLoungeProductRequest:
      type: object
      required:
        - name
        - price
      properties:
        category_id:
          type: string
          format: uuid
        name:
          type: string
          example: "Ceylon Tea"
        description:
          type: string
          example: "Premium Ceylon black tea"
        product_type:
          type: string
          enum: [product, service, combo]
          default: "product"
        price:
          type: string
          example: "150.00"
        discounted_price:
          type: string
          nullable: true
        image_url:
          type: string
        thumbnail_url:
          type: string
        stock_status:
          type: string
          enum: [in_stock, low_stock, out_of_stock, made_to_order]
          default: "in_stock"
        stock_quantity:
          type: integer
        is_available:
          type: boolean
          default: true
        is_pre_orderable:
          type: boolean
          default: false
        available_from:
          type: string
          example: "06:00:00"
        available_until:
          type: string
          example: "22:00:00"
        available_days:
          type: array
          items:
            type: string
          example: ["mon", "tue", "wed", "thu", "fri", "sat", "sun"]
        service_duration_minutes:
          type: integer
        is_vegetarian:
          type: boolean
          default: false
        is_vegan:
          type: boolean
          default: false
        is_halal:
          type: boolean
          default: false
        allergens:
          type: array
          items:
            type: string
        calories:
          type: integer
        display_order:
          type: integer
          default: 0
        is_featured:
          type: boolean
          default: false
        tags:
          type: array
          items:
            type: string

    UpdateLoungeProductRequest:
      type: object
      properties:
        category_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        product_type:
          type: string
          enum: [product, service, combo]
        price:
          type: string
        discounted_price:
          type: string
          nullable: true
        image_url:
          type: string
        thumbnail_url:
          type: string
        stock_status:
          type: string
          enum: [in_stock, low_stock, out_of_stock, made_to_order]
        stock_quantity:
          type: integer
        is_available:
          type: boolean
        is_pre_orderable:
          type: boolean
        available_from:
          type: string
        available_until:
          type: string
        available_days:
          type: array
          items:
            type: string
        service_duration_minutes:
          type: integer
        is_vegetarian:
          type: boolean
        is_vegan:
          type: boolean
        is_halal:
          type: boolean
        allergens:
          type: array
          items:
            type: string
        calories:
          type: integer
        display_order:
          type: integer
        is_featured:
          type: boolean
        tags:
          type: array
          items:
            type: string

    LoungeBooking:
      type: object
      description: Lounge booking record
      properties:
        id:
          type: string
          format: uuid
        lounge_id:
          type: string
          format: uuid
        lounge_name:
          type: string
          example: "City Central Lounge"
        lounge_address:
          type: string
          nullable: true
          example: "123 Main Street, Colombo"
          description: "Denormalized lounge address at booking time"
        lounge_phone:
          type: string
          nullable: true
          example: "+94112345678"
          description: "Denormalized lounge phone at booking time"
        user_id:
          type: string
          format: uuid
        master_booking_id:
          type: string
          format: uuid
          nullable: true
          description: Optional link to master booking (for bus+lounge bookings)
        bus_booking_id:
          type: string
          format: uuid
          nullable: true
          description: Optional link to bus booking
        booking_reference:
          type: string
          example: "LNG-abc123"
        booking_type:
          type: string
          enum: [pre_trip, post_trip, standalone]
          example: "standalone"
        pricing_type:
          type: string
          enum: [1_hour, 2_hours, 3_hours, until_bus, custom]
          example: "2_hours"
        price_per_guest:
          type: string
          nullable: true
          example: "450.00"
          description: "Price per guest (base_price / number_of_guests)"
        number_of_guests:
          type: integer
          example: 2
        scheduled_arrival:
          type: string
          format: date-time
          description: "When guest plans to arrive"
        scheduled_departure:
          type: string
          format: date-time
          nullable: true
          description: "When guest plans to leave (null if until_bus)"
        actual_arrival:
          type: string
          format: date-time
          nullable: true
          description: "Actual check-in time"
        actual_departure:
          type: string
          format: date-time
          nullable: true
          description: "Actual check-out time"
        base_price:
          type: string
          example: "900.00"
        pre_order_total:
          type: string
          example: "0.00"
          description: "Total of pre-ordered items"
        discount_amount:
          type: string
          example: "0.00"
        total_amount:
          type: string
          example: "900.00"
        status:
          type: string
          enum: [pending, confirmed, checked_in, in_lounge, checked_out, completed, cancelled, no_show]
          example: "confirmed"
        payment_status:
          type: string
          enum: [pending, paid, partial, collect_on_site, failed, refunded]
          example: "pending"
        primary_guest_name:
          type: string
          example: "John Doe"
        primary_guest_phone:
          type: string
          example: "+94771234567"
        promo_code:
          type: string
          nullable: true
          example: "WELCOME10"
        special_requests:
          type: string
          nullable: true
        internal_notes:
          type: string
          nullable: true
        cancelled_at:
          type: string
          format: date-time
          nullable: true
        cancellation_reason:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LoungeBookingGuest:
      type: object
      description: Guest in a lounge booking
      properties:
        id:
          type: string
          format: uuid
        lounge_booking_id:
          type: string
          format: uuid
        guest_name:
          type: string
          example: "John Doe"
        guest_phone:
          type: string
          nullable: true
          example: "+94771234567"
        is_primary:
          type: boolean
          example: true
        checked_in_at:
          type: string
          format: date-time
          nullable: true

    LoungeBookingDetail:
      type: object
      description: Detailed lounge booking with guests and pre-orders
      allOf:
        - $ref: "#/components/schemas/LoungeBooking"
        - type: object
          properties:
            guests:
              type: array
              items:
                $ref: "#/components/schemas/LoungeBookingGuest"
            pre_orders:
              type: array
              items:
                $ref: "#/components/schemas/LoungePreOrderItem"
            lounge:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                lounge_name:
                  type: string
                address:
                  type: string
                contact_phone:
                  type: string
                  nullable: true

    LoungePreOrderItem:
      type: object
      description: Pre-ordered item in a lounge booking
      properties:
        id:
          type: string
          format: uuid
        lounge_booking_id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        product_name:
          type: string
          example: "Ceylon Tea"
        product_type:
          type: string
          enum: [product, service, combo]
          example: "product"
          description: "Type of product (snapshot at booking time)"
        product_image_url:
          type: string
          nullable: true
          example: "https://example.com/images/ceylon-tea.jpg"
          description: "Product image URL (snapshot at booking time)"
        quantity:
          type: integer
          example: 2
        unit_price:
          type: string
          example: "150.00"
        total_price:
          type: string
          example: "300.00"
          description: "unit_price * quantity"
        created_at:
          type: string
          format: date-time

    CreateLoungeBookingRequest:
      type: object
      required:
        - lounge_id
        - pricing_type
        - check_in_time
        - number_of_guests
      properties:
        lounge_id:
          type: string
          format: uuid
        bus_booking_id:
          type: string
          format: uuid
          description: Optional - link to existing bus booking
        pricing_type:
          type: string
          enum: [1_hour, 2_hours, 3_hours, until_bus, custom]
          example: "2_hours"
        check_in_time:
          type: string
          format: date-time
        number_of_guests:
          type: integer
          minimum: 1
          example: 2
        special_requests:
          type: string
        guests:
          type: array
          description: Optional guest list
          items:
            type: object
            required:
              - guest_name
            properties:
              guest_name:
                type: string
                example: "John Doe"
              guest_phone:
                type: string
                example: "+94771234567"
              is_primary:
                type: boolean
                default: false
        pre_orders:
          type: array
          description: Optional pre-order items
          items:
            type: object
            required:
              - product_id
              - quantity
            properties:
              product_id:
                type: string
                format: uuid
              quantity:
                type: integer
                minimum: 1
              special_instructions:
                type: string

    LoungeOrder:
      type: object
      description: Food/beverage order at a lounge
      properties:
        id:
          type: string
          format: uuid
        lounge_id:
          type: string
          format: uuid
        lounge_booking_id:
          type: string
          format: uuid
          nullable: true
        user_id:
          type: string
          format: uuid
        order_number:
          type: string
          example: "LO-20250101-001"
        total_amount:
          type: string
          example: "750.00"
        status:
          type: string
          enum: [pending, preparing, ready, delivered, cancelled]
          example: "pending"
        payment_status:
          type: string
          enum: [pending, paid, refunded]
          example: "pending"
        notes:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        items:
          type: array
          items:
            $ref: "#/components/schemas/LoungeOrderItem"

    LoungeOrderItem:
      type: object
      description: Item in a lounge order
      properties:
        id:
          type: string
          format: uuid
        lounge_order_id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        product_name:
          type: string
          example: "Ceylon Tea"
        quantity:
          type: integer
          example: 2
        unit_price:
          type: string
          example: "150.00"
        subtotal:
          type: string
          example: "300.00"
        special_instructions:
          type: string
          nullable: true

    CreateLoungeOrderRequest:
      type: object
      required:
        - lounge_id
        - items
      properties:
        lounge_id:
          type: string
          format: uuid
        lounge_booking_id:
          type: string
          format: uuid
          description: Optional - link to existing lounge booking
        notes:
          type: string
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - product_id
              - quantity
            properties:
              product_id:
                type: string
                format: uuid
              quantity:
                type: integer
                minimum: 1
              special_instructions:
                type: string

    # ==========================================================================
    # BOOKING ORCHESTRATION SCHEMAS (Intent → Payment → Confirm)
    # ==========================================================================
    CreateBookingIntentRequest:
      type: object
      required:
        - intent_type
      properties:
        intent_type:
          type: string
          enum: [bus_only, lounge_only, bus_with_lounge]
          description: Type of booking
        bus:
          $ref: "#/components/schemas/BusIntentRequest"
        pre_trip_lounge:
          $ref: "#/components/schemas/LoungeIntentRequest"
        post_trip_lounge:
          $ref: "#/components/schemas/LoungeIntentRequest"
        idempotency_key:
          type: string
          description: Unique key to prevent duplicate intents
          example: "booking-abc123-1702658400"

    BusIntentRequest:
      type: object
      required:
        - scheduled_trip_id
        - boarding_stop_id
        - alighting_stop_id
        - seats
        - passenger_name
        - passenger_phone
      properties:
        scheduled_trip_id:
          type: string
          format: uuid
        boarding_stop_id:
          type: string
        boarding_stop_name:
          type: string
        alighting_stop_id:
          type: string
        alighting_stop_name:
          type: string
        seats:
          type: array
          items:
            $ref: "#/components/schemas/IntentSeatRequest"
        passenger_name:
          type: string
        passenger_phone:
          type: string
        passenger_email:
          type: string
          nullable: true
        special_requests:
          type: string
          nullable: true

    IntentSeatRequest:
      type: object
      required:
        - trip_seat_id
        - passenger_name
      properties:
        trip_seat_id:
          type: string
          format: uuid
          description: ID of the trip_seat to book
        passenger_name:
          type: string
        passenger_phone:
          type: string
          nullable: true
        passenger_gender:
          type: string
          enum: [male, female, other]
          nullable: true
        is_primary:
          type: boolean
          default: false

    LoungeIntentRequest:
      type: object
      required:
        - lounge_id
        - guest_count
        - guests
      properties:
        lounge_id:
          type: string
          format: uuid
        guest_count:
          type: integer
          minimum: 1
        scheduled_arrival:
          type: string
          format: date-time
          description: Expected arrival time at lounge
        guests:
          type: array
          items:
            $ref: "#/components/schemas/LoungeGuestRequest"
        pre_orders:
          type: array
          items:
            $ref: "#/components/schemas/PreOrderItem"

    LoungeGuestRequest:
      type: object
      required:
        - guest_name
      properties:
        guest_name:
          type: string
        guest_phone:
          type: string
          nullable: true

    PreOrderItem:
      type: object
      required:
        - product_id
        - quantity
      properties:
        product_id:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1
        notes:
          type: string
          nullable: true

    BookingIntentResponse:
      type: object
      properties:
        intent_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [held, payment_pending, confirming, confirmed, expired, cancelled]
        expires_at:
          type: string
          format: date-time
          description: Intent expiration time (10 min from creation)
        pricing:
          $ref: "#/components/schemas/IntentPricing"
        bus:
          $ref: "#/components/schemas/BusIntentSummary"
        pre_trip_lounge:
          $ref: "#/components/schemas/LoungeIntentSummary"
        post_trip_lounge:
          $ref: "#/components/schemas/LoungeIntentSummary"

    IntentPricing:
      type: object
      properties:
        bus_fare:
          type: number
          format: double
        pre_lounge_fare:
          type: number
          format: double
        post_lounge_fare:
          type: number
          format: double
        total_amount:
          type: number
          format: double
        currency:
          type: string
          example: "LKR"

    BusIntentSummary:
      type: object
      properties:
        scheduled_trip_id:
          type: string
          format: uuid
        route_name:
          type: string
        departure_datetime:
          type: string
          format: date-time
        boarding_stop:
          type: string
        alighting_stop:
          type: string
        seat_count:
          type: integer
        seats:
          type: array
          items:
            type: object
            properties:
              seat_number:
                type: string
              seat_type:
                type: string
              seat_price:
                type: number
                format: double

    LoungeIntentSummary:
      type: object
      properties:
        lounge_id:
          type: string
          format: uuid
        lounge_name:
          type: string
        guest_count:
          type: integer
        base_price:
          type: number
          format: double
        pre_order_total:
          type: number
          format: double
        total_price:
          type: number
          format: double

    GetIntentStatusResponse:
      type: object
      properties:
        intent_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [held, payment_pending, confirming, confirmed, expired, cancelled]
        expires_at:
          type: string
          format: date-time
        time_remaining_seconds:
          type: integer
          description: Seconds until intent expires
        pricing:
          $ref: "#/components/schemas/IntentPricing"
        bus_booking:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            reference:
              type: string
        pre_lounge_booking:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            reference:
              type: string
        post_lounge_booking:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            reference:
              type: string

    InitiatePaymentResponse:
      type: object
      description: |
        Payment initiation response with PAYable IPG integration.
        The `payment_url` is the complete PAYable hosted checkout URL.
        Flutter WebView should navigate to this URL for payment.
      properties:
        intent_id:
          type: string
          format: uuid
          description: The booking intent ID
        payment_reference:
          type: string
          description: Unique payment reference (INV-xxx format) used as invoiceId
        payment_gateway:
          type: string
          example: "PAYable"
          description: Payment gateway identifier
        payment_url:
          type: string
          format: uri
          description: |
            Complete PAYable hosted checkout URL.
            Flutter should open this in WebView for the user to complete payment.
            Example: https://payable.lk/pay?...
        amount:
          type: number
          format: double
          description: Total amount to pay
        currency:
          type: string
          description: Currency code (LKR)
          example: "LKR"
        expires_at:
          type: string
          format: date-time
          description: When the intent/payment session expires
        uid:
          type: string
          description: |
            PAYable unique identifier for this payment.
            Used to query payment status via PAYable API.
          example: "PAYABLE-UID-123456"
        status_indicator:
          type: string
          description: |
            PAYable status indicator.
            Used together with uid to query payment status.
          example: "STATUS-IND-789"
        merchant_key:
          type: string
          description: PAYable merchant key (for reference only)
          example: "MK123456"
        check_value:
          type: string
          description: |
            SHA-512 checkValue generated server-side.
            Already included in payment_url, provided here for reference.
          example: "abc123def456..."
        logo_url:
          type: string
          format: uri
          description: Merchant logo URL displayed on PAYable checkout page
          example: "https://example.com/logo.png"

    ConfirmBookingRequest:
      type: object
      required:
        - intent_id
        - payment_reference
      properties:
        intent_id:
          type: string
          format: uuid
          description: The booking intent to confirm
        payment_reference:
          type: string
          description: Payment reference from gateway

    ConfirmBookingResponse:
      type: object
      properties:
        message:
          type: string
          example: "Booking confirmed successfully"
        intent_id:
          type: string
          format: uuid
        master_reference:
          type: string
          description: Main booking reference
        bus_booking:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            reference:
              type: string
            qr_code:
              type: string
        pre_lounge_booking:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            reference:
              type: string
        post_lounge_booking:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            reference:
              type: string

    BookingIntent:
      type: object
      description: Full booking intent record with PAYable integration fields
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        intent_type:
          type: string
          enum: [bus_only, lounge_only, bus_with_lounge]
        status:
          type: string
          enum: [held, payment_pending, confirming, confirmed, expired, cancelled]
        bus_fare:
          type: number
          format: double
        pre_lounge_fare:
          type: number
          format: double
        post_lounge_fare:
          type: number
          format: double
        total_amount:
          type: number
          format: double
        currency:
          type: string
        payment_reference:
          type: string
          nullable: true
          description: Invoice ID sent to PAYable (INV-xxx format)
        payment_status:
          type: string
          enum: [pending, processing, success, failed]
          nullable: true
        payment_uid:
          type: string
          nullable: true
          description: PAYable unique identifier for tracking payment
        payment_status_indicator:
          type: string
          nullable: true
          description: PAYable status indicator for querying payment status
        passenger_name:
          type: string
          nullable: true
          description: Passenger name for payment record
        passenger_phone:
          type: string
          nullable: true
          description: Passenger phone for payment record
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PartialAvailabilityError:
      type: object
      description: Returned when some requested items are unavailable
      properties:
        error:
          type: string
          example: "partial_availability"
        message:
          type: string
          example: "Some items are no longer available"
        available:
          type: object
          properties:
            bus:
              type: boolean
            pre_lounge:
              type: boolean
            post_lounge:
              type: boolean
        unavailable:
          type: object
          properties:
            bus:
              type: object
              nullable: true
              properties:
                reason:
                  type: string
                  enum: [seats_taken, trip_departed, trip_cancelled]
                details:
                  type: string
                taken_seats:
                  type: array
                  items:
                    type: string
            pre_lounge:
              type: object
              nullable: true
              properties:
                reason:
                  type: string
                  enum: [capacity_full, lounge_closed]
                details:
                  type: string
            post_lounge:
              type: object
              nullable: true
              properties:
                reason:
                  type: string
                details:
                  type: string

    # ==========================================================================
    # APP BOOKINGS SCHEMAS (Passenger App)
    # ==========================================================================
    CreateAppBookingRequest:
      type: object
      required:
        - scheduled_trip_id
        - boarding_stop_id
        - boarding_stop_name
        - alighting_stop_id
        - alighting_stop_name
        - seats
        - passenger_name
        - passenger_phone
      properties:
        scheduled_trip_id:
          type: string
          format: uuid
          description: ID of the scheduled trip to book
        boarding_stop_id:
          type: string
          format: uuid
          description: ID of the boarding stop from route_stops (required for normalized schema)
        boarding_stop_name:
          type: string
          description: Name of boarding stop (used for display/confirmation)
          example: "Colombo Fort"
        alighting_stop_id:
          type: string
          format: uuid
          description: ID of the alighting stop from route_stops (required for normalized schema)
        alighting_stop_name:
          type: string
          description: Name of alighting stop (used for display/confirmation)
          example: "Kandy Central"
        seats:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/SeatSelection"
        passenger_name:
          type: string
          description: Primary contact name
          example: "John Perera"
        passenger_phone:
          type: string
          description: Primary contact phone
          example: "+94771234567"
        passenger_email:
          type: string
          format: email
          nullable: true
          example: "john@email.com"
        special_requests:
          type: string
          nullable: true
          description: Special requests or notes
        device_info:
          type: object
          nullable: true
          description: Device metadata (OS, app version, etc.)

    SeatSelection:
      type: object
      required:
        - trip_seat_id
        - seat_number
        - passenger_name
      properties:
        trip_seat_id:
          type: string
          format: uuid
          description: ID of the trip_seat record
        seat_number:
          type: string
          example: "A1"
        seat_type:
          type: string
          example: "window"
        seat_price:
          type: number
          format: double
          description: Price is calculated from trip_seat
        passenger_name:
          type: string
          example: "John Perera"
        passenger_phone:
          type: string
          nullable: true
          example: "+94771234567"
        passenger_email:
          type: string
          format: email
          nullable: true
        passenger_age:
          type: integer
          nullable: true
          example: 35
        passenger_gender:
          type: string
          nullable: true
          enum: [male, female, other]
        passenger_nic:
          type: string
          nullable: true
          example: "199512345678"
        is_primary:
          type: boolean
          default: false
          description: Is this the primary passenger (for multi-seat bookings)

    MasterBooking:
      type: object
      description: Master booking record
      properties:
        id:
          type: string
          format: uuid
        booking_reference:
          type: string
          example: "BL-20250106-A1B2C3"
        user_id:
          type: string
          format: uuid
        booking_type:
          type: string
          enum: [bus_only, lounge_only, bus_with_lounge]
        bus_total:
          type: number
          format: double
        lounge_total:
          type: number
          format: double
        pre_order_total:
          type: number
          format: double
        subtotal:
          type: number
          format: double
        discount_amount:
          type: number
          format: double
        tax_amount:
          type: number
          format: double
        total_amount:
          type: number
          format: double
        promo_code:
          type: string
          nullable: true
        payment_status:
          type: string
          enum: [pending, partial, paid, failed, refunded, partial_refund]
        payment_method:
          type: string
          nullable: true
        payment_reference:
          type: string
          nullable: true
        payment_gateway:
          type: string
          nullable: true
        paid_at:
          type: string
          format: date-time
          nullable: true
        booking_status:
          type: string
          enum:
            [
              pending,
              confirmed,
              in_progress,
              completed,
              cancelled,
              partial_cancel,
            ]
        passenger_name:
          type: string
        passenger_phone:
          type: string
        passenger_email:
          type: string
          nullable: true
        confirmed_at:
          type: string
          format: date-time
          nullable: true
        cancelled_at:
          type: string
          format: date-time
          nullable: true
        cancellation_reason:
          type: string
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true
        refund_amount:
          type: number
          format: double
        refunded_at:
          type: string
          format: date-time
          nullable: true
        booking_source:
          type: string
          enum: [app, web, agent, kiosk]
        notes:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        bus_booking:
          $ref: "#/components/schemas/BusBooking"

    BusBooking:
      type: object
      description: |
        Bus trip details within a booking.
        Note: Some fields (route_name, bus_number, bus_type, departure_datetime, etc.) 
        are populated from the related scheduled_trip and route_stops tables via JOINs.
      properties:
        id:
          type: string
          format: uuid
        booking_id:
          type: string
          format: uuid
        scheduled_trip_id:
          type: string
          format: uuid
        route_name:
          type: string
          description: Populated from scheduled_trip
          example: "Colombo - Kandy"
        bus_number:
          type: string
          nullable: true
          description: Populated from scheduled_trip
          example: "NC-1234"
        bus_type:
          type: string
          nullable: true
          description: Populated from scheduled_trip
          example: "Luxury"
        boarding_stop_id:
          type: string
          format: uuid
          nullable: true
        boarding_stop_name:
          type: string
          description: Populated from route_stops via boarding_stop_id
          example: "Colombo Fort"
        alighting_stop_id:
          type: string
          format: uuid
          nullable: true
        alighting_stop_name:
          type: string
          description: Populated from route_stops via alighting_stop_id
          example: "Kandy Central"
        departure_datetime:
          type: string
          format: date-time
          description: Populated from scheduled_trip
        estimated_arrival_datetime:
          type: string
          format: date-time
          nullable: true
          description: Populated from scheduled_trip
        actual_departure_datetime:
          type: string
          format: date-time
          nullable: true
          description: Populated from scheduled_trip
        actual_arrival_datetime:
          type: string
          format: date-time
          nullable: true
          description: Populated from scheduled_trip
        number_of_seats:
          type: integer
        fare_per_seat:
          type: number
          format: double
        total_fare:
          type: number
          format: double
        status:
          type: string
          enum:
            [
              pending,
              confirmed,
              checked_in,
              boarded,
              in_transit,
              completed,
              cancelled,
              no_show,
            ]
        checked_in_at:
          type: string
          format: date-time
          nullable: true
        boarded_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true
        cancelled_at:
          type: string
          format: date-time
          nullable: true
        qr_code_data:
          type: string
          nullable: true
          description: QR code for boarding verification
        qr_generated_at:
          type: string
          format: date-time
          nullable: true
        special_requests:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        seats:
          type: array
          items:
            $ref: "#/components/schemas/BusBookingSeat"

    BusBookingSeat:
      type: object
      description: |
        Individual seat in a bus booking.
        Note: seat_number, seat_type, and seat_price are populated from trip_seats table via JOIN.
      properties:
        id:
          type: string
          format: uuid
        bus_booking_id:
          type: string
          format: uuid
        scheduled_trip_id:
          type: string
          format: uuid
        trip_seat_id:
          type: string
          format: uuid
          nullable: true
        seat_number:
          type: string
          description: Populated from trip_seats via trip_seat_id
          example: "A1"
        seat_type:
          type: string
          description: Populated from trip_seats via trip_seat_id
          example: "window"
        seat_price:
          type: number
          format: double
          description: Populated from trip_seats via trip_seat_id
        passenger_name:
          type: string
        passenger_phone:
          type: string
          nullable: true
        passenger_email:
          type: string
          format: email
          nullable: true
        passenger_age:
          type: integer
          nullable: true
        passenger_gender:
          type: string
          nullable: true
        passenger_nic:
          type: string
          nullable: true
        is_primary_passenger:
          type: boolean
        status:
          type: string
          enum:
            [
              pending,
              booked,
              checked_in,
              boarded,
              completed,
              cancelled,
              no_show,
            ]
        checked_in_at:
          type: string
          format: date-time
          nullable: true
        boarded_at:
          type: string
          format: date-time
          nullable: true
        cancelled_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    BookingResponse:
      type: object
      description: Response after creating a booking
      properties:
        booking:
          $ref: "#/components/schemas/MasterBooking"
        bus_booking:
          $ref: "#/components/schemas/BusBooking"
        seats:
          type: array
          items:
            $ref: "#/components/schemas/BusBookingSeat"
        qr_code:
          type: string
          description: QR code for boarding

    BookingListItem:
      type: object
      description: Booking list item for displaying in lists
      properties:
        id:
          type: string
          format: uuid
        booking_reference:
          type: string
        booking_type:
          type: string
        total_amount:
          type: number
          format: double
        payment_status:
          type: string
        booking_status:
          type: string
        passenger_name:
          type: string
        created_at:
          type: string
          format: date-time
        route_name:
          type: string
        departure_datetime:
          type: string
          format: date-time
        number_of_seats:
          type: integer
        bus_status:
          type: string
        qr_code_data:
          type: string
          nullable: true

    ConfirmPaymentRequest:
      type: object
      required:
        - payment_method
        - payment_reference
        - payment_gateway
      properties:
        payment_method:
          type: string
          example: "card"
        payment_reference:
          type: string
          example: "TXN-123456789"
        payment_gateway:
          type: string
          example: "payhere"

    VerifyBookingResponse:
      type: object
      description: Response after verifying a booking by QR
      properties:
        valid:
          type: boolean
          example: true
        bus_booking_id:
          type: string
          format: uuid
        route_name:
          type: string
        boarding_stop:
          type: string
        alighting_stop:
          type: string
        departure_datetime:
          type: string
          format: date-time
        number_of_seats:
          type: integer
        status:
          type: string
          enum:
            [
              pending,
              confirmed,
              checked_in,
              boarded,
              in_transit,
              completed,
              cancelled,
              no_show,
            ]
        is_checked_in:
          type: boolean
        check_in_time:
          type: string
          format: date-time
          nullable: true
        seats:
          type: array
          items:
            $ref: "#/components/schemas/BusBookingSeat"

  responses:
    BadRequest:
      description: Bad request - Invalid input
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            invalidPhone:
              value:
                error: Invalid phone number
                details: Phone number must be in E.164 format (+94XXXXXXXXX)
            missingField:
              value:
                error: Missing required field
                details: Field 'phone' is required

    Unauthorized:
      description: Unauthorized - Invalid or expired token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            invalidToken:
              value:
                error: Unauthorized
                details: Invalid or expired token
            missingToken:
              value:
                error: Unauthorized
                details: Authorization header required

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            insufficientPermissions:
              value:
                error: Forbidden
                details: You do not have permission to perform this action
            roleRequired:
              value:
                error: Forbidden
                details: Only bus owners can access this resource

    NotFound:
      description: Not Found - Resource does not exist
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            resourceNotFound:
              value:
                error: Not Found
                details: The requested resource does not exist
            tripNotFound:
              value:
                error: Not Found
                details: Trip not found or access denied

    InvalidOtp:
      description: Invalid OTP
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            invalidOtp:
              value:
                error: Invalid OTP
                details: The OTP you entered is incorrect
            expiredOtp:
              value:
                error: OTP expired
                details: OTP has expired, please request a new one
            maxAttemptsExceeded:
              value:
                error: Maximum attempts exceeded
                details: You have exceeded the maximum number of OTP verification attempts

    Conflict:
      description: Conflict - Resource already exists
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            phoneExists:
              value:
                error: Phone number already registered
                details: This phone number is already in use

    RateLimitExceeded:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            tooManyRequests:
              value:
                error: Rate limit exceeded
                details: Maximum 3 OTP requests per 10 minutes. Please try again later.

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            serverError:
              value:
                error: Internal server error
                details: An unexpected error occurred
