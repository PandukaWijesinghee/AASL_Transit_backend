openapi: 3.0.3
info:
  title: SmartTransit SMS Authentication API
  description: |
    SMS-based authentication backend for SmartTransit mobile applications.

    ## Features
    - SMS OTP authentication for passengers
    - Staff registration and verification
    - JWT token-based authorization
    - Profile management
    - Rate limiting and security

    ## Authentication Flow
    1. Request OTP via `/auth/send-otp`
    2. Verify OTP via `/auth/verify-otp` or `/auth/verify-otp-staff`
    3. Receive JWT access & refresh tokens
    4. Use access token for protected endpoints
    5. Refresh token when access token expires

  version: 1.0.0
  contact:
    name: SmartTransit Development Team
    email: dev@smarttransit.lk
  license:
    name: Proprietary

servers:
  - url: https://your-choreo-id.choreo.dev
    description: Production server (Choreo)
  - url: http://localhost:8080
    description: Development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: SMS OTP authentication endpoints
  - name: Admin Authentication
    description: Admin dashboard authentication endpoints (email/password based)
  - name: User
    description: User profile management
  - name: Staff
    description: Staff registration and management
  - name: Bus Owner
    description: Bus owner profile and onboarding management
  - name: Lounge Owner
    description: Lounge owner registration and management
  - name: Permits
    description: Route permit management
  - name: Buses
    description: Bus registration and management
  - name: Trip Schedules
    description: Trip schedule template management
  - name: Scheduled Trips
    description: Generated trip instances and bookings

paths:
  # ============================================================================
  # Health Check Endpoints
  # ============================================================================
  /health:
    get:
      summary: Health check endpoint
      description: Returns service health status and database connectivity
      operationId: getHealth
      tags:
        - Health
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  database:
                    type: string
                    example: healthy
                  version:
                    type: string
                    example: "1.0.0"
                  timestamp:
                    type: integer
                    format: int64
                    example: 1729340000
        "503":
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: unhealthy
                  database:
                    type: string
                    example: unhealthy
                  error:
                    type: string
                    example: database connection failed

  # ============================================================================
  # Debug Endpoints
  # ============================================================================
  /api/v1/debug/headers:
    get:
      summary: Debug request headers and IP detection
      description: |
        Shows all incoming request headers and IP detection results.

        **Use Case:** Troubleshooting IP forwarding issues with reverse proxies.

        **Returns:**
        - All HTTP headers received
        - IP detection from various headers (X-Real-IP, X-Forwarded-For)
        - User-Agent information
      operationId: debugHeaders
      tags:
        - Health
      responses:
        "200":
          description: Debug information
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Debug information for IP detection
                  headers:
                    type: object
                    additionalProperties:
                      type: string
                    example:
                      X-Forwarded-For: "203.94.123.45, 10.100.1.1"
                      User-Agent: "SmartTransit-Staff/1.0.0+1 (Android 13; Samsung SM-G998B)"
                  ip_detection:
                    type: object
                    properties:
                      gin_clientip:
                        type: string
                        example: "203.94.123.45"
                      remote_addr:
                        type: string
                        example: "10.100.1.1:54321"
                      x_real_ip:
                        type: string
                        example: ""
                      x_forwarded_for:
                        type: string
                        example: "203.94.123.45, 10.100.1.1"
                      x_forwarded_host:
                        type: string
                        example: "api.smarttransit.lk"
                      x_forwarded_proto:
                        type: string
                        example: "https"
                  user_agent:
                    type: string
                    example: "SmartTransit-Staff/1.0.0+1 (Android 13; Samsung SM-G998B)"
                  timestamp:
                    type: integer
                    format: int64
                    example: 1729340000

  # ============================================================================
  # Authentication Endpoints
  # ============================================================================
  /api/v1/auth/send-otp:
    post:
      summary: Send OTP to phone number
      description: |
        Sends a 6-digit OTP via SMS to the provided phone number.

        **Rate Limiting:** Maximum 3 requests per 10 minutes per phone number.

        **Development Mode:** If SMS_MODE=dev, OTP is returned in response.

        **Production Mode:** OTP is sent via Dialog SMS Gateway.
      operationId: sendOtp
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  description: Sri Lankan phone number in E.164 format
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
      responses:
        "200":
          description: OTP sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: OTP sent successfully
                  otp:
                    type: string
                    description: Only present in development mode
                    example: "123456"
                  expires_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T08:05:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/verify-otp:
    post:
      summary: Verify OTP and login (Passenger)
      description: |
        Verifies the OTP for passenger users and returns JWT tokens.

        **Maximum Attempts:** 3 invalid attempts allowed.

        **OTP Expiry:** 5 minutes from generation.

        **Auto-Registration:** If phone number doesn't exist, creates new passenger account.
      operationId: verifyOtp
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - otp
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                otp:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
      responses:
        "200":
          description: OTP verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/verify-otp-staff:
    post:
      summary: Verify OTP and login (Staff)
      description: |
        Verifies the OTP for staff users (drivers/conductors) and returns JWT tokens.

        **Staff Only:** User must be registered as staff (driver or conductor).

        **Employment Status Check:** Staff must have employment_status = 'active'.

        **Profile Completion:** Staff must have completed their profile.
      operationId: verifyOtpStaff
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - otp
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                otp:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
      responses:
        "200":
          description: OTP verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StaffAuthResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "403":
          description: Staff not authorized (inactive or incomplete profile)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Staff member is not active or profile incomplete
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/verify-otp-lounge-owner:
    post:
      summary: Verify OTP and login (Lounge Owner)
      description: |
        Verifies the OTP for lounge owner users and returns JWT tokens.

        **Lounge Owner Specific:** Creates user with 'lounge_owner' role if new, or adds role if existing user.

        **Multi-role Support:** Existing users (passengers) can become lounge owners.
      operationId: verifyOtpLoungeOwner
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone_number
                - otp
              properties:
                phone_number:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                  description: Phone number in E.164 format
                otp:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
                  description: 6-digit OTP code
      responses:
        "200":
          description: OTP verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "OTP verified successfully"
                  access_token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  refresh_token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  expires_in_seconds:
                    type: integer
                    example: 3600
                    description: Access token expiry in seconds
                  is_new_user:
                    type: boolean
                    example: true
                    description: Whether this is a newly created user
                  profile_complete:
                    type: boolean
                    example: false
                    description: Whether user has completed their profile
                  roles:
                    type: array
                    items:
                      type: string
                    example: ["lounge_owner"]
                    description: User's roles including lounge_owner
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "404":
          description: No OTP found for phone number
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "no_otp_found"
                  message:
                    type: string
                    example: "No OTP found for this phone number. Please request an OTP first."
                  code:
                    type: string
                    example: "NO_OTP"
        "429":
          description: Too many OTP validation attempts
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "max_attempts_exceeded"
                  message:
                    type: string
                    example: "Maximum OTP validation attempts exceeded. Please request a new OTP."
                  code:
                    type: string
                    example: "MAX_ATTEMPTS"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/otp-status/{phone}:
    get:
      summary: Get OTP status for phone number
      description: Check if OTP exists and is valid for a phone number
      operationId: getOtpStatus
      tags:
        - Authentication
      security: []
      parameters:
        - name: phone
          in: path
          required: true
          description: Phone number in E.164 format
          schema:
            type: string
            pattern: '^\+94[0-9]{9}$'
            example: "+94771234567"
      responses:
        "200":
          description: OTP status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  exists:
                    type: boolean
                    example: true
                  valid:
                    type: boolean
                    example: true
                  expires_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T08:05:00Z"
                  attempts_remaining:
                    type: integer
                    example: 2
        "404":
          description: No OTP found for phone number
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: No OTP found

  /api/v1/auth/refresh-token:
    post:
      summary: Refresh access token
      description: |
        Use refresh token to obtain a new access token.

        **Token Rotation:** Old refresh token is invalidated, new one is issued.
      operationId: refreshToken
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refresh_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  expires_in:
                    type: integer
                    description: Access token expiry in seconds
                    example: 3600
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/refresh:
    post:
      summary: Refresh access token (Alias)
      description: Alias endpoint for mobile compatibility
      operationId: refreshTokenAlias
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  expires_in:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/auth/logout:
    post:
      summary: Logout user
      description: Invalidates the current refresh token
      operationId: logout
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logout successful
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ============================================================================
  # User Profile Endpoints
  # ============================================================================
  /api/v1/user/profile:
    get:
      summary: Get user profile
      description: Retrieve the authenticated user's profile information
      operationId: getUserProfile
      tags:
        - User
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update user profile
      description: Update the authenticated user's profile information
      operationId: updateUserProfile
      tags:
        - User
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: John Doe
                email:
                  type: string
                  format: email
                  example: john.doe@example.com
                nic:
                  type: string
                  example: "199512345678"
                address:
                  type: string
                  example: "123 Main St, Colombo"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Profile updated successfully
                  user:
                    $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Admin Authentication Endpoints
  # ============================================================================
  /api/v1/admin/auth/login:
    post:
      summary: Admin login
      description: Authenticate admin user with email and password
      operationId: adminLogin
      tags:
        - Admin Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: admin@smarttransit.com
                password:
                  type: string
                  format: password
                  example: Admin@123
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refresh_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  expires_in:
                    type: integer
                    format: int64
                    example: 3600
                  admin_user:
                    $ref: "#/components/schemas/AdminUser"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Invalid credentials or account inactive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/v1/admin/auth/refresh:
    post:
      summary: Refresh admin access token
      description: Generate a new access token using a refresh token
      operationId: adminRefreshToken
      tags:
        - Admin Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  expires_in:
                    type: integer
                    format: int64
                  admin_user:
                    $ref: "#/components/schemas/AdminUser"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/admin/auth/logout:
    post:
      summary: Admin logout
      description: Revoke the refresh token
      operationId: adminLogout
      tags:
        - Admin Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        "200":
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        "400":
          $ref: "#/components/responses/BadRequest"

  /api/v1/admin/auth/profile:
    get:
      summary: Get admin profile
      description: Get the authenticated admin user's profile
      operationId: getAdminProfile
      tags:
        - Admin Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Admin profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminUser"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/admin/auth/change-password:
    post:
      summary: Change admin password
      description: Change the authenticated admin user's password
      operationId: changeAdminPassword
      tags:
        - Admin Authentication
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - old_password
                - new_password
              properties:
                old_password:
                  type: string
                  format: password
                new_password:
                  type: string
                  format: password
                  minLength: 8
      responses:
        "200":
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password changed successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/admin/auth/create:
    post:
      summary: Create new admin user
      description: Create a new admin user (requires admin authentication)
      operationId: createAdminUser
      tags:
        - Admin Authentication
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - full_name
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                  minLength: 8
                full_name:
                  type: string
      responses:
        "201":
          description: Admin user created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminUser"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/admin/auth/list:
    get:
      summary: List all admin users
      description: Get a list of all admin users (requires admin authentication)
      operationId: listAdminUsers
      tags:
        - Admin Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Admin users retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AdminUser"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ============================================================================
  # Staff Endpoints
  # ============================================================================
  /api/v1/staff/check-registration:
    post:
      summary: Check staff registration status
      description: Check if a phone number is registered as staff and get registration details
      operationId: checkStaffRegistration
      tags:
        - Staff
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
      responses:
        "200":
          description: Registration status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_registered:
                    type: boolean
                    example: true
                  staff:
                    $ref: "#/components/schemas/BusStaff"
        "404":
          description: Phone number not registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_registered:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Phone number not registered as staff

  /api/v1/staff/register:
    post:
      summary: Register new staff member
      description: |
        Register a new driver or conductor.

        **Requirements:**
        - Valid phone number (not already registered)
        - Valid bus owner ID
        - Staff role (driver or conductor)
        - Initial employment status will be 'pending'
      operationId: registerStaff
      tags:
        - Staff
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - name
                - role
                - bus_owner_id
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                name:
                  type: string
                  example: "John Driver"
                nic:
                  type: string
                  example: "199512345678"
                role:
                  type: string
                  enum: [driver, conductor]
                  example: driver
                bus_owner_id:
                  type: integer
                  example: 1
                license_number:
                  type: string
                  description: Required for drivers
                  example: "B1234567"
      responses:
        "201":
          description: Staff registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Staff registered successfully
                  staff:
                    $ref: "#/components/schemas/BusStaff"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/bus-owners/search:
    get:
      summary: Search bus owners
      description: Search for bus owners by name or NIC
      operationId: searchBusOwners
      tags:
        - Staff
      security: []
      parameters:
        - name: query
          in: query
          required: true
          description: Search query (name or NIC)
          schema:
            type: string
            example: "Perera"
        - name: limit
          in: query
          required: false
          description: Maximum number of results
          schema:
            type: integer
            default: 10
            example: 10
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  bus_owners:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusOwner"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/profile:
    get:
      summary: Get staff profile
      description: Retrieve the authenticated staff member's profile
      operationId: getStaffProfile
      tags:
        - Staff
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Staff profile retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StaffProfile"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update staff profile
      description: Update the authenticated staff member's profile
      operationId: updateStaffProfile
      tags:
        - Staff
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "John Driver"
                nic:
                  type: string
                  example: "199512345678"
                license_number:
                  type: string
                  example: "B1234567"
                address:
                  type: string
                  example: "123 Main St, Colombo"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Profile updated successfully
                  staff:
                    $ref: "#/components/schemas/BusStaff"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Bus Owner Endpoints
  # ============================================================================
  /api/v1/bus-owner/profile:
    get:
      summary: Get bus owner profile
      description: Retrieve the authenticated bus owner's profile
      operationId: getBusOwnerProfile
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusOwnerProfile"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/profile-status:
    get:
      summary: Check bus owner profile completion status
      description: Check if the bus owner has completed onboarding
      operationId: checkBusOwnerProfileStatus
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Status retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
                  phone:
                    type: string
                    example: "+94712345678"
                  profile_completed:
                    type: boolean
                    example: false
                  permit_count:
                    type: integer
                    example: 2
                  has_company_info:
                    type: boolean
                    example: true
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/complete-onboarding:
    post:
      summary: Complete bus owner onboarding
      description: Submit company information and route permits to complete onboarding
      operationId: completeBusOwnerOnboarding
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - company_name
                - identity_or_incorporation_no
                - permits
              properties:
                company_name:
                  type: string
                  example: "ABC Transport Services"
                identity_or_incorporation_no:
                  type: string
                  example: "PV-2023-1234"
                business_email:
                  type: string
                  format: email
                  example: "info@abctransport.lk"
                permits:
                  type: array
                  items:
                    type: object
                    required:
                      - permit_number
                      - bus_registration_number
                      - route_number
                      - from_city
                      - to_city
                      - approved_fare
                      - validity_from
                      - validity_to
                    properties:
                      permit_number:
                        type: string
                        example: "PERMIT-2025-001"
                      bus_registration_number:
                        type: string
                        example: "WP CAB-1234"
                      route_number:
                        type: string
                        example: "138"
                      from_city:
                        type: string
                        example: "Colombo"
                      to_city:
                        type: string
                        example: "Kandy"
                      via:
                        type: string
                        example: "Kadawatha, Kegalle"
                      approved_fare:
                        type: number
                        example: 250.00
                      validity_from:
                        type: string
                        format: date
                        example: "2025-01-01"
                      validity_to:
                        type: string
                        format: date
                        example: "2025-12-31"
      responses:
        "200":
          description: Onboarding completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Onboarding completed successfully
                  profile_completed:
                    type: boolean
                    example: true
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/staff:
    get:
      summary: Get all staff members (drivers and conductors)
      description: |
        Retrieves all drivers and conductors for the authenticated bus owner.
        Returns enriched staff data including user information (name, phone).
      operationId: getStaffMembers
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Staff list retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  staff:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                          example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                        user_id:
                          type: string
                          format: uuid
                          example: "3edeb9af-51c3-4c24-a5d0-76c9dee2d4ea"
                        first_name:
                          type: string
                          example: "Kamal"
                        last_name:
                          type: string
                          example: "Perera"
                        phone:
                          type: string
                          example: "+94712345678"
                        staff_type:
                          type: string
                          enum: [driver, conductor]
                          example: "driver"
                        license_number:
                          type: string
                          example: "NTC1234567"
                        license_expiry_date:
                          type: string
                          format: date-time
                          example: "2026-12-31T00:00:00Z"
                        experience_years:
                          type: integer
                          example: 5
                        employment_status:
                          type: string
                          enum: [active, inactive, suspended, terminated]
                          example: "active"
                        background_check_status:
                          type: string
                          enum: [pending, in_progress, cleared, failed]
                          example: "pending"
                        performance_rating:
                          type: number
                          format: double
                          example: 4.5
                        total_trips_completed:
                          type: integer
                          example: 150
                  total:
                    type: integer
                    example: 2
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Bus owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Bus owner profile not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Add driver or conductor to organization
      description: |
        Allows bus owner to add a driver or conductor directly to their organization.
        NTC license number and expiry date are mandatory for both drivers and conductors.
        If the phone number doesn't exist, a new user account will be created.
        Staff members are pre-approved (employment_status = 'active') and can immediately login via driver/conductor app.
      operationId: addStaffMember
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone_number
                - first_name
                - last_name
                - staff_type
                - ntc_license_number
                - license_expiry_date
              properties:
                phone_number:
                  type: string
                  description: Staff member's phone number (will be used for login)
                  example: "+94712345678"
                first_name:
                  type: string
                  description: Staff member's first name
                  example: "Kamal"
                last_name:
                  type: string
                  description: Staff member's last name
                  example: "Perera"
                staff_type:
                  type: string
                  enum: [driver, conductor]
                  description: Type of staff member
                  example: "driver"
                ntc_license_number:
                  type: string
                  description: NTC (National Transport Commission) license number - MANDATORY
                  example: "NTC1234567"
                license_expiry_date:
                  type: string
                  format: date
                  description: NTC license expiry date (YYYY-MM-DD) - MANDATORY, must be in future
                  example: "2026-12-31"
                experience_years:
                  type: integer
                  description: Years of driving/conducting experience (optional)
                  example: 5
                emergency_contact:
                  type: string
                  description: Emergency contact phone number (optional)
                  example: "+94777654321"
                emergency_contact_name:
                  type: string
                  description: Emergency contact person name (optional)
                  example: "Nimal Perera"
      responses:
        "201":
          description: Staff member added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "driver added successfully"
                  user_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
                  staff_id:
                    type: string
                    format: uuid
                    example: "987e6543-e21b-98d3-a654-426614174999"
                  staff_type:
                    type: string
                    example: "driver"
                  instructions:
                    type: string
                    example: "Staff member can now login using phone number +94712345678"
        "400":
          description: Bad request - validation failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "NTC license has already expired"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Bus owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Bus owner profile not found. Please complete onboarding first."
        "409":
          description: Conflict - staff already registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "This phone number is already registered as driver"
                  staff_type:
                    type: string
                    example: "driver"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Bus Owner Routes (Custom Route Configurations)
  # ============================================================================
  /api/v1/bus-owner-routes:
    post:
      summary: Create custom route configuration
      description: |
        Create a custom route configuration with selected stops for UP or DOWN direction.
        First and last stops must be included.
      operationId: createBusOwnerRoute
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - master_route_id
                - custom_route_name
                - direction
                - selected_stop_ids
              properties:
                master_route_id:
                  type: string
                  format: uuid
                  example: "a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d"
                custom_route_name:
                  type: string
                  example: "Colombo Badulla Route for BlueBus"
                direction:
                  type: string
                  enum: [UP, DOWN]
                  example: "UP"
                selected_stop_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 2
                  example: ["stop-id-1", "stop-id-2", "stop-id-3"]
      responses:
        "201":
          description: Route created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusOwnerRoute"
        "400":
          description: Bad request - validation failed
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Get all custom routes
      description: Retrieve all custom route configurations for the authenticated bus owner
      operationId: getBusOwnerRoutes
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Routes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  routes:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusOwnerRoute"
                  count:
                    type: integer
                    example: 3
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner-routes/{id}:
    get:
      summary: Get custom route by ID
      description: Retrieve a specific custom route configuration
      operationId: getBusOwnerRouteById
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Route retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusOwnerRoute"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Route not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update custom route
      description: Update an existing custom route configuration
      operationId: updateBusOwnerRoute
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                custom_route_name:
                  type: string
                  example: "Updated Route Name"
                selected_stop_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 2
      responses:
        "200":
          description: Route updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusOwnerRoute"
        "400":
          description: Bad request - validation failed
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Route not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete custom route
      description: Delete a custom route configuration
      operationId: deleteBusOwnerRoute
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Route deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Route deleted successfully"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Route not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner-routes/by-master-route/{master_route_id}:
    get:
      summary: Get custom routes by master route
      description: Retrieve all custom routes for a specific master route
      operationId: getBusOwnerRoutesByMasterRoute
      tags:
        - Bus Owner Routes
      security:
        - BearerAuth: []
      parameters:
        - name: master_route_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Routes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  routes:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusOwnerRoute"
                  count:
                    type: integer
                    example: 2
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Timetable Endpoints (New Timetable-Based Scheduling System)
  # ============================================================================
  /api/v1/timetables:
    post:
      summary: Create a new timetable (repeating trip schedule)
      description: |
        Creates a timetable for automatic trip generation. Upon creation, the system immediately generates 
        trips for the next 7 days (configurable via system_settings.trip_generation_days_ahead). 

        A daily cron job (runs at 2 AM) maintains a rolling 7-day window by generating new trips for upcoming dates.

        After creation, use the publish endpoints to make trips available for passenger booking (is_bookable=true).
      operationId: createTimetable
      tags:
        - Timetables
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - custom_route_id
                - departure_time
                - base_fare
                - max_bookable_seats
                - recurrence_type
                - valid_from
              properties:
                custom_route_id:
                  type: string
                  format: uuid
                  description: Reference to bus owner's custom route configuration
                permit_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: Optional route permit ID (can be NULL if not assigned yet)
                schedule_name:
                  type: string
                  example: "Morning Express Colombo-Badulla"
                  description: Optional descriptive name for the timetable
                valid_from:
                  type: string
                  format: date
                  example: "2025-11-08"
                  description: Start date for trip generation (YYYY-MM-DD format, required)
                valid_until:
                  type: string
                  format: date
                  nullable: true
                  example: "2025-12-31"
                  description: End date for trip generation (YYYY-MM-DD format, optional - NULL means continuous)
                departure_time:
                  type: string
                  pattern: "^([0-1][0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$"
                  example: "09:30"
                  description: Departure time in HH:MM or HH:MM:SS format
                estimated_duration_minutes:
                  type: integer
                  minimum: 1
                  example: 420
                  description: Estimated trip duration in minutes (optional - will be calculated from route if not provided)
                base_fare:
                  type: number
                  format: double
                  minimum: 0
                  example: 850.00
                  description: Must be  permit approved_fare
                max_bookable_seats:
                  type: integer
                  minimum: 1
                  example: 45
                  description: Must be  permit approved_seating_capacity
                is_bookable:
                  type: boolean
                  default: true
                  description: Whether trip allows online bookings
                booking_advance_hours:
                  type: integer
                  minimum: 72
                  example: 72
                  description: Hours before departure that booking opens (72, defaults to system setting)
                recurrence_type:
                  type: string
                  enum: [daily, weekly, interval]
                  description: How often the trip repeats
                recurrence_days:
                  type: array
                  items:
                    type: integer
                    minimum: 0
                    maximum: 6
                  example: [1, 3, 5]
                  description: Required for weekly. Days of week (0=Sunday, 6=Saturday)
                recurrence_interval:
                  type: integer
                  minimum: 2
                  example: 3
                  description: Required for interval. Repeat every N days
                notes:
                  type: string
                  maxLength: 500
                  description: Optional notes about the timetable
      responses:
        "201":
          description: Timetable created successfully with instant trip generation
          content:
            application/json:
              schema:
                type: object
                properties:
                  schedule:
                    $ref: "#/components/schemas/TripSchedule"
                  trips_generated:
                    type: integer
                    example: 7
                    description: Number of trips automatically generated for the next 7 days
                  message:
                    type: string
                    example: "Timetable created successfully. Trips generated for next 7 days."
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Access denied - not owner of route/permit
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Special Trip Endpoints (One-Time Trips)
  # ============================================================================
  /api/v1/special-trips:
    post:
      summary: Create a special one-time trip (not from timetable)
      description: |
        Creates a single trip that is not part of a repeating timetable. If the trip date is too soon
        (past the assignment deadline), bus assignment is mandatory.
      operationId: createSpecialTrip
      tags:
        - Special Trips
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - custom_route_id
                - departure_datetime
                - base_fare
                - max_bookable_seats
              properties:
                custom_route_id:
                  type: string
                  format: uuid
                  description: Reference to bus owner's custom route
                permit_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: Optional route permit ID (can be NULL if not assigned yet)
                departure_datetime:
                  type: string
                  format: date-time
                  example: "2024-12-25T10:00:00Z"
                  description: "Trip departure date and time in ISO 8601 format (YYYY-MM-DDTHH:MM:SS). Cannot be in past."
                estimated_duration_minutes:
                  type: integer
                  minimum: 1
                  example: 390
                  description: "Estimated trip duration in minutes. Arrival datetime will be calculated as departure_datetime + duration."
                base_fare:
                  type: number
                  format: double
                  minimum: 0
                  description: Must be  permit approved_fare
                max_bookable_seats:
                  type: integer
                  minimum: 1
                  description: Must be  permit approved_seating_capacity
                is_bookable:
                  type: boolean
                  default: true
                booking_advance_hours:
                  type: integer
                  minimum: 72
                  description: Hours before trip that booking opens (72)
                bus_id:
                  type: string
                  format: uuid
                  description: Required if trip is soon (within assignment deadline)
                assigned_driver_id:
                  type: string
                  format: uuid
                assigned_conductor_id:
                  type: string
                  format: uuid
      responses:
        "201":
          description: Special trip created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  trip_schedule_id:
                    type: string
                    nullable: true
                    description: Always null for special trips
                  custom_route_id:
                    type: string
                    format: uuid
                  departure_datetime:
                    type: string
                    format: date-time
                    example: "2024-12-25T10:00:00Z"
                  actual_arrival_datetime:
                    type: string
                    format: date-time
                    nullable: true
                    example: "2024-12-25T16:30:00Z"
                  status:
                    type: string
                    enum:
                      [scheduled, confirmed, in_progress, completed, cancelled]
        "400":
          description: Bad request - validation failed or trip too soon without bus assignment
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  details:
                    type: object
                    properties:
                      assignment_deadline:
                        type: string
                        format: date-time
                      current_time:
                        type: string
                        format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Access denied
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # System Settings Endpoints
  # ============================================================================
  /api/v1/system-settings:
    get:
      summary: Get all system settings
      description: Retrieves all system configuration settings
      operationId: getAllSystemSettings
      tags:
        - System Settings
      security:
        - BearerAuth: []
      responses:
        "200":
          description: System settings retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    setting_key:
                      type: string
                      example: "booking_advance_hours_default"
                    setting_value:
                      type: string
                      example: "72"
                    description:
                      type: string
                      example: "Default minimum hours before trip departure that booking opens"
                    created_at:
                      type: string
                      format: date-time
                    updated_at:
                      type: string
                      format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/system-settings/{key}:
    get:
      summary: Get a specific system setting by key
      operationId: getSystemSettingByKey
      tags:
        - System Settings
      security:
        - BearerAuth: []
      parameters:
        - name: key
          in: path
          required: true
          schema:
            type: string
          example: "booking_advance_hours_default"
          description: Setting key name
      responses:
        "200":
          description: Setting retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  setting_key:
                    type: string
                  setting_value:
                    type: string
                  description:
                    type: string
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Setting not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update a system setting value
      description: |
        Updates a system setting value. Note: In production, this should be admin-only.
        Available settings:
        - booking_advance_hours_default: Default hours before trip that booking opens (72)
        - assignment_deadline_hours: Hours before departure to assign bus/staff (default: 2)
      operationId: updateSystemSetting
      tags:
        - System Settings
      security:
        - BearerAuth: []
      parameters:
        - name: key
          in: path
          required: true
          schema:
            type: string
          example: "booking_advance_hours_default"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - setting_value
              properties:
                setting_value:
                  type: string
                  example: "96"
                  description: New value for the setting
      responses:
        "200":
          description: Setting updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  setting_key:
                    type: string
                  setting_value:
                    type: string
                  updated_at:
                    type: string
                    format: date-time
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Setting not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Lounge Owner Endpoints
  # ============================================================================
  /api/v1/lounge-owner/register/business-info:
    post:
      summary: Save business and manager information
      description: |
        Step 1 of lounge owner registration - save business and manager details.
        Requires authenticated user with 'lounge_owner' role.
      operationId: saveLoungeOwnerBusinessInfo
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - business_name
                - manager_full_name
                - manager_nic_number
              properties:
                business_name:
                  type: string
                  minLength: 3
                  maxLength: 255
                  example: "Grand Hotel Colombo"
                  description: Business/Hotel name
                business_license:
                  type: string
                  maxLength: 100
                  example: "BR2024123456"
                  description: Business registration number (optional)
                manager_full_name:
                  type: string
                  minLength: 3
                  maxLength: 255
                  example: "John Doe"
                  description: Manager's full legal name
                manager_nic_number:
                  type: string
                  pattern: "^[0-9]{9}[VXvx]$|^[0-9]{12}$"
                  example: "200012345678"
                  description: Manager's NIC (one person can manage only one business)
                manager_email:
                  type: string
                  format: email
                  example: "manager@grandhotel.com"
                  description: Manager's email address (optional)
      responses:
        "200":
          description: Business and manager information saved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Business and manager information saved successfully"
                  registration_step:
                    type: string
                    example: "business_info"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/register/upload-manager-nic:
    post:
      summary: Upload manager NIC front and back images
      description: |
        Step 2 of lounge owner registration - upload manager's NIC images for verification.
      operationId: uploadManagerNIC
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - manager_nic_front_url
                - manager_nic_back_url
              properties:
                manager_nic_front_url:
                  type: string
                  format: uri
                  example: "https://storage.supabase.co/path/to/manager_nic_front.jpg"
                  description: URL to manager NIC front image (upload to Supabase Storage first)
                manager_nic_back_url:
                  type: string
                  format: uri
                  example: "https://storage.supabase.co/path/to/manager_nic_back.jpg"
                  description: URL to manager NIC back image (upload to Supabase Storage first)
      responses:
        "200":
          description: Manager NIC images uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Manager NIC images uploaded successfully"
                  registration_step:
                    type: string
                    example: "nic_uploaded"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/register/add-lounge:
    post:
      summary: Add lounge with pricing information
      description: |
        Step 3 of lounge owner registration - add lounge location and pricing.
        Can be called multiple times to add multiple lounges.
        Includes pricing for 3 types: 1 hour, 2 hours, until bus arrives.
      operationId: addLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lounge_name
                - address
                - city
                - contact_phone
              properties:
                lounge_name:
                  type: string
                  minLength: 3
                  maxLength: 255
                  example: "City Central Lounge"
                  description: Name of the lounge
                address:
                  type: string
                  minLength: 10
                  example: "123 Main St, Colombo 7"
                  description: Full address of the lounge
                city:
                  type: string
                  example: "Colombo"
                  description: City where lounge is located
                contact_phone:
                  type: string
                  example: "+94112345678"
                  description: Contact phone number for the lounge
                latitude:
                  type: string
                  example: "6.9271"
                  description: GPS latitude coordinate (as string)
                longitude:
                  type: string
                  example: "79.8612"
                  description: GPS longitude coordinate (as string)
                price_1_hour:
                  type: string
                  example: "500.00"
                  description: Price in LKR for 1 hour access (DECIMAL as string)
                price_2_hours:
                  type: string
                  example: "900.00"
                  description: Price in LKR for 2 hours access (DECIMAL as string)
                price_until_bus:
                  type: string
                  example: "1500.00"
                  description: Price in LKR for access until bus arrives (DECIMAL as string)
                amenities:
                  type: array
                  items:
                    type: string
                  example: ["WiFi", "AC", "Charging", "Cafe", "Shower"]
                  description: List of amenities available
                images:
                  type: array
                  items:
                    type: string
                    format: uri
                  example:
                    [
                      "https://storage.supabase.co/lounge1.jpg",
                      "https://storage.supabase.co/lounge2.jpg",
                    ]
                  description: Array of lounge image URLs
      responses:
        "201":
          description: Lounge added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Lounge added successfully"
                  lounge_id:
                    type: string
                    format: uuid
                    example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                  registration_step:
                    type: string
                    example: "lounge_added"
                  status:
                    type: string
                    example: "pending"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/registration/progress:
    get:
      summary: Get registration progress
      description: |
        Get current registration status and what steps have been completed.
      operationId: getLoungeOwnerRegistrationProgress
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Registration progress retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  registration_step:
                    type: string
                    enum:
                      [
                        "phone_verified",
                        "business_info",
                        "nic_uploaded",
                        "lounge_added",
                        "completed",
                      ]
                    example: "business_info"
                  profile_completed:
                    type: boolean
                    example: false
                  verification_status:
                    type: string
                    enum: ["pending", "approved", "rejected"]
                    example: "pending"
                  total_lounges:
                    type: integer
                    example: 0
                  total_staff:
                    type: integer
                    example: 0
                  steps:
                    type: object
                    properties:
                      phone_verified:
                        type: boolean
                        example: true
                      business_info:
                        type: boolean
                        example: true
                      nic_uploaded:
                        type: boolean
                        example: false
                      lounge_added:
                        type: boolean
                        example: false
                      completed:
                        type: boolean
                        example: false
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Lounge owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Lounge owner profile not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/profile:
    get:
      summary: Get lounge owner profile
      description: |
        Retrieve complete lounge owner profile including personal information and registration status.
      operationId: getLoungeOwnerProfile
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                    example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                  user_id:
                    type: string
                    format: uuid
                    example: "3edeb9af-51c3-4c24-a5d0-76c9dee2d4ea"
                  business_name:
                    type: string
                    example: "Grand Hotel Colombo"
                  business_license:
                    type: string
                    example: "BR2024123456"
                  manager_full_name:
                    type: string
                    example: "John Doe"
                  manager_nic_number:
                    type: string
                    example: "200012345678"
                  manager_email:
                    type: string
                    example: "manager@grandhotel.com"
                  manager_nic_front:
                    type: string
                    format: uri
                    example: "https://storage.supabase.co/path/to/manager_nic_front.jpg"
                  manager_nic_back:
                    type: string
                    format: uri
                    example: "https://storage.supabase.co/path/to/manager_nic_back.jpg"
                  registration_step:
                    type: string
                    enum:
                      [
                        "phone_verified",
                        "business_info",
                        "nic_uploaded",
                        "lounge_added",
                        "completed",
                      ]
                    example: "completed"
                  profile_completed:
                    type: boolean
                    example: true
                  verification_status:
                    type: string
                    enum: ["pending", "approved", "rejected"]
                    example: "pending"
                  total_lounges:
                    type: integer
                    example: 2
                  total_staff:
                    type: integer
                    example: 5
                  created_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T10:30:00Z"
                  updated_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T11:00:00Z"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Lounge owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Lounge owner profile not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Lounge Management Endpoints
  # ============================================================================
  /api/v1/lounges/my-lounges:
    get:
      summary: Get all my lounges
      description: |
        Retrieve all lounges owned by the authenticated lounge owner with pricing and amenities.
      operationId: getMyLounges
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Lounges retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  lounges:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        lounge_name:
                          type: string
                          example: "City Central Lounge"
                        address:
                          type: string
                        city:
                          type: string
                        contact_phone:
                          type: string
                        latitude:
                          type: string
                        longitude:
                          type: string
                        price_1_hour:
                          type: string
                          example: "500.00"
                        price_2_hours:
                          type: string
                          example: "900.00"
                        price_until_bus:
                          type: string
                          example: "1500.00"
                        amenities:
                          type: array
                          items:
                            type: string
                        images:
                          type: array
                          items:
                            type: string
                        status:
                          type: string
                          enum: ["pending", "active", "inactive", "suspended"]
                        is_operational:
                          type: boolean
                        total_staff:
                          type: integer
                        average_rating:
                          type: string
                        total_bookings:
                          type: integer
                        created_at:
                          type: string
                          format: date-time
                  total:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{id}:
    get:
      summary: Get lounge by ID
      description: Get detailed information about a specific lounge
      operationId: getLoungeByID
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Lounge details retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Lounge"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update lounge
      description: Update lounge information including pricing
      operationId: updateLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lounge_name
                - address
                - city
                - contact_phone
              properties:
                lounge_name:
                  type: string
                address:
                  type: string
                city:
                  type: string
                contact_phone:
                  type: string
                latitude:
                  type: string
                longitude:
                  type: string
                price_1_hour:
                  type: string
                price_2_hours:
                  type: string
                price_until_bus:
                  type: string
                amenities:
                  type: array
                  items:
                    type: string
                images:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: Lounge updated successfully
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete lounge
      description: Delete a lounge (triggers will update counts)
      operationId: deleteLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Lounge deleted successfully
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/city/{city}:
    get:
      summary: Get lounges by city (Public)
      description: Search for active lounges in a specific city - no authentication required
      operationId: getLoungesByCity
      tags:
        - Lounge Owner
      parameters:
        - name: city
          in: path
          required: true
          schema:
            type: string
          example: "Colombo"
      responses:
        "200":
          description: Lounges retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  lounges:
                    type: array
                    items:
                      $ref: "#/components/schemas/Lounge"
                  total:
                    type: integer
                  city:
                    type: string
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Lounge Staff Management Endpoints
  # ============================================================================
  /api/v1/lounges/{lounge_id}/staff:
    post:
      summary: Add staff to lounge
      description: |
        Step 4 (optional) - Add staff member to a specific lounge.
        Staff will be invited and can register later.
      operationId: addStaffToLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lounge_id
                - phone_number
                - full_name
                - nic_number
                - permission_type
              properties:
                lounge_id:
                  type: string
                  format: uuid
                phone_number:
                  type: string
                  example: "+94771234567"
                full_name:
                  type: string
                  example: "Jane Smith"
                nic_number:
                  type: string
                  example: "199812345678"
                permission_type:
                  type: string
                  enum: ["admin", "staff"]
                  example: "staff"
                  description: "admin = full access, staff = view-only"
      responses:
        "201":
          description: Staff added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  staff_id:
                    type: string
                    format: uuid
                  phone_number:
                    type: string
                  permission_type:
                    type: string
                  has_registered:
                    type: boolean
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Get staff for lounge
      description: Get all staff members assigned to a specific lounge
      operationId: getStaffByLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Staff list retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  staff:
                    type: array
                    items:
                      $ref: "#/components/schemas/LoungeStaff"
                  total:
                    type: integer
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{lounge_id}/staff/{staff_id}/permission:
    put:
      summary: Update staff permission
      description: Change staff permission type between admin and staff
      operationId: updateStaffPermission
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: staff_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - permission_type
              properties:
                permission_type:
                  type: string
                  enum: ["admin", "staff"]
      responses:
        "200":
          description: Permission updated
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{lounge_id}/staff/{staff_id}/status:
    put:
      summary: Update staff employment status
      description: Update staff employment status (active, inactive, suspended)
      operationId: updateStaffStatus
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: staff_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - employment_status
              properties:
                employment_status:
                  type: string
                  enum: ["active", "inactive", "terminated"]
      responses:
        "200":
          description: Status updated
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounges/{lounge_id}/staff/{staff_id}:
    delete:
      summary: Remove staff from lounge
      description: Remove a staff member from the lounge (triggers will update counts)
      operationId: removeStaff
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      parameters:
        - name: lounge_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: staff_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Staff removed successfully
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/my-profile:
    get:
      summary: Get staff member profile
      description: Staff members can view their assigned lounge and profile information
      operationId: getMyStaffProfile
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Staff profile retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/LoungeStaff"
                  - type: object
                    properties:
                      lounge:
                        type: object
                        properties:
                          id:
                            type: string
                            format: uuid
                          lounge_name:
                            type: string
                          address:
                            type: string
                          city:
                            type: string
                          status:
                            type: string
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Master Routes Endpoints
  # ============================================================================
  /api/v1/master-routes:
    get:
      summary: Get all master routes
      description: Retrieve all active master routes for dropdown selection in permit forms
      operationId: getAllMasterRoutes
      tags:
        - Master Routes
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Master routes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  master_routes:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                          description: Unique identifier for the route
                        route_number:
                          type: string
                          description: Route number (e.g., "99-1")
                          example: "99-1"
                        route_name:
                          type: string
                          description: Name of the route
                          example: "Badulla - Colombo Express"
                        origin_city:
                          type: string
                          description: Starting city
                          example: "Badulla"
                        destination_city:
                          type: string
                          description: Ending city
                          example: "Colombo"
                        total_distance_km:
                          type: number
                          format: float
                          description: Total distance in kilometers
                          example: 230.5
                        estimated_duration_minutes:
                          type: integer
                          description: Estimated journey time in minutes
                          example: 360
                        display_label:
                          type: string
                          description: Formatted label for display in dropdown
                          example: "99-1 - Badulla  Colombo (230.5 km)"
                  count:
                    type: integer
                    description: Total number of routes returned
                    example: 1
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/master-routes/{id}:
    get:
      summary: Get master route by ID
      description: Retrieve detailed information about a specific master route
      operationId: getMasterRouteById
      tags:
        - Master Routes
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Master route ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Master route retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  route_number:
                    type: string
                    example: "99-1"
                  route_name:
                    type: string
                    example: "Badulla - Colombo Express"
                  origin_city:
                    type: string
                    example: "Badulla"
                  destination_city:
                    type: string
                    example: "Colombo"
                  total_distance_km:
                    type: number
                    format: float
                    example: 230.5
                  estimated_duration_minutes:
                    type: integer
                    example: 360
                  encoded_polyline:
                    type: string
                    description: Encoded polyline for map visualization
                  is_active:
                    type: boolean
                    example: true
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Permit Endpoints
  # ============================================================================
  /api/v1/permits:
    get:
      summary: Get all permits
      description: Retrieve all route permits for authenticated bus owner
      operationId: getAllPermits
      tags:
        - Permits
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Permits retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  permits:
                    type: array
                    items:
                      $ref: "#/components/schemas/RoutePermit"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Create new permit
      description: Create a new route permit
      operationId: createPermit
      tags:
        - Permits
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePermitRequest"
      responses:
        "201":
          description: Permit created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Permit created successfully
                  permit:
                    $ref: "#/components/schemas/RoutePermit"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/permits/valid:
    get:
      summary: Get valid permits
      description: Retrieve only valid (non-expired) route permits
      operationId: getValidPermits
      tags:
        - Permits
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Valid permits retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  permits:
                    type: array
                    items:
                      $ref: "#/components/schemas/RoutePermit"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/permits/{id}:
    get:
      summary: Get permit by ID
      description: Retrieve a specific route permit by ID
      operationId: getPermitById
      tags:
        - Permits
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Permit retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoutePermit"
        "404":
          description: Permit not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update permit
      description: Update an existing route permit
      operationId: updatePermit
      tags:
        - Permits
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePermitRequest"
      responses:
        "200":
          description: Permit updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Permit updated successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Permit not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete permit
      description: Delete a route permit
      operationId: deletePermit
      tags:
        - Permits
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Permit deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Permit deleted successfully
        "404":
          description: Permit not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/permits/{permitId}/route-details:
    get:
      summary: Get route details with polyline and stops
      description: Retrieve master route polyline and predefined stops for map visualization in schedule creation wizard
      operationId: getPermitRouteDetails
      tags:
        - Route Permits
      security:
        - BearerAuth: []
      parameters:
        - name: permitId
          in: path
          required: true
          description: Permit UUID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Route details retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  permit:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      permit_number:
                        type: string
                        example: "PER-2024-001"
                      route_name:
                        type: string
                        example: "Colombo - Kandy Express"
                  route:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      route_number:
                        type: string
                        example: "01"
                      route_name:
                        type: string
                        example: "Negombo - Kandy Intercity"
                      origin_city:
                        type: string
                        example: "Negombo"
                      destination_city:
                        type: string
                        example: "Kandy"
                      total_distance_km:
                        type: number
                        example: 107.3
                      estimated_duration_minutes:
                        type: integer
                        example: 180
                      encoded_polyline:
                        type: string
                        example: "ic~`Awr{xM}AkAaBsAcBqA..."
                        description: Google Maps encoded polyline string for route visualization
                  stops:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        master_route_id:
                          type: string
                          format: uuid
                        stop_name:
                          type: string
                          example: "Negombo Bus Stand"
                        stop_order:
                          type: integer
                          example: 1
                        latitude:
                          type: number
                          example: 7.2089
                        longitude:
                          type: number
                          example: 79.8358
                        arrival_time_offset_minutes:
                          type: integer
                          example: 0
                          description: Minutes from origin (0 for starting point)
                        is_major_stop:
                          type: boolean
                          example: true
                        created_at:
                          type: string
                          format: date-time
        "404":
          description: Permit not found or no master route associated
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "No master route associated with this permit"
                  message:
                    type: string
                    example: "This permit does not have route polyline data"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Access denied (not permit owner)
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Bus Endpoints
  # ============================================================================
  /api/v1/buses:
    get:
      summary: Get all buses
      description: Retrieve all buses owned by the authenticated bus owner
      operationId: getAllBuses
      tags:
        - Buses
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of buses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bus"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Create new bus
      description: Register a new bus under a route permit
      operationId: createBus
      tags:
        - Buses
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBusRequest"
      responses:
        "201":
          description: Bus created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "400":
          description: Invalid request or validation error
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Permit not found
        "409":
          description: Bus already registered under this permit
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/buses/{id}:
    get:
      summary: Get bus by ID
      description: Retrieve a specific bus by ID
      operationId: getBusById
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Bus details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Permission denied (bus belongs to another owner)
        "404":
          description: Bus not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update bus
      description: Update bus information
      operationId: updateBus
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateBusRequest"
      responses:
        "200":
          description: Bus updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "400":
          description: Invalid request
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Permission denied
        "404":
          description: Bus not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete bus
      description: Delete a bus
      operationId: deleteBus
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Bus deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Bus deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Bus not found or permission denied
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/buses/status/{status}:
    get:
      summary: Get buses by status
      description: Retrieve buses filtered by operational status
      operationId: getBusesByStatus
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: path
          required: true
          schema:
            type: string
            enum: [active, maintenance, inactive]
      responses:
        "200":
          description: List of buses with specified status
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bus"
        "400":
          description: Invalid status parameter
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Trip Schedule Endpoints
  # ============================================================================
  /api/v1/trip-schedules:
    post:
      summary: Create trip schedule
      description: Create a new trip schedule template. Trips are generated instantly for the next 14 days.
      operationId: createTripSchedule
      tags:
        - Trip Schedules
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - permit_id
                - recurrence_type
                - departure_time
                - direction
                - trips_per_day
                - base_fare
                - valid_from
              properties:
                permit_id:
                  type: string
                  format: uuid
                bus_id:
                  type: string
                  format: uuid
                  description: "Default bus for this schedule"
                schedule_name:
                  type: string
                  example: "Morning Express"
                recurrence_type:
                  type: string
                  enum: [daily, weekly, specific_dates]
                recurrence_days:
                  type: array
                  items:
                    type: integer
                    minimum: 0
                    maximum: 6
                  description: "Days of week: 0=Sunday, 6=Saturday (for weekly)"
                specific_dates:
                  type: array
                  items:
                    type: string
                    format: date
                  description: "List of specific dates (for specific_dates type)"
                departure_time:
                  type: string
                  example: "08:00:00"
                estimated_duration_minutes:
                  type: integer
                  minimum: 1
                  example: 420
                  description: "Estimated trip duration in minutes (optional - will be calculated from route if not provided)"
                is_overnight_trip:
                  type: boolean
                  default: false
                  description: "Indicates if the bus arrives the next day (e.g., departs 10 PM, arrives 5 AM). Used to calculate duration accurately."
                direction:
                  type: string
                  enum: [UP, DOWN, ROUND_TRIP]
                  example: "UP"
                  description: "Trip direction: UP (origin to destination), DOWN (destination to origin), or ROUND_TRIP (both)"
                trips_per_day:
                  type: integer
                  minimum: 1
                  maximum: 10
                  example: 2
                  description: "Number of trips per day (1-10)"
                base_fare:
                  type: number
                  format: double
                is_bookable:
                  type: boolean
                  default: true
                max_bookable_seats:
                  type: integer
                  example: 45
                  description: "Maximum seats available for booking"
                advance_booking_hours:
                  type: integer
                  default: 24
                  description: "How many hours in advance booking is allowed"
                default_driver_id:
                  type: string
                  format: uuid
                  description: "Default driver for trips"
                default_conductor_id:
                  type: string
                  format: uuid
                  description: "Default conductor for trips"
                selected_stop_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: "Selected master route stops for this schedule"
                valid_from:
                  type: string
                  format: date
                valid_until:
                  type: string
                  format: date
                notes:
                  type: string
      responses:
        "201":
          description: Schedule created and trips generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  schedule:
                    $ref: "#/components/schemas/TripSchedule"
                  trips_generated:
                    type: integer
                    example: 14
                  message:
                    type: string
                    example: "Schedule created successfully"
        "400":
          description: Invalid input
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Get all trip schedules
      description: Retrieve all trip schedules for the authenticated bus owner
      operationId: getAllTripSchedules
      tags:
        - Trip Schedules
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of trip schedules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TripSchedule"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/trip-schedules/{id}:
    get:
      summary: Get trip schedule by ID
      description: Retrieve a specific trip schedule
      operationId: getTripScheduleById
      tags:
        - Trip Schedules
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Trip schedule details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TripSchedule"
        "404":
          description: Schedule not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update trip schedule
      description: Update an existing trip schedule and regenerate trips
      operationId: updateTripSchedule
      tags:
        - Trip Schedules
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                recurrence_type:
                  type: string
                  enum: [daily, weekly, specific_dates]
                recurrence_days:
                  type: array
                  items:
                    type: integer
                departure_time:
                  type: string
                base_fare:
                  type: number
                is_bookable:
                  type: boolean
                valid_until:
                  type: string
                  format: date
      responses:
        "200":
          description: Schedule updated successfully
        "404":
          description: Schedule not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Scheduled Trip Endpoints
  # ============================================================================
  /api/v1/scheduled-trips:
    get:
      summary: Get scheduled trips by date range
      description: |
        Retrieve scheduled trips within a specified date range for the authenticated bus owner.

        Efficient filtering logic:
        1. Gets bus_owner_id from authenticated user
        2. Queries trip_schedules table: WHERE bus_owner_id = X
        3. Extracts schedule IDs
        4. Queries scheduled_trips: WHERE trip_schedule_id IN (...) AND DATE(departure_datetime) BETWEEN start AND end

        This ensures only trips from the bus owner's timetables are returned,
        using a single optimized SQL query with IN clause.
      operationId: getScheduledTrips
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date
          example: "2025-11-01"
        - name: end_date
          in: query
          required: true
          schema:
            type: string
            format: date
          example: "2025-11-15"
      responses:
        "200":
          description: List of scheduled trips
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ScheduledTrip"
        "400":
          description: Invalid date range
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}:
    get:
      summary: Get scheduled trip by ID
      description: Retrieve details of a specific scheduled trip
      operationId: getScheduledTripById
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Scheduled trip details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScheduledTrip"
        "404":
          description: Trip not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    patch:
      summary: Update scheduled trip
      description: |
        Update scheduled trip details including:
        - Staff assignment (driver, conductor)
        - Trip status
        - Route override (with validation)

        **Route Override Rules:**
        When updating `bus_owner_route_id`, the new route must:
        - Use the same master_route_id as the schedule's route
        - Have the same direction (UP/DOWN) as the schedule's route
        - Be valid for the assigned permit (if permit is assigned)

        Route overrides allow trips to use different stop selections while maintaining the same master route and direction.
      operationId: updateScheduledTrip
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                bus_owner_route_id:
                  type: string
                  format: uuid
                  description: |
                    Optional route override. Must match schedule's master route and direction.
                    Validated against business rules before accepting.
                assigned_driver_id:
                  type: string
                  format: uuid
                  description: Assign or update the driver for this trip
                assigned_conductor_id:
                  type: string
                  format: uuid
                  description: Assign or update the conductor for this trip
                status:
                  type: string
                  enum:
                    [scheduled, confirmed, in_progress, completed, cancelled]
                  description: Update the trip status
      responses:
        "200":
          description: Trip updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScheduledTrip"
        "400":
          description: Validation failed (e.g., route override rejected due to mismatched master route or direction)
        "404":
          description: Trip not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/publish:
    put:
      summary: Publish a scheduled trip for booking
      description: Make a scheduled trip available for passenger booking by setting is_bookable=true. Only the trip owner can publish their trips.
      operationId: publishScheduledTrip
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the trip to publish
      responses:
        "200":
          description: Trip published successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Trip published successfully"
                  trip_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
        "400":
          description: Invalid trip ID
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Only bus owners can publish trips
        "404":
          description: Trip not found or access denied
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/unpublish:
    put:
      summary: Remove a scheduled trip from booking
      description: Remove a scheduled trip from passenger booking by setting is_bookable=false. Only the trip owner can unpublish their trips.
      operationId: unpublishScheduledTrip
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the trip to unpublish
      responses:
        "200":
          description: Trip unpublished successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Trip unpublished successfully"
                  trip_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
        "400":
          description: Invalid trip ID
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Only bus owners can unpublish trips
        "404":
          description: Trip not found or access denied
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/{id}/assign:
    patch:
      summary: Assign staff and permit to a scheduled trip
      description: |
        Assign driver, conductor, and/or route permit to a scheduled trip.

        Ownership Verification:
        - Trip must have either trip_schedule_id OR bus_owner_route_id to verify ownership
        - Only the bus owner who created the trip can assign staff/permits
        - Detailed logs are generated for debugging ownership verification failures

        This endpoint validates:
        - Staff belongs to the bus owner's organization
        - Staff has correct type (driver/conductor) and is actively employed
        - Staff licenses are not expired on trip date
        - Permit status must be "verified" (not "pending" or "rejected")
        - Permit is valid on trip date (not expired)
        - Permit covers the trip's route

        Error Logging:
        - Logs trip ownership details (trip_schedule_id, bus_owner_route_id)
        - Logs schedule and route ownership verification steps
        - Helps diagnose ownership verification failures
      operationId: assignStaffAndPermit
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the trip to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                driver_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: UUID of the driver to assign
                  example: "123e4567-e89b-12d3-a456-426614174000"
                conductor_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: UUID of the conductor to assign
                  example: "123e4567-e89b-12d3-a456-426614174001"
                permit_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: UUID of the route permit to assign
                  example: "123e4567-e89b-12d3-a456-426614174002"
              example:
                driver_id: "123e4567-e89b-12d3-a456-426614174000"
                conductor_id: "123e4567-e89b-12d3-a456-426614174001"
                permit_id: "123e4567-e89b-12d3-a456-426614174002"
      responses:
        "200":
          description: Staff and permit assigned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Staff and permit assigned successfully"
                  trip:
                    $ref: "#/components/schemas/ScheduledTrip"
        "400":
          description: |
            Invalid request body, or validation failed:
            - At least one field (driver_id, conductor_id, permit_id) must be provided
            - Trip has no schedule or route link (cannot determine ownership)
            - Staff not found or wrong type
            - Staff not actively employed
            - License expired on trip date
            - Permit status is not "verified" (must be verified, not pending/rejected)
            - Permit is expired on trip date
            - Permit doesn't cover the route
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Driver's license will be expired on trip date"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: |
            Access denied:
            - Only bus owners can assign staff and permits
            - Staff or permit does not belong to your organization
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Driver does not belong to your organization"
        "404":
          description: Trip not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/bulk-publish:
    post:
      summary: Bulk publish scheduled trips for booking
      description: Publish multiple scheduled trips at once by setting is_bookable=true. Only the trip owner can publish their trips.
      operationId: bulkPublishScheduledTrips
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - trip_ids
              properties:
                trip_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: Array of trip IDs to publish
                  example:
                    [
                      "123e4567-e89b-12d3-a456-426614174000",
                      "123e4567-e89b-12d3-a456-426614174001",
                    ]
      responses:
        "200":
          description: Trips published successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Trips published successfully"
                  published_count:
                    type: integer
                    description: Number of trips actually published
                    example: 5
                  requested_count:
                    type: integer
                    description: Number of trip IDs requested
                    example: 5
        "400":
          description: Invalid request body or no trip IDs provided
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Only bus owners can publish trips
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/scheduled-trips/bulk-unpublish:
    post:
      summary: Bulk remove scheduled trips from booking
      description: Remove multiple scheduled trips from booking by setting is_bookable=false. Only the trip owner can unpublish their trips.
      operationId: bulkUnpublishScheduledTrips
      tags:
        - Scheduled Trips
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - trip_ids
              properties:
                trip_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: Array of trip IDs to unpublish
                  example:
                    [
                      "123e4567-e89b-12d3-a456-426614174000",
                      "123e4567-e89b-12d3-a456-426614174001",
                    ]
      responses:
        "200":
          description: Trips unpublished successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Trips unpublished successfully"
                  unpublished_count:
                    type: integer
                    description: Number of trips actually unpublished
                    example: 3
                  requested_count:
                    type: integer
                    description: Number of trip IDs requested
                    example: 3
        "400":
          description: Invalid request body or no trip IDs provided
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Only bus owners can unpublish trips
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bookable-trips:
    get:
      summary: Get bookable trips (Public)
      description: Public endpoint to get available trips for booking by passengers
      operationId: getBookableTrips
      tags:
        - Scheduled Trips
      parameters:
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: origin
          in: query
          schema:
            type: string
        - name: destination
          in: query
          schema:
            type: string
      responses:
        "200":
          description: List of bookable trips
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ScheduledTrip"
        "400":
          description: Invalid parameters
        "500":
          $ref: "#/components/responses/InternalServerError"

# ============================================================================
# Components (Schemas, Responses, SecuritySchemes)
# ============================================================================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token obtained from `/auth/verify-otp` or `/auth/verify-otp-staff`.

        Include in Authorization header as: `Bearer <token>`

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        phone:
          type: string
          example: "+94771234567"
        name:
          type: string
          example: "John Doe"
        email:
          type: string
          format: email
          example: "john.doe@example.com"
        nic:
          type: string
          example: "199512345678"
        address:
          type: string
          example: "123 Main St, Colombo"
        role:
          type: string
          enum: [passenger, driver, conductor]
          example: passenger
        is_verified:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"

    AdminUser:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          example: "admin@smarttransit.com"
        full_name:
          type: string
          example: "System Administrator"
        is_active:
          type: boolean
          example: true
        last_login_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        created_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        created_by:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"

    BusStaff:
      type: object
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 1
        bus_owner_id:
          type: integer
          example: 1
        role:
          type: string
          enum: [driver, conductor]
          example: driver
        license_number:
          type: string
          example: "B1234567"
        employment_status:
          type: string
          enum: [pending, active, inactive, suspended]
          example: active
        profile_completed:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    BusOwner:
      type: object
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 2
        company_name:
          type: string
          example: "Express Transport Ltd"
        nic:
          type: string
          example: "197512345678"
        created_at:
          type: string
          format: date-time

    Lounge:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        lounge_owner_id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440001"
        lounge_name:
          type: string
          example: "City Transit Lounge"
        address:
          type: string
          example: "123 Main Street, Colombo"
        city:
          type: string
          example: "Colombo"
        contact_phone:
          type: string
          example: "+94771234567"
        latitude:
          type: string
          example: "6.9271"
        longitude:
          type: string
          example: "79.8612"
        price_1_hour:
          type: string
          description: "Price for 1 hour in LKR (DECIMAL stored as string)"
          example: "500.00"
        price_2_hours:
          type: string
          description: "Price for 2 hours in LKR (DECIMAL stored as string)"
          example: "900.00"
        price_until_bus:
          type: string
          description: "Price until bus departure in LKR (DECIMAL stored as string)"
          example: "1500.00"
        amenities:
          type: array
          items:
            type: string
          example: ["WiFi", "AC", "Food", "Restrooms", "Charging"]
        images:
          type: array
          items:
            type: string
          example:
            [
              "https://example.com/lounge1.jpg",
              "https://example.com/lounge2.jpg",
            ]
        status:
          type: string
          enum: [pending, active, inactive, suspended]
          example: "active"
        is_operational:
          type: boolean
          example: true
        total_staff:
          type: integer
          example: 3
        average_rating:
          type: string
          example: "4.5"
        total_bookings:
          type: integer
          example: 150
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LoungeStaff:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "770e8400-e29b-41d4-a716-446655440002"
        lounge_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        user_id:
          type: string
          format: uuid
          nullable: true
          example: "880e8400-e29b-41d4-a716-446655440003"
        phone_number:
          type: string
          example: "+94771234567"
        full_name:
          type: string
          example: "John Doe"
        nic_number:
          type: string
          example: "199512345678"
        permission_type:
          type: string
          enum: [admin, staff]
          example: "staff"
          description: "admin = full access, staff = view only"
        employment_status:
          type: string
          enum: [active, inactive, terminated]
          example: "active"
        has_registered:
          type: boolean
          example: false
          description: "True if staff has registered with their phone number"
        invited_at:
          type: string
          format: date-time
        registered_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    StaffProfile:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/User"
        staff:
          $ref: "#/components/schemas/BusStaff"
        bus_owner:
          $ref: "#/components/schemas/BusOwner"

    AuthResponse:
      type: object
      properties:
        message:
          type: string
          example: Login successful
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expires_in:
          type: integer
          description: Access token expiry in seconds
          example: 3600
        user:
          $ref: "#/components/schemas/User"

    StaffAuthResponse:
      type: object
      properties:
        message:
          type: string
          example: Login successful
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expires_in:
          type: integer
          example: 3600
        user:
          $ref: "#/components/schemas/User"
        staff:
          $ref: "#/components/schemas/BusStaff"
        bus_owner:
          $ref: "#/components/schemas/BusOwner"

    Error:
      type: object
      properties:
        error:
          type: string
          example: Invalid request
        details:
          type: string
          example: Phone number is required

    BusOwnerProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        user_id:
          type: string
          format: uuid
        company_name:
          type: string
          example: "ABC Transport Services"
        identity_or_incorporation_no:
          type: string
          example: "PV-2023-1234"
        business_email:
          type: string
          format: email
          example: "info@abctransport.lk"
        profile_completed:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    BusOwnerRoute:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d"
        bus_owner_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        master_route_id:
          type: string
          format: uuid
          example: "b2c3d4e5-f6a7-4b5c-9d0e-1f2a3b4c5d6e"
        custom_route_name:
          type: string
          example: "Colombo Badulla Route for BlueBus"
        direction:
          type: string
          enum: [UP, DOWN]
          example: "UP"
        selected_stop_ids:
          type: array
          items:
            type: string
            format: uuid
          example: ["stop-id-1", "stop-id-2", "stop-id-3"]
        created_at:
          type: string
          format: date-time
          example: "2025-11-05T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-05T10:00:00Z"

    RoutePermit:
      type: object
      properties:
        id:
          type: string
          format: uuid
        bus_owner_id:
          type: string
          format: uuid
        permit_number:
          type: string
          example: "PERMIT-2025-001"
        bus_registration_number:
          type: string
          example: "WP CAB-1234"
        route_number:
          type: string
          example: "138"
        route_name:
          type: string
          example: "Colombo - Kandy Express"
        full_origin_city:
          type: string
          example: "Colombo"
        full_destination_city:
          type: string
          example: "Kandy"
        via:
          type: array
          items:
            type: string
          example: ["Kadawatha", "Kegalle"]
        approved_fare:
          type: number
          format: double
          example: 250.00
        approved_seating_capacity:
          type: integer
          nullable: true
          example: 52
          description: Approved number of seats for this permit (optional)
        issue_date:
          type: string
          format: date
          example: "2025-01-01"
        expiry_date:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [pending, verified, rejected]
          example: "verified"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreatePermitRequest:
      type: object
      required:
        - permit_number
        - bus_registration_number
        - route_number
        - from_city
        - to_city
        - approved_fare
        - validity_from
        - validity_to
      properties:
        permit_number:
          type: string
          example: "PERMIT-2025-001"
        bus_registration_number:
          type: string
          example: "WP CAB-1234"
        route_number:
          type: string
          example: "138"
        from_city:
          type: string
          example: "Colombo"
        to_city:
          type: string
          example: "Kandy"
        via:
          type: string
          example: "Kadawatha, Kegalle"
        approved_fare:
          type: number
          format: double
          example: 250.00
        approved_seating_capacity:
          type: integer
          example: 52
          description: Approved number of seats (optional)
        validity_from:
          type: string
          format: date
          example: "2025-01-01"
        validity_to:
          type: string
          format: date
          example: "2025-12-31"

    UpdatePermitRequest:
      type: object
      properties:
        bus_registration_number:
          type: string
          example: "WP CAB-1234"
        via:
          type: string
          example: "Kadawatha, Kegalle"
        approved_fare:
          type: number
          format: double
          example: 250.00
        approved_seating_capacity:
          type: integer
          example: 52
          description: Approved number of seats (optional)
        validity_to:
          type: string
          format: date
          example: "2025-12-31"

    Bus:
      type: object
      required:
        - id
        - bus_owner_id
        - permit_id
        - bus_number
        - license_plate
        - bus_type
        - total_seats
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          example: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_owner_id:
          type: string
          format: uuid
          example: "b1eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        permit_id:
          type: string
          format: uuid
          example: "c2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_number:
          type: string
          example: "BUS-001"
        license_plate:
          type: string
          example: "WP CAB-1234"
        bus_type:
          type: string
          enum: [normal, luxury, semi_luxury, super_luxury]
          example: "luxury"
        total_seats:
          type: integer
          example: 45
        manufacturing_year:
          type: integer
          example: 2020
        last_maintenance_date:
          type: string
          format: date
          example: "2025-01-15"
        insurance_expiry:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [active, maintenance, inactive]
          example: "active"
        has_wifi:
          type: boolean
          example: true
        has_ac:
          type: boolean
          example: true
        has_charging_ports:
          type: boolean
          example: true
        has_entertainment:
          type: boolean
          example: false
        has_refreshments:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2025-01-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-01-01T10:00:00Z"

    CreateBusRequest:
      type: object
      required:
        - permit_id
        - bus_number
        - bus_type
        - total_seats
      properties:
        permit_id:
          type: string
          format: uuid
          example: "c2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_number:
          type: string
          example: "BUS-001"
        bus_type:
          type: string
          enum: [normal, luxury, semi_luxury, super_luxury]
          example: "luxury"
        total_seats:
          type: integer
          minimum: 1
          example: 45
        manufacturing_year:
          type: integer
          minimum: 1900
          example: 2020
        last_maintenance_date:
          type: string
          format: date
          example: "2025-01-15"
        insurance_expiry:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [active, maintenance, inactive]
          default: active
          example: "active"
        has_wifi:
          type: boolean
          default: false
          example: true
        has_ac:
          type: boolean
          default: false
          example: true
        has_charging_ports:
          type: boolean
          default: false
          example: true
        has_entertainment:
          type: boolean
          default: false
          example: false
        has_refreshments:
          type: boolean
          default: false
          example: true

    UpdateBusRequest:
      type: object
      properties:
        bus_number:
          type: string
          example: "BUS-001"
        bus_type:
          type: string
          enum: [normal, luxury, semi_luxury, super_luxury]
          example: "luxury"
        total_seats:
          type: integer
          minimum: 1
          example: 45
        manufacturing_year:
          type: integer
          minimum: 1900
          example: 2020
        last_maintenance_date:
          type: string
          format: date
          example: "2025-01-15"
        insurance_expiry:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [active, maintenance, inactive]
          example: "maintenance"
        has_wifi:
          type: boolean
          example: true
        has_ac:
          type: boolean
          example: true
        has_charging_ports:
          type: boolean
          example: true
        has_entertainment:
          type: boolean
          example: false
        has_refreshments:
          type: boolean
          example: true

    TripSchedule:
      type: object
      required:
        - id
        - bus_owner_id
        - recurrence_type
        - departure_time
        - base_fare
        - is_active
      properties:
        id:
          type: string
          format: uuid
          example: "d3eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_owner_id:
          type: string
          format: uuid
          example: "a1eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_owner_route_id:
          type: string
          format: uuid
          example: "b2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
          description: "Reference to the custom route (bus_owner_routes table)"
        schedule_name:
          type: string
          example: "Morning Express"
        recurrence_type:
          type: string
          enum: [daily, weekly, interval]
          example: "weekly"
        recurrence_days:
          type: array
          items:
            type: integer
            minimum: 0
            maximum: 6
          example: [1, 2, 3, 4, 5]
          description: "Days of week: 0=Sunday, 6=Saturday (for weekly recurrence)"
        recurrence_interval:
          type: integer
          example: 3
          description: "For interval recurrence: repeat every N days"
        departure_time:
          type: string
          example: "08:00:00"
        estimated_duration_minutes:
          type: integer
          nullable: true
          example: 420
          description: "Calculated trip duration in minutes. For overnight trips, includes time past midnight (e.g., 10 PM to 5 AM = 420 minutes)."
        base_fare:
          type: number
          format: double
          example: 350.00
        is_active:
          type: boolean
          example: true
        valid_from:
          type: string
          format: date
          example: "2025-11-01"
        valid_until:
          type: string
          format: date
          example: "2025-12-31"
        specific_dates:
          type: string
          nullable: true
          example: "2025-11-15,2025-11-20,2025-12-25"
          description: "Comma-separated list of dates in YYYY-MM-DD format (deprecated field, can be NULL). Stored as TEXT in database."
        notes:
          type: string
          example: "Regular weekday service"
        created_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"

    ScheduledTrip:
      type: object
      required:
        - id
        - trip_schedule_id
        - departure_datetime
        - base_fare
        - status
      properties:
        id:
          type: string
          format: uuid
          example: "e4eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        trip_schedule_id:
          type: string
          format: uuid
          example: "d3eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_owner_route_id:
          type: string
          format: uuid
          nullable: true
          example: "a1eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
          description: Optional route override - if NULL, inherits from trip_schedule.bus_owner_route_id
        permit_id:
          type: string
          format: uuid
          nullable: true
          example: "c2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
          description: Optional permit ID (NULL if trip has no permit assigned)
        departure_datetime:
          type: string
          format: date-time
          example: "2025-11-05T08:00:00Z"
          description: "Combined departure date and time for the trip. Use ISO 8601 format (YYYY-MM-DDTHH:MM:SS)."
        actual_arrival_datetime:
          type: string
          format: date-time
          nullable: true
          example: "2025-11-05T10:30:00Z"
          description: "Calculated actual arrival date and time for the trip. For overnight trips, this will be the next day's date (e.g., depart 2025-11-05T22:00:00, arrive 2025-11-06T05:00:00)."
        assigned_driver_id:
          type: string
          format: uuid
          example: "f5eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        assigned_conductor_id:
          type: string
          format: uuid
          example: "g6eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        driver_name:
          type: string
          example: "John Doe"
        conductor_name:
          type: string
          example: "Jane Smith"
        route_number:
          type: string
          nullable: true
          example: "99"
          description: Route number from master_routes (via route_permits join)
        origin_city:
          type: string
          nullable: true
          example: "Badulla"
          description: Origin city from master_routes
        destination_city:
          type: string
          nullable: true
          example: "Colombo"
          description: Destination city from master_routes
        is_up_direction:
          type: boolean
          nullable: true
          example: true
          description: Trip direction - true for up (origindestination), false for down (destinationorigin)
        is_bookable:
          type: boolean
          example: false
          description: Whether this trip is available for passenger booking. Must be explicitly published to make bookable.
        base_fare:
          type: number
          format: double
          example: 350.00
        status:
          type: string
          enum: [scheduled, confirmed, in_progress, completed, cancelled]
          example: "scheduled"
        cancellation_reason:
          type: string
          example: "Driver unavailable"
        cancelled_at:
          type: string
          format: date-time
          example: "2025-11-05T07:00:00Z"
        created_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"

  responses:
    BadRequest:
      description: Bad request - Invalid input
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            invalidPhone:
              value:
                error: Invalid phone number
                details: Phone number must be in E.164 format (+94XXXXXXXXX)
            missingField:
              value:
                error: Missing required field
                details: Field 'phone' is required

    Unauthorized:
      description: Unauthorized - Invalid or expired token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            invalidToken:
              value:
                error: Unauthorized
                details: Invalid or expired token
            missingToken:
              value:
                error: Unauthorized
                details: Authorization header required

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            insufficientPermissions:
              value:
                error: Forbidden
                details: You do not have permission to perform this action
            roleRequired:
              value:
                error: Forbidden
                details: Only bus owners can access this resource

    NotFound:
      description: Not Found - Resource does not exist
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            resourceNotFound:
              value:
                error: Not Found
                details: The requested resource does not exist
            tripNotFound:
              value:
                error: Not Found
                details: Trip not found or access denied

    InvalidOtp:
      description: Invalid OTP
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            invalidOtp:
              value:
                error: Invalid OTP
                details: The OTP you entered is incorrect
            expiredOtp:
              value:
                error: OTP expired
                details: OTP has expired, please request a new one
            maxAttemptsExceeded:
              value:
                error: Maximum attempts exceeded
                details: You have exceeded the maximum number of OTP verification attempts

    Conflict:
      description: Conflict - Resource already exists
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            phoneExists:
              value:
                error: Phone number already registered
                details: This phone number is already in use

    RateLimitExceeded:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            tooManyRequests:
              value:
                error: Rate limit exceeded
                details: Maximum 3 OTP requests per 10 minutes. Please try again later.

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            serverError:
              value:
                error: Internal server error
                details: An unexpected error occurred
