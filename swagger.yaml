openapi: 3.0.3
info:
  title: SmartTransit SMS Authentication API
  description: |
    SMS-based authentication backend for SmartTransit mobile applications.

    ## Features
    - SMS OTP authentication for passengers
    - Staff registration and verification
    - JWT token-based authorization
    - Profile management
    - Rate limiting and security

    ## Authentication Flow
    1. Request OTP via `/auth/send-otp`
    2. Verify OTP via `/auth/verify-otp` or `/auth/verify-otp-staff`
    3. Receive JWT access & refresh tokens
    4. Use access token for protected endpoints
    5. Refresh token when access token expires

  version: 1.0.0
  contact:
    name: SmartTransit Development Team
    email: dev@smarttransit.lk
  license:
    name: Proprietary

servers:
  - url: https://your-choreo-id.choreo.dev
    description: Production server (Choreo)
  - url: http://localhost:8080
    description: Development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: SMS OTP authentication endpoints
  - name: User
    description: User profile management
  - name: Staff
    description: Staff registration and management
  - name: Bus Owner
    description: Bus owner profile and onboarding management
  - name: Lounge Owner
    description: Lounge owner registration and management
  - name: Permits
    description: Route permit management
  - name: Buses
    description: Bus registration and management

paths:
  # ============================================================================
  # Health Check Endpoints
  # ============================================================================
  /health:
    get:
      summary: Health check endpoint
      description: Returns service health status and database connectivity
      operationId: getHealth
      tags:
        - Health
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  database:
                    type: string
                    example: healthy
                  version:
                    type: string
                    example: "1.0.0"
                  timestamp:
                    type: integer
                    format: int64
                    example: 1729340000
        "503":
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: unhealthy
                  database:
                    type: string
                    example: unhealthy
                  error:
                    type: string
                    example: database connection failed

  # ============================================================================
  # Debug Endpoints
  # ============================================================================
  /api/v1/debug/headers:
    get:
      summary: Debug request headers and IP detection
      description: |
        Shows all incoming request headers and IP detection results.

        **Use Case:** Troubleshooting IP forwarding issues with reverse proxies.

        **Returns:**
        - All HTTP headers received
        - IP detection from various headers (X-Real-IP, X-Forwarded-For)
        - User-Agent information
      operationId: debugHeaders
      tags:
        - Health
      responses:
        "200":
          description: Debug information
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Debug information for IP detection
                  headers:
                    type: object
                    additionalProperties:
                      type: string
                    example:
                      X-Forwarded-For: "203.94.123.45, 10.100.1.1"
                      User-Agent: "SmartTransit-Staff/1.0.0+1 (Android 13; Samsung SM-G998B)"
                  ip_detection:
                    type: object
                    properties:
                      gin_clientip:
                        type: string
                        example: "203.94.123.45"
                      remote_addr:
                        type: string
                        example: "10.100.1.1:54321"
                      x_real_ip:
                        type: string
                        example: ""
                      x_forwarded_for:
                        type: string
                        example: "203.94.123.45, 10.100.1.1"
                      x_forwarded_host:
                        type: string
                        example: "api.smarttransit.lk"
                      x_forwarded_proto:
                        type: string
                        example: "https"
                  user_agent:
                    type: string
                    example: "SmartTransit-Staff/1.0.0+1 (Android 13; Samsung SM-G998B)"
                  timestamp:
                    type: integer
                    format: int64
                    example: 1729340000

  # ============================================================================
  # Authentication Endpoints
  # ============================================================================
  /api/v1/auth/send-otp:
    post:
      summary: Send OTP to phone number
      description: |
        Sends a 6-digit OTP via SMS to the provided phone number.

        **Rate Limiting:** Maximum 3 requests per 10 minutes per phone number.

        **Development Mode:** If SMS_MODE=dev, OTP is returned in response.

        **Production Mode:** OTP is sent via Dialog SMS Gateway.
      operationId: sendOtp
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  description: Sri Lankan phone number in E.164 format
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
      responses:
        "200":
          description: OTP sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: OTP sent successfully
                  otp:
                    type: string
                    description: Only present in development mode
                    example: "123456"
                  expires_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T08:05:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/verify-otp:
    post:
      summary: Verify OTP and login (Passenger)
      description: |
        Verifies the OTP for passenger users and returns JWT tokens.

        **Maximum Attempts:** 3 invalid attempts allowed.

        **OTP Expiry:** 5 minutes from generation.

        **Auto-Registration:** If phone number doesn't exist, creates new passenger account.
      operationId: verifyOtp
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - otp
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                otp:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
      responses:
        "200":
          description: OTP verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/verify-otp-staff:
    post:
      summary: Verify OTP and login (Staff)
      description: |
        Verifies the OTP for staff users (drivers/conductors) and returns JWT tokens.

        **Staff Only:** User must be registered as staff (driver or conductor).

        **Employment Status Check:** Staff must have employment_status = 'active'.

        **Profile Completion:** Staff must have completed their profile.
      operationId: verifyOtpStaff
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - otp
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                otp:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
      responses:
        "200":
          description: OTP verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StaffAuthResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "403":
          description: Staff not authorized (inactive or incomplete profile)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Staff member is not active or profile incomplete
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/verify-otp-lounge-owner:
    post:
      summary: Verify OTP and login (Lounge Owner)
      description: |
        Verifies the OTP for lounge owner users and returns JWT tokens.

        **Lounge Owner Specific:** Creates user with 'lounge_owner' role if new, or adds role if existing user.

        **Multi-role Support:** Existing users (passengers) can become lounge owners.
      operationId: verifyOtpLoungeOwner
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone_number
                - otp
              properties:
                phone_number:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                  description: Phone number in E.164 format
                otp:
                  type: string
                  minLength: 6
                  maxLength: 6
                  example: "123456"
                  description: 6-digit OTP code
      responses:
        "200":
          description: OTP verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "OTP verified successfully"
                  access_token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  refresh_token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  expires_in_seconds:
                    type: integer
                    example: 3600
                    description: Access token expiry in seconds
                  is_new_user:
                    type: boolean
                    example: true
                    description: Whether this is a newly created user
                  profile_complete:
                    type: boolean
                    example: false
                    description: Whether user has completed their profile
                  roles:
                    type: array
                    items:
                      type: string
                    example: ["lounge_owner"]
                    description: User's roles including lounge_owner
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "404":
          description: No OTP found for phone number
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "no_otp_found"
                  message:
                    type: string
                    example: "No OTP found for this phone number. Please request an OTP first."
                  code:
                    type: string
                    example: "NO_OTP"
        "429":
          description: Too many OTP validation attempts
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "max_attempts_exceeded"
                  message:
                    type: string
                    example: "Maximum OTP validation attempts exceeded. Please request a new OTP."
                  code:
                    type: string
                    example: "MAX_ATTEMPTS"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/otp-status/{phone}:
    get:
      summary: Get OTP status for phone number
      description: Check if OTP exists and is valid for a phone number
      operationId: getOtpStatus
      tags:
        - Authentication
      security: []
      parameters:
        - name: phone
          in: path
          required: true
          description: Phone number in E.164 format
          schema:
            type: string
            pattern: '^\+94[0-9]{9}$'
            example: "+94771234567"
      responses:
        "200":
          description: OTP status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  exists:
                    type: boolean
                    example: true
                  valid:
                    type: boolean
                    example: true
                  expires_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T08:05:00Z"
                  attempts_remaining:
                    type: integer
                    example: 2
        "404":
          description: No OTP found for phone number
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: No OTP found

  /api/v1/auth/refresh-token:
    post:
      summary: Refresh access token
      description: |
        Use refresh token to obtain a new access token.

        **Token Rotation:** Old refresh token is invalidated, new one is issued.
      operationId: refreshToken
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refresh_token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  expires_in:
                    type: integer
                    description: Access token expiry in seconds
                    example: 3600
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/auth/refresh:
    post:
      summary: Refresh access token (Alias)
      description: Alias endpoint for mobile compatibility
      operationId: refreshTokenAlias
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  expires_in:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/auth/logout:
    post:
      summary: Logout user
      description: Invalidates the current refresh token
      operationId: logout
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logout successful
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ============================================================================
  # User Profile Endpoints
  # ============================================================================
  /api/v1/user/profile:
    get:
      summary: Get user profile
      description: Retrieve the authenticated user's profile information
      operationId: getUserProfile
      tags:
        - User
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update user profile
      description: Update the authenticated user's profile information
      operationId: updateUserProfile
      tags:
        - User
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: John Doe
                email:
                  type: string
                  format: email
                  example: john.doe@example.com
                nic:
                  type: string
                  example: "199512345678"
                address:
                  type: string
                  example: "123 Main St, Colombo"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Profile updated successfully
                  user:
                    $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Staff Endpoints
  # ============================================================================
  /api/v1/staff/check-registration:
    post:
      summary: Check staff registration status
      description: Check if a phone number is registered as staff and get registration details
      operationId: checkStaffRegistration
      tags:
        - Staff
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
      responses:
        "200":
          description: Registration status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_registered:
                    type: boolean
                    example: true
                  staff:
                    $ref: "#/components/schemas/BusStaff"
        "404":
          description: Phone number not registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_registered:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Phone number not registered as staff

  /api/v1/staff/register:
    post:
      summary: Register new staff member
      description: |
        Register a new driver or conductor.

        **Requirements:**
        - Valid phone number (not already registered)
        - Valid bus owner ID
        - Staff role (driver or conductor)
        - Initial employment status will be 'pending'
      operationId: registerStaff
      tags:
        - Staff
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - name
                - role
                - bus_owner_id
              properties:
                phone:
                  type: string
                  pattern: '^\+94[0-9]{9}$'
                  example: "+94771234567"
                name:
                  type: string
                  example: "John Driver"
                nic:
                  type: string
                  example: "199512345678"
                role:
                  type: string
                  enum: [driver, conductor]
                  example: driver
                bus_owner_id:
                  type: integer
                  example: 1
                license_number:
                  type: string
                  description: Required for drivers
                  example: "B1234567"
      responses:
        "201":
          description: Staff registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Staff registered successfully
                  staff:
                    $ref: "#/components/schemas/BusStaff"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/bus-owners/search:
    get:
      summary: Search bus owners
      description: Search for bus owners by name or NIC
      operationId: searchBusOwners
      tags:
        - Staff
      security: []
      parameters:
        - name: query
          in: query
          required: true
          description: Search query (name or NIC)
          schema:
            type: string
            example: "Perera"
        - name: limit
          in: query
          required: false
          description: Maximum number of results
          schema:
            type: integer
            default: 10
            example: 10
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  bus_owners:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusOwner"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/staff/profile:
    get:
      summary: Get staff profile
      description: Retrieve the authenticated staff member's profile
      operationId: getStaffProfile
      tags:
        - Staff
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Staff profile retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StaffProfile"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update staff profile
      description: Update the authenticated staff member's profile
      operationId: updateStaffProfile
      tags:
        - Staff
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "John Driver"
                nic:
                  type: string
                  example: "199512345678"
                license_number:
                  type: string
                  example: "B1234567"
                address:
                  type: string
                  example: "123 Main St, Colombo"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Profile updated successfully
                  staff:
                    $ref: "#/components/schemas/BusStaff"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Bus Owner Endpoints
  # ============================================================================
  /api/v1/bus-owner/profile:
    get:
      summary: Get bus owner profile
      description: Retrieve the authenticated bus owner's profile
      operationId: getBusOwnerProfile
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusOwnerProfile"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/profile-status:
    get:
      summary: Check bus owner profile completion status
      description: Check if the bus owner has completed onboarding
      operationId: checkBusOwnerProfileStatus
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Status retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  profile_completed:
                    type: boolean
                    example: false
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/complete-onboarding:
    post:
      summary: Complete bus owner onboarding
      description: Submit company information and route permits to complete onboarding
      operationId: completeBusOwnerOnboarding
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - company_name
                - identity_or_incorporation_no
                - permits
              properties:
                company_name:
                  type: string
                  example: "ABC Transport Services"
                identity_or_incorporation_no:
                  type: string
                  example: "PV-2023-1234"
                business_email:
                  type: string
                  format: email
                  example: "info@abctransport.lk"
                permits:
                  type: array
                  items:
                    type: object
                    required:
                      - permit_number
                      - bus_registration_number
                      - route_number
                      - from_city
                      - to_city
                      - approved_fare
                      - validity_from
                      - validity_to
                    properties:
                      permit_number:
                        type: string
                        example: "PERMIT-2025-001"
                      bus_registration_number:
                        type: string
                        example: "WP CAB-1234"
                      route_number:
                        type: string
                        example: "138"
                      from_city:
                        type: string
                        example: "Colombo"
                      to_city:
                        type: string
                        example: "Kandy"
                      via:
                        type: string
                        example: "Kadawatha, Kegalle"
                      approved_fare:
                        type: number
                        example: 250.00
                      validity_from:
                        type: string
                        format: date
                        example: "2025-01-01"
                      validity_to:
                        type: string
                        format: date
                        example: "2025-12-31"
      responses:
        "200":
          description: Onboarding completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Onboarding completed successfully
                  profile_completed:
                    type: boolean
                    example: true
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/bus-owner/staff:
    get:
      summary: Get all staff members (drivers and conductors)
      description: |
        Retrieves all drivers and conductors for the authenticated bus owner.
        Returns enriched staff data including user information (name, phone).
      operationId: getStaffMembers
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Staff list retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  staff:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                          example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                        user_id:
                          type: string
                          format: uuid
                          example: "3edeb9af-51c3-4c24-a5d0-76c9dee2d4ea"
                        first_name:
                          type: string
                          example: "Kamal"
                        last_name:
                          type: string
                          example: "Perera"
                        phone:
                          type: string
                          example: "+94712345678"
                        staff_type:
                          type: string
                          enum: [driver, conductor]
                          example: "driver"
                        license_number:
                          type: string
                          example: "NTC1234567"
                        license_expiry_date:
                          type: string
                          format: date-time
                          example: "2026-12-31T00:00:00Z"
                        experience_years:
                          type: integer
                          example: 5
                        employment_status:
                          type: string
                          enum: [active, inactive, suspended, terminated]
                          example: "active"
                        background_check_status:
                          type: string
                          enum: [pending, in_progress, cleared, failed]
                          example: "pending"
                        performance_rating:
                          type: number
                          format: double
                          example: 4.5
                        total_trips_completed:
                          type: integer
                          example: 150
                  total:
                    type: integer
                    example: 2
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Bus owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Bus owner profile not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Add driver or conductor to organization
      description: |
        Allows bus owner to add a driver or conductor directly to their organization.
        NTC license number and expiry date are mandatory for both drivers and conductors.
        If the phone number doesn't exist, a new user account will be created.
        Staff members are pre-approved (employment_status = 'active') and can immediately login via driver/conductor app.
      operationId: addStaffMember
      tags:
        - Bus Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone_number
                - first_name
                - last_name
                - staff_type
                - ntc_license_number
                - license_expiry_date
              properties:
                phone_number:
                  type: string
                  description: Staff member's phone number (will be used for login)
                  example: "+94712345678"
                first_name:
                  type: string
                  description: Staff member's first name
                  example: "Kamal"
                last_name:
                  type: string
                  description: Staff member's last name
                  example: "Perera"
                staff_type:
                  type: string
                  enum: [driver, conductor]
                  description: Type of staff member
                  example: "driver"
                ntc_license_number:
                  type: string
                  description: NTC (National Transport Commission) license number - MANDATORY
                  example: "NTC1234567"
                license_expiry_date:
                  type: string
                  format: date
                  description: NTC license expiry date (YYYY-MM-DD) - MANDATORY, must be in future
                  example: "2026-12-31"
                experience_years:
                  type: integer
                  description: Years of driving/conducting experience (optional)
                  example: 5
                emergency_contact:
                  type: string
                  description: Emergency contact phone number (optional)
                  example: "+94777654321"
                emergency_contact_name:
                  type: string
                  description: Emergency contact person name (optional)
                  example: "Nimal Perera"
      responses:
        "201":
          description: Staff member added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "driver added successfully"
                  user_id:
                    type: string
                    format: uuid
                    example: "123e4567-e89b-12d3-a456-426614174000"
                  staff_id:
                    type: string
                    format: uuid
                    example: "987e6543-e21b-98d3-a654-426614174999"
                  staff_type:
                    type: string
                    example: "driver"
                  instructions:
                    type: string
                    example: "Staff member can now login using phone number +94712345678"
        "400":
          description: Bad request - validation failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "NTC license has already expired"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Bus owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Bus owner profile not found. Please complete onboarding first."
        "409":
          description: Conflict - staff already registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "This phone number is already registered as driver"
                  staff_type:
                    type: string
                    example: "driver"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Lounge Owner Endpoints
  # ============================================================================
  /api/v1/lounge-owner/register/personal-info:
    post:
      summary: Save lounge owner personal information
      description: |
        First step of lounge owner registration - save personal information.
        Requires authenticated user with 'lounge_owner' role.
      operationId: saveLoungeOwnerPersonalInfo
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - full_name
                - nic_number
                - business_email
              properties:
                full_name:
                  type: string
                  minLength: 3
                  maxLength: 100
                  example: "John Doe"
                  description: Full legal name
                nic_number:
                  type: string
                  pattern: '^[0-9]{9}[VXvx]$|^[0-9]{12}$'
                  example: "200012345678"
                  description: National Identity Card number (old format 9 digits + V/X or new format 12 digits)
                business_email:
                  type: string
                  format: email
                  example: "john@example.com"
                  description: Business email address
      responses:
        "200":
          description: Personal information saved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Personal information saved successfully"
                  registration_status:
                    type: string
                    example: "personal_info_saved"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/register/upload-nic:
    post:
      summary: Upload NIC front and back images
      description: |
        Second step of lounge owner registration - upload NIC images for verification.
        Supports OCR extraction of data from NIC images.
      operationId: uploadLoungeOwnerNIC
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - nic_front_url
                - nic_back_url
              properties:
                nic_front_url:
                  type: string
                  format: uri
                  example: "https://storage.supabase.co/path/to/nic_front.jpg"
                  description: URL to NIC front image (upload to Supabase Storage first)
                nic_back_url:
                  type: string
                  format: uri
                  example: "https://storage.supabase.co/path/to/nic_back.jpg"
                  description: URL to NIC back image (upload to Supabase Storage first)
      responses:
        "200":
          description: NIC images uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "NIC images uploaded successfully"
                  registration_status:
                    type: string
                    example: "nic_uploaded"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/register/add-lounge:
    post:
      summary: Add lounge information
      description: |
        Third step of lounge owner registration - add lounge location and details.
        Can be called multiple times to add multiple lounges.
      operationId: addLounge
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lounge_name
                - address
                - city
                - latitude
                - longitude
              properties:
                lounge_name:
                  type: string
                  minLength: 3
                  maxLength: 100
                  example: "City Central Lounge"
                  description: Name of the lounge
                address:
                  type: string
                  minLength: 10
                  maxLength: 255
                  example: "123 Main St, Colombo"
                  description: Full address of the lounge
                city:
                  type: string
                  example: "Colombo"
                  description: City where lounge is located
                latitude:
                  type: number
                  format: double
                  example: 6.9271
                  description: GPS latitude coordinate
                longitude:
                  type: number
                  format: double
                  example: 79.8612
                  description: GPS longitude coordinate
                contact_phone:
                  type: string
                  example: "+94112345678"
                  description: Contact phone number for the lounge
                amenities:
                  type: array
                  items:
                    type: string
                  example: ["wifi", "charging_stations", "cafe"]
                  description: List of amenities available
      responses:
        "201":
          description: Lounge added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Lounge added successfully"
                  lounge_id:
                    type: string
                    format: uuid
                    example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                  registration_status:
                    type: string
                    example: "completed"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/registration/progress:
    get:
      summary: Get registration progress
      description: |
        Get current registration status and what steps have been completed.
      operationId: getLoungeOwnerRegistrationProgress
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Registration progress retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  registration_status:
                    type: string
                    enum: ["pending", "personal_info_saved", "nic_uploaded", "completed"]
                    example: "personal_info_saved"
                  personal_info_completed:
                    type: boolean
                    example: true
                  nic_uploaded:
                    type: boolean
                    example: false
                  lounges_added:
                    type: integer
                    example: 0
                  next_step:
                    type: string
                    example: "upload_nic"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Lounge owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Lounge owner profile not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/profile:
    get:
      summary: Get lounge owner profile
      description: |
        Retrieve complete lounge owner profile including personal information and registration status.
      operationId: getLoungeOwnerProfile
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                    example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                  user_id:
                    type: string
                    format: uuid
                    example: "3edeb9af-51c3-4c24-a5d0-76c9dee2d4ea"
                  full_name:
                    type: string
                    example: "John Doe"
                  nic_number:
                    type: string
                    example: "200012345678"
                  business_email:
                    type: string
                    example: "john@example.com"
                  phone:
                    type: string
                    example: "+94771234567"
                  registration_status:
                    type: string
                    enum: ["pending", "personal_info_saved", "nic_uploaded", "completed"]
                    example: "completed"
                  nic_front_url:
                    type: string
                    format: uri
                    example: "https://storage.supabase.co/path/to/nic_front.jpg"
                  nic_back_url:
                    type: string
                    format: uri
                    example: "https://storage.supabase.co/path/to/nic_back.jpg"
                  created_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T10:30:00Z"
                  updated_at:
                    type: string
                    format: date-time
                    example: "2025-10-19T11:00:00Z"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Lounge owner profile not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Lounge owner profile not found"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/lounge-owner/lounges:
    get:
      summary: Get all lounges owned by this owner
      description: |
        Retrieve all lounges associated with the authenticated lounge owner.
      operationId: getMyLounges
      tags:
        - Lounge Owner
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Lounges retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  lounges:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                          example: "d581c281-ba77-49d2-8f68-5f7377417bf8"
                        lounge_name:
                          type: string
                          example: "City Central Lounge"
                        address:
                          type: string
                          example: "123 Main St, Colombo"
                        city:
                          type: string
                          example: "Colombo"
                        latitude:
                          type: number
                          format: double
                          example: 6.9271
                        longitude:
                          type: number
                          format: double
                          example: 79.8612
                        contact_phone:
                          type: string
                          example: "+94112345678"
                        amenities:
                          type: array
                          items:
                            type: string
                          example: ["wifi", "charging_stations", "cafe"]
                        status:
                          type: string
                          enum: ["active", "inactive", "pending_approval"]
                          example: "active"
                        created_at:
                          type: string
                          format: date-time
                          example: "2025-10-19T10:30:00Z"
                  total:
                    type: integer
                    example: 2
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Permit Endpoints
  # ============================================================================
  /api/v1/permits:
    get:
      summary: Get all permits
      description: Retrieve all route permits for authenticated bus owner
      operationId: getAllPermits
      tags:
        - Permits
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Permits retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  permits:
                    type: array
                    items:
                      $ref: "#/components/schemas/RoutePermit"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Create new permit
      description: Create a new route permit
      operationId: createPermit
      tags:
        - Permits
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePermitRequest"
      responses:
        "201":
          description: Permit created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Permit created successfully
                  permit:
                    $ref: "#/components/schemas/RoutePermit"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/permits/valid:
    get:
      summary: Get valid permits
      description: Retrieve only valid (non-expired) route permits
      operationId: getValidPermits
      tags:
        - Permits
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Valid permits retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  permits:
                    type: array
                    items:
                      $ref: "#/components/schemas/RoutePermit"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/permits/{id}:
    get:
      summary: Get permit by ID
      description: Retrieve a specific route permit by ID
      operationId: getPermitById
      tags:
        - Permits
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Permit retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoutePermit"
        "404":
          description: Permit not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update permit
      description: Update an existing route permit
      operationId: updatePermit
      tags:
        - Permits
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePermitRequest"
      responses:
        "200":
          description: Permit updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Permit updated successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Permit not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete permit
      description: Delete a route permit
      operationId: deletePermit
      tags:
        - Permits
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Permit deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Permit deleted successfully
        "404":
          description: Permit not found
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # ============================================================================
  # Bus Endpoints
  # ============================================================================
  /api/v1/buses:
    get:
      summary: Get all buses
      description: Retrieve all buses owned by the authenticated bus owner
      operationId: getAllBuses
      tags:
        - Buses
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of buses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bus"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      summary: Create new bus
      description: Register a new bus under a route permit
      operationId: createBus
      tags:
        - Buses
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBusRequest"
      responses:
        "201":
          description: Bus created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "400":
          description: Invalid request or validation error
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Permit not found
        "409":
          description: Bus already registered under this permit
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/buses/{id}:
    get:
      summary: Get bus by ID
      description: Retrieve a specific bus by ID
      operationId: getBusById
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Bus details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Permission denied (bus belongs to another owner)
        "404":
          description: Bus not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      summary: Update bus
      description: Update bus information
      operationId: updateBus
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateBusRequest"
      responses:
        "200":
          description: Bus updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "400":
          description: Invalid request
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Permission denied
        "404":
          description: Bus not found
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete bus
      description: Delete a bus
      operationId: deleteBus
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Bus deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Bus deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Bus not found or permission denied
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/buses/status/{status}:
    get:
      summary: Get buses by status
      description: Retrieve buses filtered by operational status
      operationId: getBusesByStatus
      tags:
        - Buses
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: path
          required: true
          schema:
            type: string
            enum: [active, maintenance, inactive]
      responses:
        "200":
          description: List of buses with specified status
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bus"
        "400":
          description: Invalid status parameter
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

# ============================================================================
# Components (Schemas, Responses, SecuritySchemes)
# ============================================================================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token obtained from `/auth/verify-otp` or `/auth/verify-otp-staff`.

        Include in Authorization header as: `Bearer <token>`

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        phone:
          type: string
          example: "+94771234567"
        name:
          type: string
          example: "John Doe"
        email:
          type: string
          format: email
          example: "john.doe@example.com"
        nic:
          type: string
          example: "199512345678"
        address:
          type: string
          example: "123 Main St, Colombo"
        role:
          type: string
          enum: [passenger, driver, conductor]
          example: passenger
        is_verified:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-10-19T07:00:00Z"

    BusStaff:
      type: object
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 1
        bus_owner_id:
          type: integer
          example: 1
        role:
          type: string
          enum: [driver, conductor]
          example: driver
        license_number:
          type: string
          example: "B1234567"
        employment_status:
          type: string
          enum: [pending, active, inactive, suspended]
          example: active
        profile_completed:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    BusOwner:
      type: object
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 2
        company_name:
          type: string
          example: "Express Transport Ltd"
        nic:
          type: string
          example: "197512345678"
        created_at:
          type: string
          format: date-time

    StaffProfile:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/User"
        staff:
          $ref: "#/components/schemas/BusStaff"
        bus_owner:
          $ref: "#/components/schemas/BusOwner"

    AuthResponse:
      type: object
      properties:
        message:
          type: string
          example: Login successful
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expires_in:
          type: integer
          description: Access token expiry in seconds
          example: 3600
        user:
          $ref: "#/components/schemas/User"

    StaffAuthResponse:
      type: object
      properties:
        message:
          type: string
          example: Login successful
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expires_in:
          type: integer
          example: 3600
        user:
          $ref: "#/components/schemas/User"
        staff:
          $ref: "#/components/schemas/BusStaff"
        bus_owner:
          $ref: "#/components/schemas/BusOwner"

    Error:
      type: object
      properties:
        error:
          type: string
          example: Invalid request
        details:
          type: string
          example: Phone number is required

    BusOwnerProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        user_id:
          type: string
          format: uuid
        company_name:
          type: string
          example: "ABC Transport Services"
        identity_or_incorporation_no:
          type: string
          example: "PV-2023-1234"
        business_email:
          type: string
          format: email
          example: "info@abctransport.lk"
        profile_completed:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    RoutePermit:
      type: object
      properties:
        id:
          type: string
          format: uuid
        bus_owner_id:
          type: string
          format: uuid
        permit_number:
          type: string
          example: "PERMIT-2025-001"
        bus_registration_number:
          type: string
          example: "WP CAB-1234"
        route_number:
          type: string
          example: "138"
        route_name:
          type: string
          example: "Colombo - Kandy Express"
        full_origin_city:
          type: string
          example: "Colombo"
        full_destination_city:
          type: string
          example: "Kandy"
        via:
          type: array
          items:
            type: string
          example: ["Kadawatha", "Kegalle"]
        approved_fare:
          type: number
          format: double
          example: 250.00
        issue_date:
          type: string
          format: date
          example: "2025-01-01"
        expiry_date:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [pending, verified, rejected]
          example: "verified"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreatePermitRequest:
      type: object
      required:
        - permit_number
        - bus_registration_number
        - route_number
        - from_city
        - to_city
        - approved_fare
        - validity_from
        - validity_to
      properties:
        permit_number:
          type: string
          example: "PERMIT-2025-001"
        bus_registration_number:
          type: string
          example: "WP CAB-1234"
        route_number:
          type: string
          example: "138"
        from_city:
          type: string
          example: "Colombo"
        to_city:
          type: string
          example: "Kandy"
        via:
          type: string
          example: "Kadawatha, Kegalle"
        approved_fare:
          type: number
          format: double
          example: 250.00
        validity_from:
          type: string
          format: date
          example: "2025-01-01"
        validity_to:
          type: string
          format: date
          example: "2025-12-31"

    UpdatePermitRequest:
      type: object
      properties:
        bus_registration_number:
          type: string
          example: "WP CAB-1234"
        via:
          type: string
          example: "Kadawatha, Kegalle"
        approved_fare:
          type: number
          format: double
          example: 250.00
        validity_to:
          type: string
          format: date
          example: "2025-12-31"

    Bus:
      type: object
      required:
        - id
        - bus_owner_id
        - permit_id
        - bus_number
        - license_plate
        - bus_type
        - total_seats
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          example: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_owner_id:
          type: string
          format: uuid
          example: "b1eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        permit_id:
          type: string
          format: uuid
          example: "c2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_number:
          type: string
          example: "BUS-001"
        license_plate:
          type: string
          example: "WP CAB-1234"
        bus_type:
          type: string
          enum: [normal, luxury, semi_luxury, super_luxury]
          example: "luxury"
        total_seats:
          type: integer
          example: 45
        manufacturing_year:
          type: integer
          example: 2020
        last_maintenance_date:
          type: string
          format: date
          example: "2025-01-15"
        insurance_expiry:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [active, maintenance, inactive]
          example: "active"
        has_wifi:
          type: boolean
          example: true
        has_ac:
          type: boolean
          example: true
        has_charging_ports:
          type: boolean
          example: true
        has_entertainment:
          type: boolean
          example: false
        has_refreshments:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2025-01-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-01-01T10:00:00Z"

    CreateBusRequest:
      type: object
      required:
        - permit_id
        - bus_number
        - bus_type
        - total_seats
      properties:
        permit_id:
          type: string
          format: uuid
          example: "c2eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"
        bus_number:
          type: string
          example: "BUS-001"
        bus_type:
          type: string
          enum: [normal, luxury, semi_luxury, super_luxury]
          example: "luxury"
        total_seats:
          type: integer
          minimum: 1
          example: 45
        manufacturing_year:
          type: integer
          minimum: 1900
          example: 2020
        last_maintenance_date:
          type: string
          format: date
          example: "2025-01-15"
        insurance_expiry:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [active, maintenance, inactive]
          default: active
          example: "active"
        has_wifi:
          type: boolean
          default: false
          example: true
        has_ac:
          type: boolean
          default: false
          example: true
        has_charging_ports:
          type: boolean
          default: false
          example: true
        has_entertainment:
          type: boolean
          default: false
          example: false
        has_refreshments:
          type: boolean
          default: false
          example: true

    UpdateBusRequest:
      type: object
      properties:
        bus_number:
          type: string
          example: "BUS-001"
        bus_type:
          type: string
          enum: [normal, luxury, semi_luxury, super_luxury]
          example: "luxury"
        total_seats:
          type: integer
          minimum: 1
          example: 45
        manufacturing_year:
          type: integer
          minimum: 1900
          example: 2020
        last_maintenance_date:
          type: string
          format: date
          example: "2025-01-15"
        insurance_expiry:
          type: string
          format: date
          example: "2025-12-31"
        status:
          type: string
          enum: [active, maintenance, inactive]
          example: "maintenance"
        has_wifi:
          type: boolean
          example: true
        has_ac:
          type: boolean
          example: true
        has_charging_ports:
          type: boolean
          example: true
        has_entertainment:
          type: boolean
          example: false
        has_refreshments:
          type: boolean
          example: true

  responses:
    BadRequest:
      description: Bad request - Invalid input
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            invalidPhone:
              value:
                error: Invalid phone number
                details: Phone number must be in E.164 format (+94XXXXXXXXX)
            missingField:
              value:
                error: Missing required field
                details: Field 'phone' is required

    Unauthorized:
      description: Unauthorized - Invalid or expired token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            invalidToken:
              value:
                error: Unauthorized
                details: Invalid or expired token
            missingToken:
              value:
                error: Unauthorized
                details: Authorization header required

    InvalidOtp:
      description: Invalid OTP
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            invalidOtp:
              value:
                error: Invalid OTP
                details: The OTP you entered is incorrect
            expiredOtp:
              value:
                error: OTP expired
                details: OTP has expired, please request a new one
            maxAttemptsExceeded:
              value:
                error: Maximum attempts exceeded
                details: You have exceeded the maximum number of OTP verification attempts

    Conflict:
      description: Conflict - Resource already exists
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            phoneExists:
              value:
                error: Phone number already registered
                details: This phone number is already in use

    RateLimitExceeded:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            tooManyRequests:
              value:
                error: Rate limit exceeded
                details: Maximum 3 OTP requests per 10 minutes. Please try again later.

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            serverError:
              value:
                error: Internal server error
                details: An unexpected error occurred
